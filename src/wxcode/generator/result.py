"""Generation result tracking for FastAPI+Jinja2 generators."""

from dataclasses import dataclass, field
from pathlib import Path


@dataclass
class GenerationResult:
    """Accumulates results from multiple generators.

    Tracks files generated, errors encountered, and warnings.
    Used by orchestrator to collect results from all generators.
    """

    files_generated: list[Path] = field(default_factory=list)
    errors: list[str] = field(default_factory=list)
    warnings: list[str] = field(default_factory=list)

    # Per-generator tracking
    _by_generator: dict[str, list[Path]] = field(default_factory=dict)

    @property
    def total_files(self) -> int:
        """Total number of files generated."""
        return len(self.files_generated)

    @property
    def has_errors(self) -> bool:
        """True if any errors occurred."""
        return len(self.errors) > 0

    @property
    def success(self) -> bool:
        """True if generation completed without errors."""
        return not self.has_errors

    def add_success(self, generator_name: str, files: list[Path]) -> None:
        """Record successful generation from a generator.

        Args:
            generator_name: Name of the generator (e.g., 'SchemaGenerator')
            files: List of files generated by this generator
        """
        self.files_generated.extend(files)
        self._by_generator[generator_name] = files

    def add_error(self, generator_name: str, error: str) -> None:
        """Record an error from a generator.

        Args:
            generator_name: Name of the generator that failed
            error: Error message
        """
        self.errors.append(f"[{generator_name}] {error}")

    def add_warning(self, generator_name: str, warning: str) -> None:
        """Record a warning from a generator.

        Args:
            generator_name: Name of the generator
            warning: Warning message
        """
        self.warnings.append(f"[{generator_name}] {warning}")

    def get_files_by_generator(self, generator_name: str) -> list[Path]:
        """Get files generated by a specific generator.

        Args:
            generator_name: Name of the generator

        Returns:
            List of files generated by that generator
        """
        return self._by_generator.get(generator_name, [])

    def summary(self) -> str:
        """Generate a summary of the generation result.

        Returns:
            Human-readable summary string
        """
        lines = [
            f"Generation {'completed' if self.success else 'failed'}",
            f"  Total files: {self.total_files}",
        ]

        if self._by_generator:
            lines.append("  By generator:")
            for gen_name, files in self._by_generator.items():
                lines.append(f"    {gen_name}: {len(files)} files")

        if self.warnings:
            lines.append(f"  Warnings: {len(self.warnings)}")

        if self.errors:
            lines.append(f"  Errors: {len(self.errors)}")
            for error in self.errors:
                lines.append(f"    - {error}")

        return "\n".join(lines)
