# Design: fix-page-converter

## Current Architecture

```
StarterKit generates:
├── app/
│   ├── routes/           ← StarterKit creates this
│   │   └── __init__.py   ← Commented template, overwritten each run
│   ├── routers/          ← OutputWriter creates this
│   │   └── __init__.py   ← Updated with router includes
│   └── main.py           ← Imports from app.routes (!)
```

**Problem**: main.py imports `from app.routes` but routers are in `app.routers`.

## Proposed Architecture

```
StarterKit generates:
├── app/
│   ├── routers/          ← Single location for all routers
│   │   ├── __init__.py   ← Preserved between runs, auto-updated
│   │   ├── auth.py       ← Default auth router
│   │   ├── login.py      ← Generated by PageConverter
│   │   └── principal.py  ← Generated by PageConverter
│   ├── services/
│   │   └── auth.py       ← Default auth service with get_current_user
│   ├── core/
│   │   └── security.py   ← Default security utilities
│   └── main.py           ← Imports from app.routers
```

## Component Changes

### 1. StarterKit Changes

```python
# BEFORE: starter_kit.py
def _generate_init_files(self):
    # app/routes/__init__.py
    routes_init = '''"""Page routes package."""
    ...
    '''
    self._write_file("app/routes/__init__.py", routes_init)

# AFTER: starter_kit.py
def _generate_init_files(self):
    # app/routers/__init__.py - preserve existing if has content
    routers_path = self.output_dir / "app" / "routers" / "__init__.py"

    if routers_path.exists():
        content = routers_path.read_text()
        # Only overwrite if file is empty or has only comments
        if self._has_active_imports(content):
            return  # Preserve existing

    routers_init = '''"""Routers package."""

from fastapi import APIRouter

router = APIRouter()
'''
    self._write_file("app/routers/__init__.py", routers_init)
```

### 2. main.py Template Change

```python
# BEFORE
from app.routes import router as pages_router

# AFTER
from app.routers import router as pages_router
```

### 3. ImportValidator (New Component)

```python
class ImportValidator:
    """Valida e corrige imports no código gerado."""

    def __init__(self, output_dir: Path):
        self.output_dir = output_dir
        self.available_modules = self._scan_modules()

    def validate_and_fix(self, code: str) -> tuple[str, list[str]]:
        """
        Valida imports e remove os inexistentes.

        Returns:
            (código_corrigido, lista_de_imports_removidos)
        """
        tree = ast.parse(code)
        imports_to_remove = []

        for node in ast.walk(tree):
            if isinstance(node, ast.ImportFrom):
                module = node.module
                if module and module.startswith("app."):
                    if not self._module_exists(module):
                        imports_to_remove.append(module)

        fixed_code = self._remove_imports(code, imports_to_remove)
        return fixed_code, imports_to_remove
```

### 4. Default Auth Dependencies

O StarterKit deve gerar automaticamente:

**app/services/auth.py**:
```python
"""Authentication service."""

from fastapi import Request, HTTPException
from typing import Optional

class CurrentUser:
    def __init__(self, id: int, username: str):
        self.id = id
        self.username = username

async def get_current_user(request: Request) -> Optional[CurrentUser]:
    """Get current user from session/cookie."""
    token = request.cookies.get("access_token")
    if not token:
        return CurrentUser(id=1, username="guest")
    # TODO: Validate JWT
    return CurrentUser(id=1, username="authenticated")
```

**app/core/security.py**:
```python
"""Security utilities."""

from datetime import datetime, timedelta
from jose import jwt
from app.config import settings

def create_access_token(data: dict, expires_delta: timedelta = None) -> str:
    """Create JWT access token."""
    to_encode = data.copy()
    expire = datetime.utcnow() + (expires_delta or timedelta(hours=24))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, settings.secret_key, algorithm="HS256")
```

## Flow Diagram

```
convert --layer route
    │
    ▼
┌─────────────────────────────────────────────────┐
│ 1. StarterKit.generate()                        │
│    - Check if routers/__init__.py has imports   │
│    - If yes: SKIP (preserve existing)           │
│    - If no: generate empty template             │
│    - Generate auth.py, security.py defaults     │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│ 2. PageConverter.convert()                      │
│    - Build context                              │
│    - Call LLM                                   │
│    - Parse response                             │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│ 3. ImportValidator.validate_and_fix()           │
│    - Parse generated code                       │
│    - Check each import exists                   │
│    - Remove invalid imports                     │
│    - Log warnings                               │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│ 4. OutputWriter.write()                         │
│    - Write router file                          │
│    - Write template                             │
│    - Update routers/__init__.py                 │
│    - Generate stubs for missing deps            │
└─────────────────────────────────────────────────┘
```

## Trade-offs

| Decision | Pros | Cons |
|----------|------|------|
| Unificar em `routers/` | Consistência, menos confusão | Pode quebrar projetos antigos |
| Preservar __init__.py | Não perde trabalho | Pode acumular imports obsoletos |
| ImportValidator | Código funcional garantido | Pode remover imports válidos que ainda não existem |
| Gerar auth padrão | Menos erros iniciais | Código pode não ser usado |

## Risks

1. **Projetos existentes**: Podem ter `app/routes/` - mitigação: manter compatibilidade temporária
2. **ImportValidator false positives**: Pode remover imports de módulos que serão criados depois - mitigação: só validar imports de `app.`
