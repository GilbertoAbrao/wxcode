---
phase: 30-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/components/layout/WorkspaceLayout.tsx
  - frontend/src/app/project/[id]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar collapses automatically when user navigates to Output Project detail page"
    - "User can manually expand sidebar while on Output Project page"
    - "Sidebar collapse state does not affect other pages in the project"
  artifacts:
    - path: "frontend/src/components/layout/Sidebar.tsx"
      provides: "Controlled collapse props (collapsed, onCollapsedChange)"
      exports: ["Sidebar", "SidebarProps"]
    - path: "frontend/src/components/layout/WorkspaceLayout.tsx"
      provides: "Sidebar collapse passthrough and route detection"
      exports: ["WorkspaceLayout", "WorkspaceLayoutProps"]
    - path: "frontend/src/app/project/[id]/layout.tsx"
      provides: "Route-based sidebar auto-collapse for Output Project pages"
  key_links:
    - from: "frontend/src/app/project/[id]/layout.tsx"
      to: "WorkspaceLayout"
      via: "sidebarCollapsed and onSidebarCollapsedChange props"
      pattern: "sidebarCollapsed=.*isOutputProjectPage"
    - from: "frontend/src/components/layout/WorkspaceLayout.tsx"
      to: "Sidebar"
      via: "collapsed and onCollapsedChange props"
      pattern: "collapsed=\\{sidebarCollapsed\\}"
---

<objective>
Add controlled collapse support to Sidebar component and wire route-based auto-collapse for Output Project pages.

Purpose: Maximize terminal space on Output Project pages (UI-02) by collapsing sidebar automatically when users navigate to Output Project detail pages, while preserving manual expand capability.
Output: Sidebar with external collapse control, WorkspaceLayout with collapse passthrough, project layout with route detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-ui-polish/30-RESEARCH.md

# Existing components to modify
@frontend/src/components/layout/Sidebar.tsx
@frontend/src/components/layout/WorkspaceLayout.tsx
@frontend/src/app/project/[id]/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add controlled collapse props to Sidebar</name>
  <files>frontend/src/components/layout/Sidebar.tsx</files>
  <action>
    Extend SidebarProps interface with optional controlled props:
    - collapsed?: boolean (external control when provided)
    - onCollapsedChange?: (collapsed: boolean) => void (callback for state changes)

    Modify Sidebar component logic:
    1. Detect controlled mode: `const isControlled = collapsed !== undefined;`
    2. Use controlled state if provided: `const isCollapsed = isControlled ? collapsed : internalCollapsed;`
    3. Update toggleCollapsed to call onCollapsedChange when controlled:
       ```typescript
       const toggleCollapsed = useCallback(() => {
         if (isControlled) {
           onCollapsedChange?.(!collapsed);
         } else {
           setInternalCollapsed((prev) => !prev);
         }
       }, [isControlled, collapsed, onCollapsedChange]);
       ```

    IMPORTANT: Keep internal state for uncontrolled usage (backwards compatible).
  </action>
  <verify>
    TypeScript compiles: `cd frontend && npm run type-check`
    Sidebar still works in uncontrolled mode (no breaking changes to existing usages).
  </verify>
  <done>
    Sidebar accepts optional collapsed/onCollapsedChange props.
    When collapsed prop is provided, component operates in controlled mode.
    When collapsed prop is undefined, component uses internal state (default behavior).
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass collapse props through WorkspaceLayout</name>
  <files>frontend/src/components/layout/WorkspaceLayout.tsx</files>
  <action>
    Extend WorkspaceLayoutProps interface:
    - sidebarCollapsed?: boolean
    - onSidebarCollapsedChange?: (collapsed: boolean) => void

    Pass these props to Sidebar component:
    ```typescript
    <Sidebar
      sections={sidebarSections}
      footer={sidebarFooter}
      collapsed={sidebarCollapsed}
      onCollapsedChange={onSidebarCollapsedChange}
    />
    ```

    IMPORTANT: Props are optional - if not provided, Sidebar uses internal state.
  </action>
  <verify>
    TypeScript compiles: `cd frontend && npm run type-check`
    Existing WorkspaceLayout usages still work (all new props are optional).
  </verify>
  <done>
    WorkspaceLayout accepts sidebarCollapsed and onSidebarCollapsedChange props.
    Props are passed through to Sidebar component.
    Backwards compatible - no changes required for existing usages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add route-based auto-collapse in project layout</name>
  <files>frontend/src/app/project/[id]/layout.tsx</files>
  <action>
    Add route detection and controlled sidebar state:

    1. Import usePathname: `import { usePathname, useRouter } from "next/navigation";`

    2. Add route detection:
       ```typescript
       const pathname = usePathname();
       // Detect Output Project detail pages (not the list page)
       const isOutputProjectDetailPage = pathname.includes("/output-projects/") &&
         pathname.split("/output-projects/")[1]?.length > 0;
       ```

    3. Add sidebar state with initial value based on route:
       ```typescript
       const [sidebarCollapsed, setSidebarCollapsed] = useState(isOutputProjectDetailPage);
       ```

    4. Add effect to auto-collapse when navigating TO Output Project detail page:
       ```typescript
       useEffect(() => {
         if (isOutputProjectDetailPage) {
           setSidebarCollapsed(true);
         }
       }, [isOutputProjectDetailPage]);
       ```
       NOTE: Only auto-collapse, never auto-expand (let user control expansion).

    5. Pass controlled props to WorkspaceLayout:
       ```typescript
       <WorkspaceLayout
         breadcrumbs={breadcrumbs}
         sidebarSections={sidebarSections}
         sidebarFooter={...}
         headerActions={...}
         sidebarCollapsed={sidebarCollapsed}
         onSidebarCollapsedChange={setSidebarCollapsed}
       >
       ```
  </action>
  <verify>
    TypeScript compiles: `cd frontend && npm run type-check`
    Manual test: Navigate to Output Project detail page, sidebar should be collapsed.
    Manual test: Click expand button, sidebar expands and stays expanded.
  </verify>
  <done>
    Sidebar automatically collapses when navigating to Output Project detail page.
    User can manually expand sidebar (persists while on that page).
    Navigation to other project pages does not auto-collapse.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd frontend && npm run type-check`
2. Navigate to /project/[id]/output-projects/[projectId] - sidebar should be collapsed
3. Click sidebar expand button - sidebar should expand and stay expanded
4. Navigate to /project/[id] (workspace) - sidebar state is independent
5. Navigate back to Output Project - sidebar auto-collapses again
</verification>

<success_criteria>
- Sidebar has controlled collapse API (collapsed, onCollapsedChange)
- WorkspaceLayout passes through collapse props
- Project layout detects Output Project routes and auto-collapses sidebar
- User can override auto-collapse by clicking expand button
- No breaking changes to existing pages
</success_criteria>

<output>
After completion, create `.planning/phases/30-ui-polish/30-01-SUMMARY.md`
</output>
