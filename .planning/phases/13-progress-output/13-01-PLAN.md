---
phase: 13-progress-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/api/workspace.py
  - src/wxcode/services/state_parser.py
  - src/wxcode/api/products.py
  - src/wxcode/main.py
autonomous: true

must_haves:
  truths:
    - "API returns list of files in product workspace"
    - "API returns file content for specific file"
    - "API returns parsed STATE.md progress data"
    - "Path traversal outside workspace is blocked"
  artifacts:
    - path: "src/wxcode/api/workspace.py"
      provides: "Workspace file listing and reading endpoints"
      exports: ["router", "FileNode", "FileContent"]
    - path: "src/wxcode/services/state_parser.py"
      provides: "STATE.md parsing utility"
      exports: ["GSDProgress", "parse_state_md"]
  key_links:
    - from: "src/wxcode/api/products.py"
      to: "src/wxcode/services/state_parser.py"
      via: "import and call parse_state_md"
      pattern: "from wxcode.services.state_parser import"
    - from: "src/wxcode/main.py"
      to: "src/wxcode/api/workspace.py"
      via: "router registration"
      pattern: "include_router.*workspace"
---

<objective>
Create workspace files API and STATE.md progress endpoint.

Purpose: Enable frontend to read workspace files (STATE.md, generated code) via REST API, and provide parsed progress data for dashboard display.
Output: Workspace API router with file listing/reading endpoints, STATE.md parser, and /progress endpoint on products API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-progress-output/13-RESEARCH.md

@src/wxcode/api/products.py
@src/wxcode/main.py
@src/wxcode/models/product.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STATE.md parser service</name>
  <files>src/wxcode/services/state_parser.py</files>
  <action>
Create state_parser.py with:

1. GSDProgress dataclass:
   - current_phase: int
   - total_phases: int
   - phase_name: str
   - plan_status: str
   - status: str
   - last_activity: str
   - progress_percent: int
   - progress_bar: str

2. parse_state_md(content: str) -> GSDProgress | None function:
   - Parse "Phase: X of Y (Name)" pattern
   - Parse "Progress: blocks XX%" pattern
   - Parse "Plan: ..." line
   - Parse "Status: ..." line
   - Parse "Last activity: ..." line
   - Return None if Phase line not found (graceful handling)

Use regex patterns from research. Handle STATE.md not existing gracefully.

Docstrings in Portuguese.
  </action>
  <verify>
    python -c "from wxcode.services.state_parser import GSDProgress, parse_state_md; print('OK')"
  </verify>
  <done>parse_state_md parses valid STATE.md content into GSDProgress, returns None for invalid content</done>
</task>

<task type="auto">
  <name>Task 2: Create workspace files API</name>
  <files>src/wxcode/api/workspace.py</files>
  <action>
Create workspace.py API router with:

1. Pydantic models:
   - FileNode(name, path, is_directory, size, children)
   - FileContent(path, content, size, mime_type)

2. Helper functions:
   - _list_directory(target: Path, workspace: Path) -> list[FileNode]
     - Recursively list files and directories
     - Return relative paths to workspace
   - _get_mime_type(file_path: Path) -> str
     - Map extensions to MIME types (.py -> text/x-python, .ts -> text/typescript, etc.)
     - Default to text/plain for unknown

3. Endpoints:
   - GET /products/{product_id}/files?path=
     - List files in product workspace
     - path param is relative path within workspace (default: root)
     - SECURITY: validate path is within workspace using resolve().is_relative_to()
     - Return list[FileNode]
   - GET /products/{product_id}/files/content?path=
     - Read content of specific file
     - SECURITY: same path validation
     - SIZE LIMIT: reject files > 1MB with 413
     - Return FileContent

4. Router prefix: will be mounted at /api/workspace

Docstrings in Portuguese.
  </action>
  <verify>
    python -c "from wxcode.api.workspace import router, FileNode, FileContent; print('OK')"
  </verify>
  <done>Workspace API endpoints exist and can list/read files within workspace boundaries</done>
</task>

<task type="auto">
  <name>Task 3: Add /progress endpoint and register workspace router</name>
  <files>src/wxcode/api/products.py, src/wxcode/main.py</files>
  <action>
1. In products.py, add endpoint:

```python
@router.get("/{product_id}/progress")
async def get_product_progress(product_id: str) -> dict | None:
    """
    Retorna progresso do GSD workflow lendo STATE.md do workspace.

    Returns None se STATE.md nao existir ainda.
    """
    # Get product
    # Get workspace path
    # Read .planning/STATE.md from workspace/conversion/
    # Parse with parse_state_md
    # Return parsed data or None
```

2. In main.py:
   - Import workspace router: `from wxcode.api import workspace`
   - Register: `app.include_router(workspace.router, prefix="/api/workspace", tags=["Workspace"])`

Docstrings in Portuguese.
  </action>
  <verify>
    cd /Users/gilberto/projetos/wxk/wxcode && python -c "from wxcode.main import app; print([r.path for r in app.routes if 'workspace' in str(r.path) or 'progress' in str(r.path)])"
  </verify>
  <done>/api/products/{product_id}/progress endpoint returns parsed STATE.md, workspace router registered at /api/workspace</done>
</task>

</tasks>

<verification>
```bash
# Run Python import checks
cd /Users/gilberto/projetos/wxk/wxcode
python -c "
from wxcode.services.state_parser import GSDProgress, parse_state_md
from wxcode.api.workspace import router as workspace_router, FileNode, FileContent
from wxcode.main import app

# Test parse_state_md with sample content
sample = '''
# Project State

## Current Position

Phase: 2 of 4 (Sidebar & Navigation)
Plan: 01 of 2
Status: In progress
Last activity: 2026-01-22 - Completed plan 01

Progress: [████░░░░░░] 40%
'''
result = parse_state_md(sample)
assert result is not None
assert result.current_phase == 2
assert result.total_phases == 4
assert result.phase_name == 'Sidebar & Navigation'
print('STATE.md parser: OK')

# Check routes registered
routes = [r.path for r in app.routes]
assert '/api/workspace/products/{product_id}/files' in routes
assert '/api/products/{product_id}/progress' in routes
print('Routes registered: OK')

print('All verification passed')
"
```
</verification>

<success_criteria>
- [ ] GSDProgress dataclass with all fields
- [ ] parse_state_md handles valid and invalid content
- [ ] Workspace API lists files with recursive directory support
- [ ] Workspace API reads file content with size limit
- [ ] Path traversal attacks blocked (403 response)
- [ ] /progress endpoint returns parsed STATE.md data
- [ ] Workspace router registered in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/13-progress-output/13-01-SUMMARY.md`
</output>
