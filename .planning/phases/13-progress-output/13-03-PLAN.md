---
phase: 13-progress-output
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/hooks/useWorkspaceFiles.ts
  - frontend/src/components/conversion/ProgressDashboard.tsx
  - frontend/src/components/conversion/OutputViewer.tsx
  - frontend/src/components/conversion/index.ts
  - frontend/src/app/project/[id]/products/[productId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees phase progress with percentage and phase name"
    - "User can browse generated files in tree structure"
    - "User can view file content when clicking a file"
    - "Dashboard handles missing STATE.md gracefully"
  artifacts:
    - path: "frontend/src/hooks/useWorkspaceFiles.ts"
      provides: "Hooks for workspace file listing and content"
      exports: ["useWorkspaceFiles", "useFileContent", "useInvalidateWorkspaceFiles"]
    - path: "frontend/src/components/conversion/ProgressDashboard.tsx"
      provides: "STATE.md progress visualization"
      exports: ["ProgressDashboard"]
    - path: "frontend/src/components/conversion/OutputViewer.tsx"
      provides: "File tree and code viewer"
      exports: ["OutputViewer"]
  key_links:
    - from: "frontend/src/components/conversion/ProgressDashboard.tsx"
      to: "/api/products/{id}/progress"
      via: "fetch in useQuery"
      pattern: "fetch.*products.*progress"
    - from: "frontend/src/components/conversion/OutputViewer.tsx"
      to: "/api/workspace/products/{id}/files"
      via: "useWorkspaceFiles hook"
      pattern: "useWorkspaceFiles"
---

<objective>
Create frontend progress dashboard and output viewer components.

Purpose: Enable users to see conversion progress from STATE.md and browse/view generated code files.
Output: ProgressDashboard component showing phase/progress, OutputViewer with file tree and code viewer, integrated into product dashboard page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-progress-output/13-RESEARCH.md
@.planning/phases/13-progress-output/13-01-SUMMARY.md

@frontend/src/hooks/useConversionStream.ts
@frontend/src/components/conversion/ConversionProgress.tsx
@frontend/src/components/conversion/index.ts
@frontend/src/app/project/[id]/products/[productId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useWorkspaceFiles hooks</name>
  <files>frontend/src/hooks/useWorkspaceFiles.ts</files>
  <action>
Create useWorkspaceFiles.ts with TanStack Query hooks:

```typescript
"use client";

import { useQuery, useQueryClient } from "@tanstack/react-query";

interface FileNode {
  name: string;
  path: string;
  is_directory: boolean;
  size: number | null;
  children?: FileNode[];
}

interface FileContent {
  path: string;
  content: string;
  size: number;
  mime_type: string;
}

export function useWorkspaceFiles(productId: string, subPath: string = "") {
  return useQuery<FileNode[]>({
    queryKey: ["workspace-files", productId, subPath],
    queryFn: async () => {
      const params = subPath ? `?path=${encodeURIComponent(subPath)}` : "";
      const res = await fetch(`/api/workspace/products/${productId}/files${params}`);
      if (!res.ok) {
        if (res.status === 404) return [];
        throw new Error("Failed to fetch files");
      }
      return res.json();
    },
    enabled: !!productId,
  });
}

export function useFileContent(productId: string, filePath: string | null) {
  return useQuery<FileContent>({
    queryKey: ["file-content", productId, filePath],
    queryFn: async () => {
      const res = await fetch(
        `/api/workspace/products/${productId}/files/content?path=${encodeURIComponent(filePath!)}`
      );
      if (!res.ok) throw new Error("Failed to fetch content");
      return res.json();
    },
    enabled: !!productId && !!filePath,
  });
}

export function useInvalidateWorkspaceFiles() {
  const queryClient = useQueryClient();

  return {
    invalidate: (productId: string) => {
      queryClient.invalidateQueries({
        queryKey: ["workspace-files", productId],
        exact: false,
      });
    },
  };
}

export type { FileNode, FileContent };
```
  </action>
  <verify>File exists and exports the hooks</verify>
  <done>useWorkspaceFiles, useFileContent, and useInvalidateWorkspaceFiles hooks created</done>
</task>

<task type="auto">
  <name>Task 2: Create ProgressDashboard and OutputViewer components</name>
  <files>frontend/src/components/conversion/ProgressDashboard.tsx, frontend/src/components/conversion/OutputViewer.tsx</files>
  <action>
1. Create ProgressDashboard.tsx:
   - Fetch progress from /api/products/{productId}/progress using useQuery
   - Poll every 3 seconds (refetchInterval: 3000)
   - Display:
     - Phase header: "Fase X/Y" with phase_name
     - Progress bar with animated width transition
     - Status text and percentage
     - Plan status
     - Last activity timestamp
   - Handle null response (STATE.md not found) with "Aguardando inicio..." message
   - Use framer-motion for entry animation
   - Tailwind styling matching existing zinc color scheme

2. Create OutputViewer.tsx:
   - Two-panel layout: file tree (left, w-64) + code viewer (right, flex-1)
   - File tree:
     - Use useWorkspaceFiles hook with subPath="conversion"
     - Expandable directories with ChevronRight icon
     - File icons based on extension (Code for .py/.ts, FileText for .md, File for others)
     - Click file to select and show content
   - Code viewer:
     - Use useFileContent hook
     - Show file path in header
     - Monospace font for content
     - "Selecione um arquivo" placeholder when no file selected
   - Handle loading states
   - Use lucide-react icons (ChevronRight, File, Folder, Code, FileText)

Both components:
- "use client" directive
- cn() from @/lib/utils for className merging
- Accept className prop for customization
- Match existing component styling (zinc-900/50 backgrounds, zinc-800 borders)
  </action>
  <verify>
    ls frontend/src/components/conversion/ProgressDashboard.tsx frontend/src/components/conversion/OutputViewer.tsx
  </verify>
  <done>ProgressDashboard shows phase progress, OutputViewer shows file tree and code content</done>
</task>

<task type="auto">
  <name>Task 3: Update exports and integrate into product page</name>
  <files>frontend/src/components/conversion/index.ts, frontend/src/app/project/[id]/products/[productId]/page.tsx</files>
  <action>
1. In index.ts, add exports:
   ```typescript
   export { ProgressDashboard } from "./ProgressDashboard";
   export { OutputViewer } from "./OutputViewer";
   ```

2. In page.tsx:
   - Import ProgressDashboard and OutputViewer from @/components/conversion
   - Add ProgressDashboard below the header, before checkpoint UI:
     ```tsx
     {/* Progress Dashboard */}
     <div className="mb-6">
       <ProgressDashboard productId={productId} />
     </div>
     ```
   - Add OutputViewer after ConversionProgress section:
     ```tsx
     {/* Output Viewer (show when completed or has output) */}
     {(product.status === "completed" || product.status === "paused") && (
       <div className="mb-6">
         <h2 className="text-lg font-semibold text-zinc-100 mb-3">
           Arquivos Gerados
         </h2>
         <OutputViewer productId={productId} className="h-96" />
       </div>
     )}
     ```
   - Import useInvalidateWorkspaceFiles and invalidate files on checkpoint/complete:
     ```tsx
     const { invalidate: invalidateFiles } = useInvalidateWorkspaceFiles();
     // In onCheckpoint and onComplete callbacks:
     invalidateFiles(productId);
     ```
  </action>
  <verify>
    grep -l "ProgressDashboard\|OutputViewer" frontend/src/app/project/[id]/products/[productId]/page.tsx frontend/src/components/conversion/index.ts
  </verify>
  <done>Components exported and integrated into product dashboard page</done>
</task>

</tasks>

<verification>
```bash
# Check files exist
ls -la frontend/src/hooks/useWorkspaceFiles.ts
ls -la frontend/src/components/conversion/ProgressDashboard.tsx
ls -la frontend/src/components/conversion/OutputViewer.tsx

# Check exports
grep "ProgressDashboard\|OutputViewer" frontend/src/components/conversion/index.ts

# Check integration
grep "ProgressDashboard\|OutputViewer" frontend/src/app/project/[id]/products/[productId]/page.tsx

# TypeScript check
cd /Users/gilberto/projetos/wxk/wxcode/frontend && npm run lint -- --max-warnings=0 2>/dev/null || echo "Lint check (may have warnings)"
```
</verification>

<success_criteria>
- [ ] useWorkspaceFiles.ts exports hooks for file listing and content
- [ ] ProgressDashboard shows phase progress with polling
- [ ] ProgressDashboard handles missing STATE.md gracefully
- [ ] OutputViewer shows file tree and code content
- [ ] Components exported from conversion/index.ts
- [ ] Product page shows ProgressDashboard
- [ ] Product page shows OutputViewer when completed/paused
- [ ] File list invalidated on checkpoint/complete events
</success_criteria>

<output>
After completion, create `.planning/phases/13-progress-output/13-03-SUMMARY.md`
</output>
