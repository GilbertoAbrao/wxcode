---
phase: 13-progress-output
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/models/conversion_history.py
  - src/wxcode/models/__init__.py
  - src/wxcode/database.py
  - src/wxcode/api/products.py
autonomous: true

must_haves:
  truths:
    - "ConversionHistory entries are created when conversions complete"
    - "History can be queried by project_id"
    - "History includes element names, status, timing, and file count"
  artifacts:
    - path: "src/wxcode/models/conversion_history.py"
      provides: "ConversionHistoryEntry Beanie document"
      exports: ["ConversionHistoryEntry"]
  key_links:
    - from: "src/wxcode/database.py"
      to: "src/wxcode/models/conversion_history.py"
      via: "document registration"
      pattern: "ConversionHistoryEntry"
    - from: "src/wxcode/api/products.py"
      to: "src/wxcode/models/conversion_history.py"
      via: "create and query history"
      pattern: "ConversionHistoryEntry"
---

<objective>
Create ConversionHistory model and API endpoints for tracking conversion history.

Purpose: Enable tracking and displaying past conversions per project, providing audit trail and enabling history viewing in UI.
Output: ConversionHistoryEntry model registered with Beanie, history creation on conversion completion, history query endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-progress-output/13-RESEARCH.md

@src/wxcode/models/product.py
@src/wxcode/models/__init__.py
@src/wxcode/database.py
@src/wxcode/api/products.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConversionHistoryEntry model</name>
  <files>src/wxcode/models/conversion_history.py</files>
  <action>
Create conversion_history.py with ConversionHistoryEntry Beanie Document:

```python
"""
Model de historico de conversoes.

Registra cada conversao completada (sucesso ou falha) para auditoria.
"""

from datetime import datetime
from typing import Optional

from beanie import Document, PydanticObjectId
from pydantic import Field

from wxcode.models.product import ProductStatus


class ConversionHistoryEntry(Document):
    """
    Entrada de historico de conversao.

    Criada quando uma conversao termina (sucesso ou falha).
    Fornece trilha de auditoria e habilita visualizacao de historico.
    """

    # IDs (stored as ObjectId, not Link to avoid circular import)
    project_id: PydanticObjectId = Field(..., description="Projeto da conversao")
    product_id: PydanticObjectId = Field(..., description="Produto convertido")

    # Detalhes da conversao
    element_names: list[str] = Field(..., description="Elementos convertidos")
    status: ProductStatus = Field(..., description="Status final (completed/failed)")

    # Timing
    started_at: datetime = Field(..., description="Inicio da conversao")
    completed_at: datetime = Field(default_factory=datetime.utcnow, description="Fim da conversao")
    duration_seconds: float = Field(..., description="Duracao total em segundos")

    # Output info
    output_path: Optional[str] = Field(None, description="Caminho do output gerado")
    files_generated: int = Field(default=0, description="Numero de arquivos gerados")

    # Error info (if failed)
    error_message: Optional[str] = Field(None, description="Mensagem de erro se falhou")

    class Settings:
        name = "conversion_history"
        indexes = [
            "project_id",
            "product_id",
            [("project_id", 1), ("completed_at", -1)],  # For sorted history query
        ]
```

Docstrings in Portuguese.
  </action>
  <verify>
    python -c "from wxcode.models.conversion_history import ConversionHistoryEntry; print('OK')"
  </verify>
  <done>ConversionHistoryEntry model created with all required fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Register model in database and exports</name>
  <files>src/wxcode/models/__init__.py, src/wxcode/database.py</files>
  <action>
1. In models/__init__.py:
   - Add import: `from wxcode.models.conversion_history import ConversionHistoryEntry`
   - Add to __all__: `"ConversionHistoryEntry"`

2. In database.py:
   - Add import: `from wxcode.models.conversion_history import ConversionHistoryEntry`
   - Add to document_models list in init_beanie call

Follow existing patterns in both files.
  </action>
  <verify>
    python -c "
from wxcode.models import ConversionHistoryEntry
from wxcode.database import init_db
print('Model registered: OK')
"
  </verify>
  <done>ConversionHistoryEntry exported from models and registered with Beanie</done>
</task>

<task type="auto">
  <name>Task 3: Add history endpoints and creation hook</name>
  <files>src/wxcode/api/products.py</files>
  <action>
Add to products.py:

1. GET /history endpoint (at router level, not per-product):
```python
@router.get("/history")
async def get_conversion_history(
    project_id: str,
    limit: int = 20,
) -> list[dict]:
    """
    Retorna historico de conversoes de um projeto.

    Args:
        project_id: ID do projeto (obrigatorio)
        limit: Maximo de entradas a retornar
    """
    from wxcode.models.conversion_history import ConversionHistoryEntry

    try:
        project_oid = PydanticObjectId(project_id)
    except Exception:
        raise HTTPException(400, "ID de projeto invalido")

    entries = await ConversionHistoryEntry.find(
        {"project_id": project_oid}
    ).sort("-completed_at").limit(limit).to_list()

    return [
        {
            "id": str(e.id),
            "product_id": str(e.product_id),
            "element_names": e.element_names,
            "status": e.status.value,
            "started_at": e.started_at.isoformat(),
            "completed_at": e.completed_at.isoformat(),
            "duration_seconds": e.duration_seconds,
            "files_generated": e.files_generated,
            "error_message": e.error_message,
        }
        for e in entries
    ]
```

2. Helper function to create history entry:
```python
async def create_history_entry(
    product: Product,
    element_names: list[str],
    status: ProductStatus,
    started_at: datetime,
    error_message: Optional[str] = None,
) -> None:
    """Cria entrada de historico para conversao completada."""
    from wxcode.models.conversion_history import ConversionHistoryEntry
    from pathlib import Path

    # Count generated files in output directory
    files_generated = 0
    if product.output_directory:
        output_path = Path(product.output_directory)
        if output_path.exists():
            files_generated = sum(1 for _ in output_path.rglob("*") if _.is_file())

    # Extract project_id from Link
    project_id = product.project_id.ref.id if hasattr(product.project_id, 'ref') else product.project_id

    entry = ConversionHistoryEntry(
        project_id=project_id,
        product_id=product.id,
        element_names=element_names,
        status=status,
        started_at=started_at,
        completed_at=datetime.utcnow(),
        duration_seconds=(datetime.utcnow() - started_at).total_seconds(),
        output_path=product.output_directory,
        files_generated=files_generated,
        error_message=error_message,
    )
    await entry.insert()
```

3. Update the WebSocket handler to call create_history_entry when conversion completes.
   In the websocket_product_stream function, after conversion completes (both success and failure),
   call create_history_entry. Store element_names and started_at at the start of conversion.

Note: The WebSocket handler is complex. Add the history creation in the "start" action handler
after run_product_conversion_with_streaming completes, and in "resume" after completion.
Store element_names in a variable when "start" action is received.

Docstrings in Portuguese.
  </action>
  <verify>
    python -c "
from wxcode.api.products import router, create_history_entry
# Check history endpoint exists
routes = [r.path for r in router.routes]
assert '/history' in routes or any('history' in str(r.path) for r in router.routes)
print('History endpoint: OK')
"
  </verify>
  <done>History query endpoint works, history entries created on conversion completion</done>
</task>

</tasks>

<verification>
```bash
cd /Users/gilberto/projetos/wxk/wxcode
python -c "
from wxcode.models import ConversionHistoryEntry
from wxcode.models.product import ProductStatus
from beanie import PydanticObjectId

# Verify model structure
entry = ConversionHistoryEntry(
    project_id=PydanticObjectId(),
    product_id=PydanticObjectId(),
    element_names=['PAGE_Login'],
    status=ProductStatus.COMPLETED,
    started_at='2026-01-22T10:00:00',
    duration_seconds=120.5,
)
print(f'Model valid: {entry.element_names}')

# Check API import
from wxcode.api.products import router
routes = [r.path for r in router.routes]
print(f'Routes: {routes}')

print('All verification passed')
"
```
</verification>

<success_criteria>
- [ ] ConversionHistoryEntry model with all required fields
- [ ] Model registered in database.py document_models
- [ ] Model exported from models/__init__.py
- [ ] GET /history endpoint returns sorted history by project_id
- [ ] create_history_entry helper function exists
- [ ] History entries created on conversion completion (start and resume flows)
</success_criteria>

<output>
After completion, create `.planning/phases/13-progress-output/13-02-SUMMARY.md`
</output>
