---
phase: 09-import-flow-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/models/project.py
  - src/wxcode/models/import_session.py
  - src/wxcode/api/import_wizard.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Project model has workspace_id and workspace_path fields"
    - "ImportSession model tracks workspace_id, workspace_path, and project_name"
    - "create_session endpoint creates workspace BEFORE creating session"
    - "Multiple imports of same project create separate workspaces"
  artifacts:
    - path: "src/wxcode/models/project.py"
      provides: "Project model with workspace fields"
      contains: "workspace_id: Optional[str]"
    - path: "src/wxcode/models/import_session.py"
      provides: "ImportSession with workspace tracking"
      contains: "workspace_id: Optional[str]"
    - path: "src/wxcode/api/import_wizard.py"
      provides: "create_session with WorkspaceManager integration"
      contains: "WorkspaceManager.create_workspace"
  key_links:
    - from: "src/wxcode/api/import_wizard.py"
      to: "WorkspaceManager.create_workspace"
      via: "import and call in create_session"
      pattern: "from wxcode.services.workspace_manager import WorkspaceManager"
    - from: "src/wxcode/api/import_wizard.py"
      to: "ImportSession"
      via: "pass workspace_id and workspace_path to constructor"
      pattern: "workspace_id=metadata.workspace_id"
---

<objective>
Update backend models and API to create workspace during import session creation

Purpose: Enable isolated workspaces for each project import by integrating WorkspaceManager into the import flow. This ensures each import gets its own workspace directory before any processing begins.

Output: Updated Project and ImportSession models with workspace fields, and create_session endpoint that creates workspace first.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workspace-infrastructure/08-01-SUMMARY.md
@.planning/phases/09-import-flow-update/09-RESEARCH.md

@src/wxcode/models/project.py
@src/wxcode/models/import_session.py
@src/wxcode/api/import_wizard.py
@src/wxcode/services/workspace_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace fields to Project model</name>
  <files>src/wxcode/models/project.py</files>
  <action>
Add two new Optional fields to the Project model:

1. `workspace_id: Optional[str]` - The 8-char hex ID from WorkspaceManager
2. `workspace_path: Optional[str]` - Full path to workspace directory

Place them after `source_path` in the Identificacao section. Both are Optional because existing projects won't have them (backwards compatibility).

Also add a `display_name` field to store the original project name before workspace_id suffix is added:
- `display_name: Optional[str]` - Original project name for UI display

The `name` field will become `{original_name}_{workspace_id}` for uniqueness (per research recommendation Option A).

Add Field descriptions in Portuguese.
  </action>
  <verify>
Run `python -c "from wxcode.models.project import Project; p = Project(name='test', source_path='/tmp/test.wwp'); print(p.workspace_id, p.workspace_path, p.display_name)"` - should print "None None None"
  </verify>
  <done>Project model has workspace_id, workspace_path, and display_name Optional fields</done>
</task>

<task type="auto">
  <name>Task 2: Add workspace tracking to ImportSession model</name>
  <files>src/wxcode/models/import_session.py</files>
  <action>
Add three new fields to ImportSession model after `project_id`:

1. `workspace_id: Optional[str] = None` - Workspace ID for this import
2. `workspace_path: Optional[str] = None` - Full workspace path
3. `project_name: Optional[str] = None` - Original project name (extracted from .wwp path)

These fields allow the session to track workspace info that will be passed to CLI commands. The `project_name` field also fixes the latent bug noted in research where WebSocket handler references `session.project_name` but the field doesn't exist.
  </action>
  <verify>
Run `python -c "from wxcode.models.import_session import ImportSession; s = ImportSession(project_path='/tmp/test.wwp'); print(s.workspace_id, s.workspace_path, s.project_name)"` - should print "None None None"
  </verify>
  <done>ImportSession model has workspace_id, workspace_path, and project_name fields</done>
</task>

<task type="auto">
  <name>Task 3: Integrate WorkspaceManager into create_session endpoint</name>
  <files>src/wxcode/api/import_wizard.py</files>
  <action>
Modify the `create_session` endpoint to create workspace BEFORE creating ImportSession:

1. Add import at top: `from wxcode.services.workspace_manager import WorkspaceManager`

2. In `create_session` function, BEFORE creating ImportSession:
   ```python
   # Extract project name from .wwp path
   project_name = Path(project_path).stem

   # Create workspace FIRST
   workspace_path, metadata = WorkspaceManager.create_workspace(
       project_name=project_name,
       imported_from=project_path
   )
   ```

3. Pass workspace info to ImportSession constructor:
   ```python
   session = ImportSession(
       project_path=project_path,
       pdf_docs_path=pdf_docs_path,
       workspace_id=metadata.workspace_id,
       workspace_path=str(workspace_path),
       project_name=project_name,
   )
   ```

4. Add workspace info to CreateSessionResponse. Update the response model:
   ```python
   class CreateSessionResponse(BaseModel):
       session_id: str
       workspace_id: str
       workspace_path: str
   ```

5. Return the new fields:
   ```python
   return CreateSessionResponse(
       session_id=session.session_id,
       workspace_id=metadata.workspace_id,
       workspace_path=str(workspace_path),
   )
   ```

This ensures workspace is created at session creation time, before any CLI commands run. If workspace creation fails, the endpoint returns an error before creating the session.
  </action>
  <verify>
1. Start the server and test with curl:
```bash
# First upload a project file, then:
curl -X POST "http://localhost:8000/api/import-wizard/sessions" \
  -F "project_path=/path/to/extracted/project.wwp" \
  | jq '.workspace_id, .workspace_path'
```
Should return workspace_id (8 hex chars) and workspace_path (~/.wxcode/workspaces/...)

2. Verify CreateSessionResponse model includes workspace fields:
```bash
grep -n 'workspace_id.*workspace_path\|class CreateSessionResponse' src/wxcode/api/import_wizard.py
```
Should show CreateSessionResponse class with both workspace_id and workspace_path fields.
  </verify>
  <done>create_session creates workspace directory before creating ImportSession, returns workspace info in response</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Model fields exist:
   - `python -c "from wxcode.models import Project, ImportSession; print('workspace_id' in Project.model_fields, 'workspace_id' in ImportSession.model_fields)"` returns "True True"

2. WorkspaceManager integration works:
   - `grep -n "WorkspaceManager" src/wxcode/api/import_wizard.py` shows import and usage

3. Response model updated:
   - `grep -n "workspace_id" src/wxcode/api/import_wizard.py` shows field in CreateSessionResponse
</verification>

<success_criteria>
- Project model has workspace_id, workspace_path, display_name fields (all Optional)
- ImportSession model has workspace_id, workspace_path, project_name fields
- create_session endpoint calls WorkspaceManager.create_workspace() before creating session
- CreateSessionResponse includes workspace_id and workspace_path
- Existing functionality not broken (fields are Optional for backwards compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/09-import-flow-update/09-01-SUMMARY.md`
</output>
