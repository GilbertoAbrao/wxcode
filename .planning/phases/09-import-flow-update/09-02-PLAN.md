---
phase: 09-import-flow-update
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/wxcode/cli.py
  - src/wxcode/services/step_executor.py
  - src/wxcode/parser/project_mapper.py
  - src/wxcode/api/import_wizard_ws.py
  - frontend/src/types/project.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CLI import command accepts --workspace-id and --workspace-path options"
    - "StepExecutor passes workspace options to CLI import command"
    - "ProjectMapper creates Project with workspace fields populated"
    - "Upload temp files are cleaned after import completes, fails, or is cancelled"
    - "Frontend Project type includes workspace fields"
  artifacts:
    - path: "src/wxcode/cli.py"
      provides: "CLI import with workspace options"
      contains: "--workspace-id"
    - path: "src/wxcode/services/step_executor.py"
      provides: "StepExecutor passing workspace to CLI"
      contains: "workspace_id"
    - path: "src/wxcode/parser/project_mapper.py"
      provides: "ProjectMapper with workspace support"
      contains: "workspace_id"
    - path: "src/wxcode/api/import_wizard_ws.py"
      provides: "WebSocket handler with cleanup"
      contains: "cleanup_upload_files"
    - path: "frontend/src/types/project.ts"
      provides: "Project interface with workspace fields"
      contains: "workspace_id"
  key_links:
    - from: "src/wxcode/services/step_executor.py"
      to: "CLI import"
      via: "command args include workspace options"
      pattern: '"--workspace-id", session.workspace_id'
    - from: "src/wxcode/parser/project_mapper.py"
      to: "Project model"
      via: "_create_project method transforms name and sets workspace fields"
      pattern: "workspace_id=self.workspace_id"
    - from: "src/wxcode/api/import_wizard_ws.py"
      to: "cleanup_upload_files"
      via: "calls cleanup for all terminal states (completed, failed, cancelled)"
      pattern: "await cleanup_upload_files"
---

<objective>
Complete the import flow by wiring workspace through CLI, pipeline, and adding cleanup

Purpose: Connect the workspace created in Plan 01 through the entire import pipeline so Project records contain workspace info, and clean up temporary upload files after import completes.

Output: Full end-to-end workspace integration where importing a project results in a Project document with workspace_id and workspace_path populated, and upload directories are cleaned up.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-import-flow-update/09-RESEARCH.md
@.planning/phases/09-import-flow-update/09-01-SUMMARY.md

@src/wxcode/cli.py
@src/wxcode/services/step_executor.py
@src/wxcode/parser/project_mapper.py
@src/wxcode/api/import_wizard_ws.py
@frontend/src/types/project.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace options to CLI import command</name>
  <files>src/wxcode/cli.py</files>
  <action>
Add two new optional parameters to the `import_project` command:

```python
@app.command("import")
def import_project(
    project_path: Path = typer.Argument(...),
    batch_size: int = typer.Option(100, "--batch-size", "-b", ...),
    force: bool = typer.Option(False, "--force", "-f", ...),
    workspace_id: Optional[str] = typer.Option(
        None,
        "--workspace-id",
        help="ID do workspace (8 hex chars) para associar ao projeto",
    ),
    workspace_path: Optional[str] = typer.Option(
        None,
        "--workspace-path",
        help="Caminho do diretorio do workspace",
    ),
) -> None:
```

Add import at top: `from typing import Optional`

Inside the `_import()` async function, pass these to the mapper:
```python
mapper = ProjectElementMapper(
    project_path,
    on_progress=on_progress,
    workspace_id=workspace_id,
    workspace_path=workspace_path,
)
```

IMPORTANT: The CLI only passes workspace_id and workspace_path through to ProjectMapper.
The name transformation (adding workspace_id suffix) happens in ProjectMapper._create_project, NOT in the CLI.
  </action>
  <verify>
Run `python -m wxcode.cli import --help` and verify:
- Shows `--workspace-id` option with help text
- Shows `--workspace-path` option with help text
  </verify>
  <done>CLI import command accepts --workspace-id and --workspace-path options</done>
</task>

<task type="auto">
  <name>Task 2: Update StepExecutor and ProjectMapper to pass workspace through pipeline</name>
  <files>src/wxcode/services/step_executor.py, src/wxcode/parser/project_mapper.py</files>
  <action>
**StepExecutor (step_executor.py):**

Modify `_get_commands_for_step` to include workspace options for step 2 (import):

```python
def _get_commands_for_step(self, session: ImportSession, step: int) -> list[tuple[str, list[str]]]:
    # ... existing code ...

    # Build step 2 command with workspace options
    import_cmd = [python, "-m", "wxcode.cli", "import", project_path, "--force"]

    # Add workspace options if available in session
    if session.workspace_id:
        import_cmd.extend(["--workspace-id", session.workspace_id])
    if session.workspace_path:
        import_cmd.extend(["--workspace-path", session.workspace_path])

    commands_map = {
        2: [("wxcode import", import_cmd)],
        # ... rest unchanged
    }
```

**ProjectMapper (project_mapper.py):**

1. Add workspace_id and workspace_path parameters to `__init__`:
```python
def __init__(
    self,
    project_file: Path,
    on_progress: Optional[callable] = None,
    workspace_id: Optional[str] = None,
    workspace_path: Optional[str] = None,
):
    # ... existing init ...
    self.workspace_id = workspace_id
    self.workspace_path = workspace_path
```

2. Update `_create_project` to include workspace fields and handle naming.
   CRITICAL: This is where the name transformation happens (not in CLI):
```python
async def _create_project(self) -> Project:
    """Cria objeto Project com metadados extraidos."""
    original_name = self._project_data.get("name", self.project_file.stem)

    # If workspace_id provided, append to name for uniqueness
    # This transformation happens HERE, not in CLI
    if self.workspace_id:
        project_name = f"{original_name}_{self.workspace_id}"
        display_name = original_name
    else:
        project_name = original_name
        display_name = None  # No display_name needed if no workspace

    return Project(
        name=project_name,
        display_name=display_name,
        source_path=str(self.project_file),
        workspace_id=self.workspace_id,
        workspace_path=self.workspace_path,
        # ... rest unchanged
    )
```

3. Update `map_project_elements` convenience function signature:
```python
async def map_project_elements(
    project_file: Path,
    on_progress: Optional[callable] = None,
    workspace_id: Optional[str] = None,
    workspace_path: Optional[str] = None,
) -> tuple[Project, MappingStats]:
    mapper = ProjectElementMapper(
        project_file,
        on_progress,
        workspace_id=workspace_id,
        workspace_path=workspace_path,
    )
    return await mapper.map()
```
  </action>
  <verify>
1. Check StepExecutor: `grep -n "workspace_id" src/wxcode/services/step_executor.py` shows workspace options added to import command

2. Check ProjectMapper: `grep -n "workspace_id" src/wxcode/parser/project_mapper.py` shows:
   - Parameter in __init__
   - Field in _create_project
   - Parameter in map_project_elements

3. Check name transformation in _create_project:
   `grep -A5 "_create_project\|f\"{original_name}_" src/wxcode/parser/project_mapper.py`
   Should show the name suffix logic is in _create_project method

4. End-to-end wiring test (integration check):
   Create a test import session with workspace_id, run import via CLI with workspace options,
   verify the resulting Project document in MongoDB has workspace_id and workspace_path populated:
   ```bash
   # After running a test import:
   python -c "
   import asyncio
   from wxcode.models.project import Project
   from beanie import init_beanie
   from motor.motor_asyncio import AsyncIOMotorClient
   async def check():
       client = AsyncIOMotorClient('mongodb://localhost:27017')
       await init_beanie(database=client.wxcode, document_models=[Project])
       p = await Project.find_one({'workspace_id': {'$ne': None}})
       if p:
           print(f'Project: {p.name}, workspace_id: {p.workspace_id}, workspace_path: {p.workspace_path}')
       else:
           print('No project with workspace_id found yet (run import first)')
   asyncio.run(check())
   "
   ```
  </verify>
  <done>StepExecutor passes workspace options to CLI, ProjectMapper._create_project transforms name and populates workspace fields in Project</done>
</task>

<task type="auto">
  <name>Task 3: Add cleanup logic and update frontend types</name>
  <files>src/wxcode/api/import_wizard_ws.py, frontend/src/types/project.ts</files>
  <action>
**WebSocket handler (import_wizard_ws.py):**

1. Add cleanup function after imports:
```python
import shutil
from pathlib import Path

async def cleanup_upload_files(session: ImportSession) -> None:
    """
    Remove arquivos temporarios de upload apos importacao.

    Limpa:
    - Diretorio de sessao (session_xxx/) com arquivo zip e projeto extraido
    - Diretorio de PDFs (pdfs_xxx/) se existir

    Erros sao logados mas nao propagados (cleanup e best-effort).
    """
    import logging
    logger = logging.getLogger(__name__)

    try:
        # Remove session upload directory
        project_file = Path(session.project_path)
        # Go up from project.wwp -> project/ -> session_xxx/
        session_dir = project_file.parent.parent
        if session_dir.exists() and session_dir.name.startswith("session_"):
            shutil.rmtree(session_dir, ignore_errors=True)
            logger.info(f"Cleaned up session directory: {session_dir}")
    except Exception as e:
        logger.warning(f"Failed to cleanup session directory: {e}")

    try:
        # Remove PDF upload directory
        if session.pdf_docs_path:
            pdf_dir = Path(session.pdf_docs_path)
            # PDFs might be in pdfs_xxx/ or pdfs_xxx/split/
            # Go to parent if we're in split/
            if pdf_dir.name == "split":
                pdf_dir = pdf_dir.parent
            if pdf_dir.exists() and "pdfs_" in pdf_dir.name:
                shutil.rmtree(pdf_dir, ignore_errors=True)
                logger.info(f"Cleaned up PDF directory: {pdf_dir}")
    except Exception as e:
        logger.warning(f"Failed to cleanup PDF directory: {e}")
```

2. Call cleanup in `handle_start` after wizard completes successfully:
```python
async def handle_start(session: ImportSession, websocket: WebSocket) -> None:
    # ... existing code ...

    # If chegou ao final sem erros, marcar como completed (recarregar do banco)
    fresh_session = await ImportSession.find_one(ImportSession.session_id == session.session_id)
    if fresh_session and fresh_session.status == "running":
        fresh_session.status = "completed"
        await fresh_session.save()

        # Cleanup upload files after successful import
        await cleanup_upload_files(fresh_session)

        # Enviar evento de conclusao com project_name
        complete_event = {
            "type": "wizard_complete",
            "message": "Knowledge Database construida!",
            "project_name": fresh_session.project_name,
            "workspace_id": fresh_session.workspace_id,  # ADD THIS
            "workspace_path": fresh_session.workspace_path,  # ADD THIS
        }
        await websocket.send_text(json.dumps(complete_event))
```

3. CRITICAL: Call cleanup for ALL terminal states, not just "completed":

   In `handle_cancel` (or wherever cancellation is processed):
   ```python
   async def handle_cancel(session: ImportSession, websocket: WebSocket) -> None:
       # ... existing cancellation logic ...
       session.status = "cancelled"
       await session.save()

       # Cleanup upload files on cancellation too
       await cleanup_upload_files(session)
   ```

   After step execution failures (in the step execution error handler):
   ```python
   # When a step fails and we mark session as "failed"
   if step_failed:
       session.status = "failed"
       await session.save()

       # Cleanup upload files on failure too
       await cleanup_upload_files(session)
   ```

   Summary of cleanup trigger points:
   - status = "completed" -> cleanup
   - status = "failed" -> cleanup
   - status = "cancelled" -> cleanup

   All three terminal states should trigger cleanup.

**Frontend types (project.ts):**

Add workspace fields to the Project interface:
```typescript
export interface Project {
  id: string;
  name: string;
  display_name?: string;      // NEW: Original name without workspace suffix
  workspace_id?: string;      // NEW: 8-char hex workspace ID
  workspace_path?: string;    // NEW: Full path to workspace directory
  description?: string;
  elementsCount: number;
  // ... rest unchanged
}
```

Also update the Backend types section if there's a BackendProject type.
  </action>
  <verify>
1. Check cleanup function exists: `grep -n "cleanup_upload_files" src/wxcode/api/import_wizard_ws.py`

2. Check cleanup is called for all terminal states:
   ```bash
   grep -B2 "await cleanup_upload_files" src/wxcode/api/import_wizard_ws.py
   ```
   Should show cleanup called after:
   - "completed" status
   - "failed" status
   - "cancelled" status

3. Check frontend types: `grep -n "workspace_id" frontend/src/types/project.ts`
  </verify>
  <done>Upload files cleaned after import completes, fails, or is cancelled; frontend Project type has workspace fields</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. CLI accepts workspace options:
   ```bash
   python -m wxcode.cli import --help | grep -E "workspace-id|workspace-path"
   ```
   Should show both options

2. Full pipeline integration:
   ```bash
   # StepExecutor includes workspace in commands
   grep -A5 "import_cmd\|commands_map" src/wxcode/services/step_executor.py | grep workspace
   ```

3. Name transformation in ProjectMapper:
   ```bash
   grep -n "f\"{original_name}_" src/wxcode/parser/project_mapper.py
   ```
   Should show name suffix logic exists in _create_project

4. Cleanup function exists and is called for all terminal states:
   ```bash
   grep -c "cleanup_upload_files" src/wxcode/api/import_wizard_ws.py
   ```
   Should return 4+ (1 definition + 3 calls for completed/failed/cancelled)

5. Frontend types updated:
   ```bash
   grep "workspace_id" frontend/src/types/project.ts
   ```
</verification>

<success_criteria>
- CLI `import` command accepts `--workspace-id` and `--workspace-path` options
- StepExecutor passes workspace options to CLI when available in session
- ProjectMapper._create_project transforms name (adds workspace_id suffix) and populates workspace fields
- Project name includes workspace_id suffix for uniqueness (e.g., "Linkpay_ADM_a1b2c3d4")
- Cleanup function removes upload temp files after ALL terminal states (completed, failed, cancelled)
- wizard_complete event includes workspace_id and workspace_path
- Frontend Project interface includes workspace fields
</success_criteria>

<output>
After completion, create `.planning/phases/09-import-flow-update/09-02-SUMMARY.md`
</output>
