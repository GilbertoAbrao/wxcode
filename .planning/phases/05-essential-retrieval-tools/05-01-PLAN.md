---
phase: 05-essential-retrieval-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/mcp/tools/__init__.py
  - src/wxcode/mcp/tools/elements.py
  - src/wxcode/mcp/server.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can retrieve complete element definition by name"
    - "User can list elements with filters (project, type, layer, status)"
    - "User can search code patterns using regex"
  artifacts:
    - path: "src/wxcode/mcp/tools/__init__.py"
      provides: "Tool package initialization and registration"
      min_lines: 10
    - path: "src/wxcode/mcp/tools/elements.py"
      provides: "get_element, list_elements, search_code tools"
      exports: ["get_element", "list_elements", "search_code"]
      min_lines: 150
  key_links:
    - from: "src/wxcode/mcp/server.py"
      to: "src/wxcode/mcp/tools/__init__.py"
      via: "import statement"
      pattern: "from wxcode.mcp import tools"
    - from: "src/wxcode/mcp/tools/elements.py"
      to: "mcp decorator"
      via: "@mcp.tool decorator"
      pattern: "@mcp\\.tool"
---

<objective>
Create the foundational MCP tools package and implement element query tools.

Purpose: Enable users to discover and inspect WinDev elements (pages, procedures, classes, queries) through Claude Code. These are the core retrieval operations needed for any conversion workflow.

Output:
- `src/wxcode/mcp/tools/` package with `__init__.py`
- `elements.py` with `get_element`, `list_elements`, `search_code` tools
- Updated `server.py` to import and register tools
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 4 established the foundation
@.planning/phases/04-core-infrastructure/04-01-SUMMARY.md

# Research has verified patterns
@.planning/phases/05-essential-retrieval-tools/05-RESEARCH.md

# Existing implementation to extend
@src/wxcode/mcp/server.py
@src/wxcode/models/element.py
@src/wxcode/models/project.py

# Battle-tested query patterns
@src/wxcode/services/gsd_context_collector.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tools package with element tools</name>
  <files>
    src/wxcode/mcp/tools/__init__.py
    src/wxcode/mcp/tools/elements.py
  </files>
  <action>
Create the `src/wxcode/mcp/tools/` directory and implement element tools.

**File: `src/wxcode/mcp/tools/__init__.py`**
```python
"""MCP Tools for wxcode Knowledge Base.

All tools are registered on import by using the @mcp.tool decorator.
Import this module to register all tools with the MCP server.
"""

# Import all tool modules to register them with @mcp.tool
from wxcode.mcp.tools import elements  # noqa: F401

__all__ = ["elements"]
```

**File: `src/wxcode/mcp/tools/elements.py`**

Implement three tools following research patterns (see 05-RESEARCH.md sections Pattern 1-6):

1. **`get_element`** (CORE-01):
   - Parameters: `element_name: str`, `project_name: str | None = None`, `include_raw_content: bool = True`
   - Query pattern: If project_name provided, use DBRef query via raw Motor collection (Pattern 3)
   - Return: Complete element with AST, dependencies, conversion status
   - Error handling: Return error dict with code, message, suggestion (Pattern 4)

2. **`list_elements`** (CORE-02):
   - Parameters: `project_name: str | None`, `element_type: str | None`, `layer: str | None`, `conversion_status: str | None`, `limit: int = 100`
   - Query: Build filter dict, count total, return limited results
   - Return: List of element summaries (name, type, layer, status) - NO raw_content

3. **`search_code`** (CORE-03):
   - Parameters: `pattern: str`, `project_name: str | None`, `element_types: list[str] | None`, `limit: int = 50`
   - Query: Use MongoDB `$regex` operator on `raw_content` field
   - Return: Matches with preview showing context around match (Pattern 6)

**Key implementation details:**
- Import `mcp` from `wxcode.mcp.server`
- Use `ctx: Context` as first parameter (injected by FastMCP)
- Access lifespan context via `ctx.lifespan_context["mongo_client"]` for DBRef queries
- Convert enums with `.value`, ObjectIds with `str()`
- Use `model_dump(mode="json")` for nested Pydantic models
- Wrap all tools in try/except, return error dicts on failure

**Helper functions to create:**
- `_find_element(ctx, element_name, project_name)` - Returns `(Element | None, error_message | None)`
- `_serialize_element(element, include_raw)` - Converts Element to JSON-safe dict
- `_extract_match_preview(content, pattern, context_chars=100)` - Extracts preview around regex match
  </action>
  <verify>
```bash
# Check files exist with expected structure
python -c "from wxcode.mcp.tools import elements; print('Tools module imports OK')"
python -c "from wxcode.mcp.tools.elements import get_element, list_elements, search_code; print('All 3 tools defined')"
```
  </verify>
  <done>
- tools/__init__.py exists and imports elements module
- elements.py defines get_element, list_elements, search_code with @mcp.tool decorator
- All tools have type-annotated parameters and docstrings
- Helper functions handle DBRef queries and serialization
  </done>
</task>

<task type="auto">
  <name>Task 2: Register tools in server and verify integration</name>
  <files>src/wxcode/mcp/server.py</files>
  <action>
Update `src/wxcode/mcp/server.py` to import the tools package, which auto-registers tools via decorators.

**Changes to server.py:**

After the line `mcp = FastMCP("wxcode-kb", lifespan=app_lifespan)`, add:

```python
# Register all tools by importing the tools package
from wxcode.mcp import tools  # noqa: F401 - import for side effects
```

Remove the commented placeholder:
```python
# Tools will be registered here in Phase 5+
# from wxcode.mcp.tools import register_tools
# register_tools(mcp)
```
  </action>
  <verify>
```bash
# Start server and verify tools are registered
cd /Users/gilberto/projetos/wxk/wxcode
timeout 5 python -m wxcode.mcp.server 2>&1 | head -20 || true
# Should show startup without import errors

# Verify via claude mcp list (if available)
claude mcp list 2>/dev/null | grep -i wxcode || echo "Claude MCP check skipped"
```
  </verify>
  <done>
- server.py imports tools package
- Server starts without import errors
- Tools are registered and visible to FastMCP
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration test with MongoDB</name>
  <files>None (verification only)</files>
  <action>
Test the tools against a real MongoDB instance to verify queries work correctly.

**Test script to run:**
```python
import asyncio
from wxcode.database import init_db, close_db
from wxcode.models import Element, Project

async def test_tools():
    client = await init_db()
    try:
        # Check if any projects exist
        projects = await Project.find().limit(5).to_list()
        print(f"Projects found: {len(projects)}")
        for p in projects:
            print(f"  - {p.name}")

        # Check if any elements exist
        elements = await Element.find().limit(5).to_list()
        print(f"Elements found: {len(elements)}")
        for e in elements:
            print(f"  - {e.source_name} ({e.source_type.value})")

        # Test regex search capability
        if elements:
            test_elements = await Element.find({"raw_content": {"$regex": "PROCEDURE", "$options": "i"}}).limit(3).to_list()
            print(f"Elements with 'PROCEDURE' in code: {len(test_elements)}")

    finally:
        await close_db(client)

asyncio.run(test_tools())
```

If no data exists, the tools should return appropriate empty results without crashing.
  </action>
  <verify>
```bash
cd /Users/gilberto/projetos/wxk/wxcode
python -c "
import asyncio
from wxcode.database import init_db, close_db
from wxcode.models import Element, Project

async def test():
    client = await init_db()
    try:
        projects = await Project.find().limit(1).to_list()
        elements = await Element.find().limit(1).to_list()
        print(f'DB connected: projects={len(projects)}, elements={len(elements)}')
        return True
    finally:
        await close_db(client)

asyncio.run(test())
"
```
  </verify>
  <done>
- MongoDB connection works
- Element and Project queries execute without errors
- Empty results handled gracefully
  </done>
</task>

</tasks>

<verification>
All three element tools are implemented and registered:

1. **get_element** - Retrieves single element with full details
2. **list_elements** - Lists elements with filters, returns summaries
3. **search_code** - Searches code patterns with regex, returns previews

Run full verification:
```bash
cd /Users/gilberto/projetos/wxk/wxcode

# 1. Module imports work
python -c "from wxcode.mcp.tools.elements import get_element, list_elements, search_code; print('OK')"

# 2. Server starts (will timeout after 3s, that's expected)
timeout 3 python -m wxcode.mcp.server 2>&1 | grep -E "(Starting|Error)" || echo "Server started"

# 3. No syntax errors in tools
python -m py_compile src/wxcode/mcp/tools/elements.py && echo "Syntax OK"
```
</verification>

<success_criteria>
- [ ] `src/wxcode/mcp/tools/__init__.py` exists and imports elements module
- [ ] `src/wxcode/mcp/tools/elements.py` defines 3 tools with @mcp.tool decorator
- [ ] `src/wxcode/mcp/server.py` imports tools package
- [ ] Server starts without import errors
- [ ] Tools follow error handling pattern (return dicts, don't raise)
- [ ] Tools use DBRef pattern for project-scoped queries
- [ ] Enums and ObjectIds properly serialized
</success_criteria>

<output>
After completion, create `.planning/phases/05-essential-retrieval-tools/05-01-SUMMARY.md`
</output>
