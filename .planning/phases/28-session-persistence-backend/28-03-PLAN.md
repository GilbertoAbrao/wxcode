---
phase: 28-session-persistence-backend
plan: 03
type: execute
wave: 2
depends_on: ["28-01", "28-02"]
files_modified:
  - src/wxcode/api/milestones.py
autonomous: true

must_haves:
  truths:
    - "First Claude Code run captures session_id from init message"
    - "Return visit resumes session with --resume flag"
    - "New milestone sends /gsd:new-milestone to existing session"
    - "All milestones work in output project root folder"
    - ".planning folder is shared across all milestones"
  artifacts:
    - path: "src/wxcode/api/milestones.py"
      provides: "Milestone API with session persistence"
      contains: ["--resume", "capture_session_id_from_line", "get_session_by_output_project"]
  key_links:
    - from: "src/wxcode/api/milestones.py"
      to: "src/wxcode/services/session_id_capture.py"
      via: "capture from PTY output"
      pattern: "capture_session_id_from_line"
    - from: "src/wxcode/api/milestones.py"
      to: "src/wxcode/services/pty_session_manager.py"
      via: "session lookup by output_project"
      pattern: "get_session_by_output_project"
    - from: "src/wxcode/api/milestones.py"
      to: "src/wxcode/models/output_project.py"
      via: "session_id persistence"
      pattern: "claude_session_id"
---

<objective>
Wire session persistence into the milestone API - capture session_id on first run, resume on return, send commands to existing sessions.

Purpose: Enable complete session persistence flow so users never lose Claude Code conversation context across milestones or browser reconnects.
Output: Updated milestones.py with full session persistence integration.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-session-persistence-backend/28-RESEARCH.md

@src/wxcode/api/milestones.py
@src/wxcode/services/pty_session_manager.py
@src/wxcode/services/session_id_capture.py
@src/wxcode/models/output_project.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update _create_interactive_session for session persistence</name>
  <files>src/wxcode/api/milestones.py</files>
  <action>
Refactor the `_create_interactive_session` function to implement full session persistence:

1. **Change keying from milestone to output_project:**
   - Use `str(output_project.id)` instead of `str(milestone_oid)` for session lookup/create
   - Update call to `session_manager.create_session` with new signature

2. **Check for existing session first:**
   - Call `session_manager.get_session_by_output_project(str(output_project.id))`
   - If session exists and PTY alive: return it immediately (no new process)
   - If session exists but PTY dead: need to resume with --resume

3. **Build Claude command based on session state:**
   - If OutputProject has `claude_session_id` AND is_new_milestone:
     - Use `["claude", "--resume", claude_session_id, ...]`
     - Send `/gsd:new-milestone MILESTONE-CONTEXT.md` via stdin AFTER process starts
   - If OutputProject has `claude_session_id` but NOT new_milestone (reconnecting):
     - Use `["claude", "--resume", claude_session_id, ...]`
     - No initial command needed
   - If OutputProject has NO `claude_session_id` (first run):
     - Use `["claude", "/gsd:new-project MILESTONE-CONTEXT.md", ...]`
     - Capture session_id from init message

4. **Working directory changes (FOLD-01, FOLD-02, FOLD-03):**
   - Change `cwd` from `milestone_dir` to `output_project.workspace_path`
   - Keep `milestone_dir` for context files but Claude runs in project root
   - Ensure `.planning/` exists in workspace_path

5. **Add session ID capture callback:**
   - Import `capture_session_id_from_line` from session_id_capture
   - Create async task to monitor PTY output for init message
   - When session_id captured, call `save_session_id_atomic`

Reference RESEARCH.md Patterns 4 and 5 for exact implementation.
  </action>
  <verify>
Import check: `python -c "from wxcode.api.milestones import _create_interactive_session; print('OK')"`
  </verify>
  <done>_create_interactive_session handles session persistence with resume logic</done>
</task>

<task type="auto">
  <name>Task 2: Add session_id capture task and wiring</name>
  <files>src/wxcode/api/milestones.py</files>
  <action>
Add async task for session_id capture and integrate with terminal_websocket endpoint:

1. **Create session_id capture coroutine:**
```python
async def _capture_and_save_session_id(
    session: PTYSession,
    output_project_id: str,
) -> None:
    """
    Monitor PTY output and capture session_id from init message.
    Saves to MongoDB atomically when found.
    """
    from wxcode.services.session_id_capture import (
        capture_session_id_from_line,
        save_session_id_atomic,
    )

    # Monitor output buffer for init message
    # The TerminalHandler adds output to buffer - check periodically
    for _ in range(100):  # Max 10 seconds of checking
        await asyncio.sleep(0.1)
        for chunk in session.output_buffer:
            for line in chunk.split(b'\n'):
                session_id = capture_session_id_from_line(line)
                if session_id:
                    saved = await save_session_id_atomic(
                        output_project_id, session_id
                    )
                    if saved:
                        # Update in-memory session too
                        session.claude_session_id = session_id
                    return
```

2. **Update terminal_websocket to spawn capture task:**
   - After creating new session (first run case)
   - Use `asyncio.create_task(_capture_and_save_session_id(session, str(output_project.id)))`
   - Don't await - let it run in background

3. **Update session creation in terminal_websocket:**
   - Pass output_project to _create_interactive_session
   - Check if this is first milestone or subsequent
   - Handle milestone vs output_project session lookup
  </action>
  <verify>
Manual test flow:
1. Start server with `uvicorn wxcode.main:app --reload`
2. Connect to terminal WebSocket for a milestone
3. Check MongoDB after Claude starts - claude_session_id should be populated
  </verify>
  <done>Session ID is captured from init message and saved to MongoDB</done>
</task>

<task type="auto">
  <name>Task 3: Update command building for --resume and stdin commands</name>
  <files>src/wxcode/api/milestones.py</files>
  <action>
Extract command building logic into helper function and handle all session states:

1. **Create _build_claude_command helper:**
```python
def _build_claude_command(
    context_path: Path,
    working_dir: Path,
    claude_session_id: Optional[str],
    is_new_milestone: bool,
) -> tuple[list[str], Optional[str]]:
    """
    Build Claude CLI command and optional stdin command.

    Returns:
        Tuple of (command_list, stdin_command_or_none)
    """
    cmd = ["claude"]
    stdin_cmd = None

    if claude_session_id:
        # Resume existing session
        cmd.extend(["--resume", claude_session_id])
        if is_new_milestone:
            # New milestone in existing session - send via stdin
            relative_path = context_path.relative_to(working_dir)
            stdin_cmd = f"/gsd:new-milestone {relative_path}"
    else:
        # First run - use as argument
        relative_path = context_path.relative_to(working_dir)
        cmd.append(f"/gsd:new-project {relative_path}")

    # Common flags
    cmd.extend([
        "--dangerously-skip-permissions",
        "--allowedTools", "Read,Write,Edit,Bash,Glob,Grep,Task,TodoWrite",
        "--output-format", "stream-json",  # Enable session_id capture
        "--verbose",
    ])

    return cmd, stdin_cmd
```

2. **Update _create_interactive_session to use helper:**
   - Call _build_claude_command with appropriate parameters
   - If stdin_cmd returned, write to PTY after start

3. **Handle stdin command delivery:**
   - After `await pty.start()`, if stdin_cmd is not None:
   - `await pty.write(stdin_cmd.encode() + b'\n')`
   - Small delay to ensure delivery before WebSocket connects

4. **Add --output-format stream-json:**
   - Required for session_id capture
   - Must be in all command variants
  </action>
  <verify>
Test command building manually:
```python
from pathlib import Path
# Test first run
cmd, stdin = _build_claude_command(Path("/a/b/CONTEXT.md"), Path("/a"), None, False)
assert "--resume" not in cmd
assert "/gsd:new-project" in cmd[1]

# Test resume with new milestone
cmd, stdin = _build_claude_command(Path("/a/b/CONTEXT.md"), Path("/a"), "sess-123", True)
assert "--resume" in cmd
assert "sess-123" in cmd
assert stdin == "/gsd:new-milestone b/CONTEXT.md"
```
  </verify>
  <done>Claude command building handles all session states correctly</done>
</task>

</tasks>

<verification>
1. First milestone creates new session with /gsd:new-project
2. Session_id is captured and saved to MongoDB
3. Return visit resumes with --resume flag
4. New milestone sends /gsd:new-milestone via stdin
5. Working directory is always output project root
6. .planning folder exists in project root
</verification>

<success_criteria>
- OutputProject.claude_session_id is populated after first Claude run
- Browser refresh reconnects to same session (no new process)
- Creating second milestone reuses existing session
- All milestone work happens in output project root folder
- .planning/ folder is shared across milestones
</success_criteria>

<output>
After completion, create `.planning/phases/28-session-persistence-backend/28-03-SUMMARY.md`
</output>
