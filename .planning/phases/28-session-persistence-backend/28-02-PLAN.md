---
phase: 28-session-persistence-backend
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/services/pty_session_manager.py
autonomous: true

must_haves:
  truths:
    - "PTY sessions are keyed by output_project_id, not milestone_id"
    - "Multiple milestones in same OutputProject share same PTY session"
    - "Session lookup by output_project_id returns existing session"
  artifacts:
    - path: "src/wxcode/services/pty_session_manager.py"
      provides: "PTYSessionManager keyed by output_project_id"
      contains: "output_project_id"
  key_links:
    - from: "PTYSessionManager"
      to: "PTYSession"
      via: "session lookup by output_project_id"
      pattern: "_output_project_to_session"
---

<objective>
Refactor PTYSessionManager to key sessions by output_project_id instead of milestone_id, enabling session persistence across milestones.

Purpose: Allow multiple milestones within an OutputProject to share the same Claude Code session, preserving conversation context.
Output: Updated PTYSessionManager with output_project_id keying.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-session-persistence-backend/28-RESEARCH.md

@src/wxcode/services/pty_session_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor PTYSession and PTYSessionManager for output_project_id keying</name>
  <files>src/wxcode/services/pty_session_manager.py</files>
  <action>
Modify the existing PTYSessionManager to use output_project_id instead of milestone_id:

1. **PTYSession dataclass changes:**
   - Rename `milestone_id: str` to `output_project_id: str`
   - Add `claude_session_id: Optional[str] = None` field (for Claude's session_id)
   - Keep all other fields unchanged

2. **PTYSessionManager changes:**
   - Rename `_milestone_to_session` to `_output_project_to_session`
   - Update `create_session` method:
     - Change parameter from `milestone_id` to `output_project_id`
     - Add optional `claude_session_id` parameter
     - Update internal dict key
   - Rename `get_session_by_milestone` to `get_session_by_output_project`
   - Update `close_session` to use `output_project_id` for cleanup
   - Update `list_sessions` to return `output_project_id` instead of `milestone_id`

3. **Add get_or_create_session method:**
   - Check if session exists for output_project_id
   - If exists and PTY alive: return existing session
   - If not: return None (caller handles creation)
   - This prevents multiple PTY processes for same OutputProject

Reference RESEARCH.md Pattern 3 for exact implementation pattern.

IMPORTANT: Keep backward compatibility by maintaining the same public API signature style.
  </action>
  <verify>
1. Run `python -c "from wxcode.services.pty_session_manager import PTYSession, PTYSessionManager; print(PTYSession.__dataclass_fields__.keys())"` - should show output_project_id
2. Check that milestone_id is NOT in PTYSession fields
3. Run `python -c "from wxcode.services.pty_session_manager import PTYSessionManager; m = PTYSessionManager(); print(hasattr(m, 'get_session_by_output_project'))"` - should print True
  </verify>
  <done>PTYSessionManager uses output_project_id keying, PTYSession has output_project_id and claude_session_id fields</done>
</task>

<task type="auto">
  <name>Task 2: Update unit tests for PTYSessionManager</name>
  <files>tests/test_pty_session_manager.py</files>
  <action>
Update existing tests to use new output_project_id keying:

1. Find and replace all `milestone_id` references with `output_project_id` in test file
2. Update test assertions that check for `milestone_id` in session metadata
3. Add test for `get_session_by_output_project` method
4. Add test verifying same output_project_id returns same session (no duplicates)

If the test file doesn't exist, create it with basic tests:
- test_create_session_with_output_project_id
- test_get_session_by_output_project
- test_session_reuse_same_output_project
- test_list_sessions_returns_output_project_id

Use pytest and mock BidirectionalPTY for tests.
  </action>
  <verify>
Run `cd /Users/gilberto/projetos/wxk/wxcode && python -m pytest tests/test_pty_session_manager.py -v` - all tests should pass
  </verify>
  <done>PTYSessionManager unit tests pass with output_project_id keying</done>
</task>

</tasks>

<verification>
1. PTYSession has output_project_id field
2. PTYSession has claude_session_id field
3. PTYSessionManager.get_session_by_output_project exists
4. Unit tests pass
</verification>

<success_criteria>
- PTYSession uses output_project_id instead of milestone_id
- PTYSessionManager methods renamed to use output_project
- get_or_create pattern prevents duplicate sessions per OutputProject
- All existing functionality preserved with new keying
- Unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-session-persistence-backend/28-02-SUMMARY.md`
</output>
