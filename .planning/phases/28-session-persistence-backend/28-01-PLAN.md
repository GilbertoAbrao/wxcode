---
phase: 28-session-persistence-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/models/output_project.py
  - src/wxcode/services/session_id_capture.py
autonomous: true

must_haves:
  truths:
    - "OutputProject documents can store claude_session_id"
    - "Session ID can be captured from stream-json init message"
    - "Session ID can be saved atomically to avoid race conditions"
  artifacts:
    - path: "src/wxcode/models/output_project.py"
      provides: "OutputProject model with claude_session_id field"
      contains: "claude_session_id: Optional[str]"
    - path: "src/wxcode/services/session_id_capture.py"
      provides: "Helper to capture session_id from stream-json"
      exports: ["capture_session_id_from_line", "save_session_id_atomic"]
  key_links:
    - from: "src/wxcode/services/session_id_capture.py"
      to: "src/wxcode/models/output_project.py"
      via: "atomic MongoDB update"
      pattern: "OutputProject\\.find_one.*update"
---

<objective>
Add claude_session_id field to OutputProject model and create helper functions for session ID capture and atomic persistence.

Purpose: Enable Claude Code session persistence at the OutputProject level, so sessions survive browser disconnects and milestone boundaries.
Output: Updated OutputProject model and session_id_capture.py helper module.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-session-persistence-backend/28-RESEARCH.md

@src/wxcode/models/output_project.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add claude_session_id field to OutputProject model</name>
  <files>src/wxcode/models/output_project.py</files>
  <action>
Add a new field to the OutputProject Beanie document:

```python
# Session persistence for Claude Code
claude_session_id: Optional[str] = Field(
    default=None,
    description="Claude Code session_id for conversation resume"
)
```

Place this field after the `status` field, before `created_at`. This field stores the session_id returned by Claude Code CLI in the stream-json init message.

No migration needed - Beanie/MongoDB handles new fields with default None gracefully.
  </action>
  <verify>
1. Run `python -c "from wxcode.models.output_project import OutputProject; print(OutputProject.model_fields.get('claude_session_id'))"` - should show FieldInfo
2. Check that the field has `default=None`
  </verify>
  <done>OutputProject model has claude_session_id: Optional[str] field with None default</done>
</task>

<task type="auto">
  <name>Task 2: Create session_id_capture.py helper module</name>
  <files>src/wxcode/services/session_id_capture.py</files>
  <action>
Create a new module with two helper functions:

1. `capture_session_id_from_line(line: bytes) -> Optional[str]`:
   - Parse a single line of stream-json NDJSON output
   - Check for `type=system, subtype=init`
   - Extract and return `session_id` if present
   - Return None if not an init message or parsing fails
   - Handle both bytes and str input gracefully

2. `save_session_id_atomic(output_project_id: str, claude_session_id: str) -> bool`:
   - Use Beanie's atomic update to set claude_session_id
   - Only update if claude_session_id is currently None (avoid overwrite)
   - Return True if updated, False if already set or not found
   - Use `find_one(...).update(...)` pattern for atomicity

Include proper type hints, docstrings in Portuguese, and error handling.

Reference the RESEARCH.md Pattern 2 and "Atomic MongoDB Update" example for exact implementation.
  </action>
  <verify>
1. Run `python -c "from wxcode.services.session_id_capture import capture_session_id_from_line, save_session_id_atomic; print('imports OK')"` - should print "imports OK"
2. Test capture with sample init message: `capture_session_id_from_line(b'{"type":"system","subtype":"init","session_id":"test-123"}')` should return "test-123"
3. Test capture with non-init message: `capture_session_id_from_line(b'{"type":"output","data":"hello"}')` should return None
  </verify>
  <done>session_id_capture.py exists with capture_session_id_from_line and save_session_id_atomic functions, properly tested</done>
</task>

</tasks>

<verification>
1. OutputProject model imports without error
2. session_id_capture module imports without error
3. Capture function correctly identifies init messages
4. Atomic save function signature is correct
</verification>

<success_criteria>
- OutputProject.claude_session_id field exists with Optional[str] type
- capture_session_id_from_line correctly parses stream-json init messages
- save_session_id_atomic provides atomic MongoDB update pattern
- All imports work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/28-session-persistence-backend/28-01-SUMMARY.md`
</output>
