---
phase: 16-output-project-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/api/stacks.py
  - src/wxcode/api/output_projects.py
  - src/wxcode/main.py
autonomous: true

must_haves:
  truths:
    - "GET /api/stacks returns list of stacks"
    - "GET /api/stacks/grouped returns stacks organized by category"
    - "POST /api/output-projects creates new output project with workspace"
    - "GET /api/output-projects returns list of output projects"
  artifacts:
    - path: "src/wxcode/api/stacks.py"
      provides: "Stack listing endpoints"
      exports: ["router"]
    - path: "src/wxcode/api/output_projects.py"
      provides: "OutputProject CRUD endpoints"
      exports: ["router"]
    - path: "src/wxcode/main.py"
      provides: "Router registration"
      contains: "stacks.router"
  key_links:
    - from: "src/wxcode/api/stacks.py"
      to: "wxcode.services.stack_service"
      via: "import and call"
      pattern: "from wxcode.services import stack_service"
    - from: "src/wxcode/api/output_projects.py"
      to: "wxcode.models.OutputProject"
      via: "Beanie document operations"
      pattern: "OutputProject\\.(find|insert|get)"
    - from: "src/wxcode/main.py"
      to: "api/stacks.py"
      via: "router registration"
      pattern: "app\\.include_router\\(stacks\\.router"
---

<objective>
Create FastAPI backend endpoints for stack listing and OutputProject CRUD operations.

Purpose: Provide API foundation for the output project creation UI. The stack endpoints expose pre-configured stacks (from Phase 15) grouped by category. The OutputProject endpoints enable creating conversion projects linked to a KB.

Output: Two new API routers registered in main.py, ready for frontend consumption.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v4/ROADMAP.md
@.planning/phases/16-output-project-ui/16-RESEARCH.md

# Existing patterns
@src/wxcode/api/products.py
@src/wxcode/services/stack_service.py
@src/wxcode/models/output_project.py
@src/wxcode/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stacks API router</name>
  <files>src/wxcode/api/stacks.py</files>
  <action>
Create FastAPI router for stack endpoints following existing products.py patterns.

Endpoints:
1. `GET /` - List all stacks with optional filtering by group and language
2. `GET /grouped` - Get all stacks organized by category (server-rendered, spa, fullstack)

Response models (Pydantic):
- `StackResponse`: stack_id, name, group, language, framework, orm, template_engine
- `StackListResponse`: stacks list + total count
- `StacksGroupedResponse`: server_rendered, spa, fullstack lists

Use stack_service functions (already exist from Phase 15):
- `list_stacks(group, language)` for filtered listing
- `get_stacks_grouped()` for grouped response

Include docstrings in Portuguese (project convention).
  </action>
  <verify>
```bash
# Start server and test endpoints
cd /Users/gilberto/projetos/wxk/wxcode
python -c "from wxcode.api.stacks import router; print('Import OK')"
```
  </verify>
  <done>
- stacks.py exists with router exported
- Two endpoints defined with Pydantic response models
- Uses stack_service functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OutputProjects API router</name>
  <files>src/wxcode/api/output_projects.py</files>
  <action>
Create FastAPI router for OutputProject CRUD following products.py patterns.

Endpoints:
1. `POST /` - Create new output project
   - Request: kb_id, name, stack_id, configuration_id (optional)
   - Validate kb_id exists (get Project)
   - Create workspace via WorkspaceManager.create_output_project_workspace()
   - Insert OutputProject document
   - Return OutputProjectResponse with 201 status

2. `GET /` - List output projects with optional filtering
   - Query params: kb_id, status, skip, limit
   - Join KB name for response (fetch Project for kb_name)
   - Return OutputProjectListResponse

3. `GET /{id}` - Get single output project by ID
   - Return 404 if not found

Response models (Pydantic):
- `CreateOutputProjectRequest`: kb_id, name, stack_id, configuration_id
- `OutputProjectResponse`: id, kb_id, kb_name, name, stack_id, configuration_id, workspace_path, status, created_at, updated_at
- `OutputProjectListResponse`: projects list + total count

Import WorkspaceManager from wxcode.services.workspace_manager for workspace creation.

Include docstrings in Portuguese (project convention).
  </action>
  <verify>
```bash
cd /Users/gilberto/projetos/wxk/wxcode
python -c "from wxcode.api.output_projects import router; print('Import OK')"
```
  </verify>
  <done>
- output_projects.py exists with router exported
- Three endpoints (POST, GET list, GET by id)
- CreateOutputProjectRequest validates and creates workspace
- Response includes kb_name from joined Project
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire routers in main.py</name>
  <files>src/wxcode/main.py</files>
  <action>
Register the new API routers in FastAPI application.

1. Add imports at top with other API imports:
   ```python
   from wxcode.api import stacks, output_projects
   ```

2. Add router registrations after existing routers:
   ```python
   app.include_router(stacks.router, prefix="/api/stacks", tags=["Stacks"])
   app.include_router(output_projects.router, prefix="/api/output-projects", tags=["Output Projects"])
   ```

Order: Place after workspace.router registration to group new v4 routers together.
  </action>
  <verify>
```bash
cd /Users/gilberto/projetos/wxk/wxcode
# Test full import chain
python -c "from wxcode.main import app; print([r.path for r in app.routes if 'stacks' in r.path or 'output-projects' in r.path])"

# Start server briefly to verify routes
timeout 5 uvicorn wxcode.main:app --host 127.0.0.1 --port 8765 2>&1 | head -20 || true

# Curl test (if server started)
curl -s http://127.0.0.1:8765/api/stacks/grouped 2>/dev/null | head -100 || echo "Server test skipped"
```
  </verify>
  <done>
- main.py imports stacks and output_projects routers
- Routes registered at /api/stacks and /api/output-projects
- Server starts without import errors
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/gilberto/projetos/wxk/wxcode

# 1. Verify all files exist
ls -la src/wxcode/api/stacks.py src/wxcode/api/output_projects.py

# 2. Run type checking
python -m mypy src/wxcode/api/stacks.py src/wxcode/api/output_projects.py --ignore-missing-imports || true

# 3. Start server and test endpoints
uvicorn wxcode.main:app --host 127.0.0.1 --port 8766 &
sleep 3

# Test stacks endpoint
curl -s http://127.0.0.1:8766/api/stacks/grouped | python -c "import sys, json; d=json.load(sys.stdin); print(f'Stacks: {len(d.get(\"server_rendered\", []))} server-rendered, {len(d.get(\"spa\", []))} spa, {len(d.get(\"fullstack\", []))} fullstack')"

# Test output-projects list (should return empty)
curl -s http://127.0.0.1:8766/api/output-projects | python -c "import sys, json; d=json.load(sys.stdin); print(f'Output Projects: {d.get(\"total\", 0)} total')"

# Cleanup
pkill -f "uvicorn wxcode.main:app.*8766" 2>/dev/null || true
```
</verification>

<success_criteria>
- GET /api/stacks/grouped returns 15 stacks in 3 groups
- GET /api/output-projects returns empty list (no projects yet)
- POST /api/output-projects accepts valid request (tested in later plan)
- No import errors, server starts cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/16-output-project-ui/16-01-SUMMARY.md`
</output>
