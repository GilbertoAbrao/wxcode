---
phase: 23-integration-testing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/test_websocket_initialize.py
autonomous: true

must_haves:
  truths:
    - "WebSocket /initialize endpoint calls extract_connections_for_project()"
    - "WebSocket /initialize endpoint calls extract_global_state_for_project()"
    - "WebSocket /initialize endpoint passes extracted data to PromptBuilder.write_context_file()"
    - "CONTEXT.md is written to workspace path"
  artifacts:
    - path: "tests/integration/test_websocket_initialize.py"
      provides: "Integration tests for WebSocket /initialize endpoint"
      min_lines: 150
  key_links:
    - from: "tests/integration/test_websocket_initialize.py"
      to: "src/wxcode/api/output_projects.py"
      via: "imports and tests initialize_output_project"
      pattern: "from wxcode.api.output_projects import"
    - from: "tests/integration/test_websocket_initialize.py"
      to: "src/wxcode/services/schema_extractor.py"
      via: "mocks extraction functions"
      pattern: "patch.*extract_connections_for_project"
---

<objective>
Create integration tests for WebSocket /initialize endpoint to verify it calls all extractors and passes data to PromptBuilder.

Purpose: Cover Success Criteria SC-2: "WebSocket /initialize endpoint calls new extractors and passes data to PromptBuilder"
Output: Test file `tests/integration/test_websocket_initialize.py` with integration tests.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-integration-testing/23-RESEARCH.md

@src/wxcode/api/output_projects.py
@tests/integration/test_database_connections_pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocket /initialize integration tests</name>
  <files>tests/integration/test_websocket_initialize.py</files>
  <action>
Create `tests/integration/test_websocket_initialize.py` with comprehensive integration tests.

**Note:** The WebSocket endpoint requires mocking several database models and services. Follow the async test pattern from `tests/integration/test_database_connections_pipeline.py`.

1. **Imports and Setup:**

```python
"""Integration tests for WebSocket /initialize endpoint.

Tests verify that the initialization flow:
1. Calls extract_connections_for_project()
2. Calls extract_global_state_for_project()
3. Passes extracted data to PromptBuilder.write_context_file()
4. Writes CONTEXT.md to workspace
"""

import tempfile
from dataclasses import dataclass, field
from enum import Enum
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock, patch, call

import pytest
from fastapi import WebSocket

# Import the actual function to test
from wxcode.api.output_projects import initialize_output_project
```

2. **Mock Classes (dataclass-based, no MongoDB):**

```python
class MockScope(Enum):
    APP = "APP"
    MODULE = "MODULE"

@dataclass
class MockSchemaConnection:
    name: str
    type_code: int
    database_type: str
    driver_name: str
    source: str
    port: str
    database: str
    user: str
    extended_info: str = ""

@dataclass
class MockGlobalVariable:
    name: str
    wlanguage_type: str
    default_value: str | None = None
    scope: MockScope = MockScope.APP
    source_element: str = "Project.wwp"

@dataclass
class MockInitializationBlock:
    code: str
    dependencies: list[str] = field(default_factory=list)
    order: int = 0

@dataclass
class MockGlobalStateContext:
    variables: list[MockGlobalVariable] = field(default_factory=list)
    initialization_blocks: list[MockInitializationBlock] = field(default_factory=list)

class MockOutputProjectStatus(Enum):
    CREATED = "created"
    INITIALIZED = "initialized"
    ACTIVE = "active"
```

3. **Fixtures:**

```python
@pytest.fixture
def mock_websocket():
    """Create a mock WebSocket that tracks sent messages."""
    ws = MagicMock(spec=WebSocket)
    ws.accept = AsyncMock()
    ws.send_json = AsyncMock()
    ws.close = AsyncMock()
    ws.sent_messages = []

    async def track_send(data):
        ws.sent_messages.append(data)

    ws.send_json.side_effect = track_send
    return ws

@pytest.fixture
def mock_output_project(tmp_path):
    """Create a mock OutputProject with workspace path."""
    project = MagicMock()
    project.name = "TestProject"
    project.kb_id = "507f1f77bcf86cd799439011"
    project.stack_id = "fastapi-jinja2"
    project.configuration_id = "config123"
    project.status = MockOutputProjectStatus.CREATED
    project.workspace_path = str(tmp_path / "workspace")
    project.save = AsyncMock()

    # Create workspace directory
    Path(project.workspace_path).mkdir(parents=True)

    return project

@pytest.fixture
def mock_stack():
    """Create a mock Stack."""
    stack = MagicMock()
    stack.name = "FastAPI + Jinja2"
    stack.language = "python"
    stack.framework = "FastAPI"
    stack.file_structure = {"app": {"routes": "API routes"}}
    stack.naming_conventions = {"files": "snake_case"}
    stack.type_mappings = {"string": "str"}
    stack.model_template = "class {name}(BaseModel): pass"
    stack.imports_template = "from fastapi import FastAPI"
    return stack

@pytest.fixture
def mock_connections():
    """Create mock database connections."""
    return [
        MockSchemaConnection(
            name="CNX_MAIN",
            type_code=1,
            database_type="sqlserver",
            driver_name="SQL Server",
            source="192.168.1.1",
            port="1433",
            database="MainDB",
            user="app_user",
        )
    ]

@pytest.fixture
def mock_global_state():
    """Create mock global state context."""
    return MockGlobalStateContext(
        variables=[
            MockGlobalVariable(
                name="g_AppVersion",
                wlanguage_type="string",
                default_value="1.0.0",
            )
        ],
        initialization_blocks=[
            MockInitializationBlock(
                code="g_AppVersion = GetAppVersion()",
                dependencies=["GetAppVersion"],
            )
        ],
    )

@pytest.fixture
def mock_tables():
    """Create mock tables."""
    return [
        {
            "name": "USUARIO",
            "columns": [
                {"name": "id", "type": "int"},
                {"name": "nome", "type": "string"},
            ]
        }
    ]
```

4. **Test Class `TestWebSocketInitializeExtractors`:**

```python
class TestWebSocketInitializeExtractors:
    """Tests that /initialize endpoint calls all extractors correctly."""

    @patch("wxcode.api.output_projects.OutputProject")
    @patch("wxcode.api.output_projects.Stack")
    @patch("wxcode.api.output_projects.extract_schema_for_configuration")
    @patch("wxcode.api.output_projects.extract_connections_for_project")
    @patch("wxcode.api.output_projects.extract_global_state_for_project")
    @patch("wxcode.api.output_projects.PromptBuilder")
    @patch("wxcode.api.output_projects.GSDInvoker")
    async def test_calls_extract_connections_for_project(
        self,
        mock_gsd_invoker_class,
        mock_prompt_builder,
        mock_extract_global_state,
        mock_extract_connections,
        mock_extract_schema,
        mock_stack_model,
        mock_output_project_model,
        mock_websocket,
        mock_output_project,
        mock_stack,
        mock_connections,
        mock_global_state,
        mock_tables,
    ):
        """Verify extract_connections_for_project() is called with correct kb_id."""
        # Setup mocks
        mock_output_project_model.get = AsyncMock(return_value=mock_output_project)
        mock_stack_model.find_one = AsyncMock(return_value=mock_stack)
        mock_extract_schema.return_value = mock_tables
        mock_extract_connections.return_value = mock_connections
        mock_extract_global_state.return_value = mock_global_state
        mock_prompt_builder.write_context_file.return_value = Path(mock_output_project.workspace_path) / "CONTEXT.md"

        # Setup GSD invoker mock
        mock_invoker = MagicMock()
        mock_invoker.invoke_with_streaming = AsyncMock(return_value=0)
        mock_gsd_invoker_class.return_value = mock_invoker

        # Call endpoint
        await initialize_output_project(mock_websocket, "507f1f77bcf86cd799439011")

        # Verify extract_connections_for_project was called
        mock_extract_connections.assert_called_once_with(mock_output_project.kb_id)

    @patch("wxcode.api.output_projects.OutputProject")
    @patch("wxcode.api.output_projects.Stack")
    @patch("wxcode.api.output_projects.extract_schema_for_configuration")
    @patch("wxcode.api.output_projects.extract_connections_for_project")
    @patch("wxcode.api.output_projects.extract_global_state_for_project")
    @patch("wxcode.api.output_projects.PromptBuilder")
    @patch("wxcode.api.output_projects.GSDInvoker")
    async def test_calls_extract_global_state_for_project(
        self,
        mock_gsd_invoker_class,
        mock_prompt_builder,
        mock_extract_global_state,
        mock_extract_connections,
        mock_extract_schema,
        mock_stack_model,
        mock_output_project_model,
        mock_websocket,
        mock_output_project,
        mock_stack,
        mock_connections,
        mock_global_state,
        mock_tables,
    ):
        """Verify extract_global_state_for_project() is called with correct kb_id."""
        # Setup mocks
        mock_output_project_model.get = AsyncMock(return_value=mock_output_project)
        mock_stack_model.find_one = AsyncMock(return_value=mock_stack)
        mock_extract_schema.return_value = mock_tables
        mock_extract_connections.return_value = mock_connections
        mock_extract_global_state.return_value = mock_global_state
        mock_prompt_builder.write_context_file.return_value = Path(mock_output_project.workspace_path) / "CONTEXT.md"

        # Setup GSD invoker mock
        mock_invoker = MagicMock()
        mock_invoker.invoke_with_streaming = AsyncMock(return_value=0)
        mock_gsd_invoker_class.return_value = mock_invoker

        # Call endpoint
        await initialize_output_project(mock_websocket, "507f1f77bcf86cd799439011")

        # Verify extract_global_state_for_project was called
        mock_extract_global_state.assert_called_once_with(mock_output_project.kb_id)
```

5. **Test Class `TestWebSocketInitializePromptBuilder`:**

```python
class TestWebSocketInitializePromptBuilder:
    """Tests that /initialize passes data to PromptBuilder correctly."""

    @patch("wxcode.api.output_projects.OutputProject")
    @patch("wxcode.api.output_projects.Stack")
    @patch("wxcode.api.output_projects.extract_schema_for_configuration")
    @patch("wxcode.api.output_projects.extract_connections_for_project")
    @patch("wxcode.api.output_projects.extract_global_state_for_project")
    @patch("wxcode.api.output_projects.PromptBuilder")
    @patch("wxcode.api.output_projects.GSDInvoker")
    async def test_passes_connections_to_prompt_builder(
        self,
        mock_gsd_invoker_class,
        mock_prompt_builder,
        mock_extract_global_state,
        mock_extract_connections,
        mock_extract_schema,
        mock_stack_model,
        mock_output_project_model,
        mock_websocket,
        mock_output_project,
        mock_stack,
        mock_connections,
        mock_global_state,
        mock_tables,
    ):
        """Verify PromptBuilder.write_context_file receives connections."""
        # Setup mocks
        mock_output_project_model.get = AsyncMock(return_value=mock_output_project)
        mock_stack_model.find_one = AsyncMock(return_value=mock_stack)
        mock_extract_schema.return_value = mock_tables
        mock_extract_connections.return_value = mock_connections
        mock_extract_global_state.return_value = mock_global_state
        mock_prompt_builder.write_context_file.return_value = Path(mock_output_project.workspace_path) / "CONTEXT.md"

        # Setup GSD invoker mock
        mock_invoker = MagicMock()
        mock_invoker.invoke_with_streaming = AsyncMock(return_value=0)
        mock_gsd_invoker_class.return_value = mock_invoker

        # Call endpoint
        await initialize_output_project(mock_websocket, "507f1f77bcf86cd799439011")

        # Verify PromptBuilder.write_context_file was called with connections
        mock_prompt_builder.write_context_file.assert_called_once()
        call_kwargs = mock_prompt_builder.write_context_file.call_args.kwargs
        assert call_kwargs["connections"] == mock_connections

    @patch("wxcode.api.output_projects.OutputProject")
    @patch("wxcode.api.output_projects.Stack")
    @patch("wxcode.api.output_projects.extract_schema_for_configuration")
    @patch("wxcode.api.output_projects.extract_connections_for_project")
    @patch("wxcode.api.output_projects.extract_global_state_for_project")
    @patch("wxcode.api.output_projects.PromptBuilder")
    @patch("wxcode.api.output_projects.GSDInvoker")
    async def test_passes_global_state_to_prompt_builder(
        self,
        mock_gsd_invoker_class,
        mock_prompt_builder,
        mock_extract_global_state,
        mock_extract_connections,
        mock_extract_schema,
        mock_stack_model,
        mock_output_project_model,
        mock_websocket,
        mock_output_project,
        mock_stack,
        mock_connections,
        mock_global_state,
        mock_tables,
    ):
        """Verify PromptBuilder.write_context_file receives global_state."""
        # Setup mocks
        mock_output_project_model.get = AsyncMock(return_value=mock_output_project)
        mock_stack_model.find_one = AsyncMock(return_value=mock_stack)
        mock_extract_schema.return_value = mock_tables
        mock_extract_connections.return_value = mock_connections
        mock_extract_global_state.return_value = mock_global_state
        mock_prompt_builder.write_context_file.return_value = Path(mock_output_project.workspace_path) / "CONTEXT.md"

        # Setup GSD invoker mock
        mock_invoker = MagicMock()
        mock_invoker.invoke_with_streaming = AsyncMock(return_value=0)
        mock_gsd_invoker_class.return_value = mock_invoker

        # Call endpoint
        await initialize_output_project(mock_websocket, "507f1f77bcf86cd799439011")

        # Verify PromptBuilder.write_context_file was called with global_state
        mock_prompt_builder.write_context_file.assert_called_once()
        call_kwargs = mock_prompt_builder.write_context_file.call_args.kwargs
        assert call_kwargs["global_state"] == mock_global_state
```

6. **Test Class `TestWebSocketInitializeContextFile`:**

```python
class TestWebSocketInitializeContextFile:
    """Tests that /initialize writes CONTEXT.md to workspace."""

    @patch("wxcode.api.output_projects.OutputProject")
    @patch("wxcode.api.output_projects.Stack")
    @patch("wxcode.api.output_projects.extract_schema_for_configuration")
    @patch("wxcode.api.output_projects.extract_connections_for_project")
    @patch("wxcode.api.output_projects.extract_global_state_for_project")
    @patch("wxcode.api.output_projects.PromptBuilder")
    @patch("wxcode.api.output_projects.GSDInvoker")
    async def test_writes_context_md_to_workspace(
        self,
        mock_gsd_invoker_class,
        mock_prompt_builder,
        mock_extract_global_state,
        mock_extract_connections,
        mock_extract_schema,
        mock_stack_model,
        mock_output_project_model,
        mock_websocket,
        mock_output_project,
        mock_stack,
        mock_connections,
        mock_global_state,
        mock_tables,
    ):
        """Verify CONTEXT.md path is derived from workspace_path."""
        # Setup mocks
        mock_output_project_model.get = AsyncMock(return_value=mock_output_project)
        mock_stack_model.find_one = AsyncMock(return_value=mock_stack)
        mock_extract_schema.return_value = mock_tables
        mock_extract_connections.return_value = mock_connections
        mock_extract_global_state.return_value = mock_global_state

        expected_context_path = Path(mock_output_project.workspace_path) / "CONTEXT.md"
        mock_prompt_builder.write_context_file.return_value = expected_context_path

        # Setup GSD invoker mock
        mock_invoker = MagicMock()
        mock_invoker.invoke_with_streaming = AsyncMock(return_value=0)
        mock_gsd_invoker_class.return_value = mock_invoker

        # Call endpoint
        await initialize_output_project(mock_websocket, "507f1f77bcf86cd799439011")

        # Verify workspace_path passed to write_context_file
        call_kwargs = mock_prompt_builder.write_context_file.call_args.kwargs
        assert call_kwargs["workspace_path"] == Path(mock_output_project.workspace_path)

    @patch("wxcode.api.output_projects.OutputProject")
    @patch("wxcode.api.output_projects.Stack")
    @patch("wxcode.api.output_projects.extract_schema_for_configuration")
    @patch("wxcode.api.output_projects.extract_connections_for_project")
    @patch("wxcode.api.output_projects.extract_global_state_for_project")
    @patch("wxcode.api.output_projects.PromptBuilder")
    @patch("wxcode.api.output_projects.GSDInvoker")
    async def test_websocket_reports_context_created(
        self,
        mock_gsd_invoker_class,
        mock_prompt_builder,
        mock_extract_global_state,
        mock_extract_connections,
        mock_extract_schema,
        mock_stack_model,
        mock_output_project_model,
        mock_websocket,
        mock_output_project,
        mock_stack,
        mock_connections,
        mock_global_state,
        mock_tables,
    ):
        """Verify WebSocket receives message about CONTEXT.md creation."""
        # Setup mocks
        mock_output_project_model.get = AsyncMock(return_value=mock_output_project)
        mock_stack_model.find_one = AsyncMock(return_value=mock_stack)
        mock_extract_schema.return_value = mock_tables
        mock_extract_connections.return_value = mock_connections
        mock_extract_global_state.return_value = mock_global_state

        context_path = Path(mock_output_project.workspace_path) / "CONTEXT.md"
        mock_prompt_builder.write_context_file.return_value = context_path

        # Setup GSD invoker mock
        mock_invoker = MagicMock()
        mock_invoker.invoke_with_streaming = AsyncMock(return_value=0)
        mock_gsd_invoker_class.return_value = mock_invoker

        # Call endpoint
        await initialize_output_project(mock_websocket, "507f1f77bcf86cd799439011")

        # Check WebSocket messages include CONTEXT.md creation
        info_messages = [m for m in mock_websocket.sent_messages if m.get("type") == "info"]
        context_messages = [m for m in info_messages if "CONTEXT.md" in m.get("message", "")]
        assert len(context_messages) >= 1, "Expected at least one message about CONTEXT.md"
```

Use `pytest.mark.asyncio` decorator on each test method.
  </action>
  <verify>
Run: `cd /Users/gilberto/projetos/wxk/wxcode && python -m pytest tests/integration/test_websocket_initialize.py -v`
All tests pass.
  </verify>
  <done>
All integration tests for WebSocket /initialize pass. Extractors called with correct parameters. Data passed to PromptBuilder. CONTEXT.md path uses workspace_path.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/gilberto/projetos/wxk/wxcode
python -m pytest tests/integration/test_websocket_initialize.py -v --tb=short
```

Expected: All tests pass, no failures.
</verification>

<success_criteria>
- [ ] Test file exists with 150+ lines
- [ ] All 3 test classes implemented
- [ ] extract_connections_for_project() call verified
- [ ] extract_global_state_for_project() call verified
- [ ] PromptBuilder receives connections and global_state
- [ ] workspace_path passed correctly
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-integration-testing/23-03-SUMMARY.md`
</output>
