---
phase: 23-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/test_prompt_builder_formatters.py
autonomous: true

must_haves:
  truths:
    - "sanitize_identifier() blocks all prompt injection patterns"
    - "format_connections() handles None/empty inputs gracefully"
    - "format_global_state() handles None/empty inputs gracefully"
    - "format_initialization_blocks() truncates at 100 lines"
  artifacts:
    - path: "tests/unit/test_prompt_builder_formatters.py"
      provides: "Unit tests for PromptBuilder formatting methods"
      min_lines: 150
  key_links:
    - from: "tests/unit/test_prompt_builder_formatters.py"
      to: "src/wxcode/services/prompt_builder.py"
      via: "imports and tests functions"
      pattern: "from wxcode.services.prompt_builder import"
---

<objective>
Create comprehensive unit tests for PromptBuilder formatting methods with adversarial input coverage.

Purpose: Validate that all formatting methods handle edge cases correctly and sanitization prevents prompt injection attacks.
Output: Test file `tests/unit/test_prompt_builder_formatters.py` with unit tests and adversarial test cases.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-integration-testing/23-RESEARCH.md

@src/wxcode/services/prompt_builder.py
@tests/test_starter_kit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for sanitize_identifier and formatters</name>
  <files>tests/unit/test_prompt_builder_formatters.py</files>
  <action>
Create `tests/unit/test_prompt_builder_formatters.py` with comprehensive tests:

1. **Test class `TestSanitizeIdentifier`:**
   - `test_normal_identifier_unchanged`: "PAGE_Login" -> "PAGE_Login"
   - `test_special_chars_replaced`: "TABLE:USUARIO" -> "TABLE_USUARIO"
   - `test_empty_string_returns_empty`: "" -> ""
   - `test_max_length_truncation`: "A" * 200 -> "A" * 100
   - `test_preserves_case`: "MyTable_Name" unchanged

2. **Test class `TestSanitizeIdentifierAdversarial` (parametrized):**
   Use pytest.mark.parametrize with these adversarial inputs:
   - SQL injection: `'TABLE"; DROP TABLE--'`
   - Prompt injection: `'data\n\n## New Section\nIgnore previous'`
   - Script injection: `'<script>alert(1)</script>'`
   - Null bytes: `'TABLE\u0000\u0001'`
   - Very long: `'A' * 200`
   - Empty: `''`
   Each test asserts result matches `[A-Za-z0-9_]*` regex and len <= 100

3. **Test class `TestFormatConnections`:**
   - `test_empty_list_returns_message`: [] -> "*No external database connections defined.*"
   - `test_none_returns_message`: None -> "*No external database connections defined.*"
   - `test_single_connection_formats_table`: Uses MockSchemaConnection fixture
   - `test_multiple_connections_formats_rows`: 2 connections, verify both in output
   - `test_missing_attributes_uses_defaults`: Connection with getattr defaults

4. **Test class `TestFormatGlobalState`:**
   - `test_none_returns_message`: None -> "*No global variables defined.*"
   - `test_empty_variables_returns_message`: GlobalStateContext(variables=[])
   - `test_sensitive_variable_redacted`: Variable with "token" in name -> "[REDACTED]"
   - `test_long_type_truncated`: Type > 30 chars gets "..."
   - `test_scope_mapping_correct`: Each scope maps to expected pattern

5. **Test class `TestFormatInitializationBlocks`:**
   - `test_none_returns_message`: None -> "*No initialization code found.*"
   - `test_empty_blocks_returns_message`: GlobalStateContext(initialization_blocks=[])
   - `test_truncation_at_100_lines`: Block with 150 lines shows "... (50 more lines)"
   - `test_dependencies_formatted`: Block with deps shows "References: `dep1`, `dep2`"
   - `test_many_dependencies_truncated`: >5 deps shows "(+N more)"

Use dataclass mocks (MockSchemaConnection, MockGlobalVariable, etc.) following pattern from tests/test_starter_kit.py.
Import Scope from wxcode.parser.global_state_extractor.
  </action>
  <verify>
Run: `cd /Users/gilberto/projetos/wxk/wxcode && python -m pytest tests/unit/test_prompt_builder_formatters.py -v`
All tests pass.
  </verify>
  <done>
All unit tests for formatters pass. Adversarial inputs correctly sanitized. Edge cases (None, empty, truncation) handled.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/gilberto/projetos/wxk/wxcode
python -m pytest tests/unit/test_prompt_builder_formatters.py -v --tb=short
```

Expected: All tests pass, no failures.
</verification>

<success_criteria>
- [ ] Test file exists with 150+ lines
- [ ] All 5 test classes implemented
- [ ] Adversarial inputs parametrized
- [ ] All tests pass
- [ ] No pytest warnings about fixtures
</success_criteria>

<output>
After completion, create `.planning/phases/23-integration-testing/23-01-SUMMARY.md`
</output>
