---
phase: 06-graph-analysis-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/mcp/tools/graph.py
  - src/wxcode/mcp/tools/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can retrieve direct dependencies (uses/used_by) for any element"
    - "User can analyze impact of changes to an element"
    - "User can find paths between two elements in the dependency graph"
  artifacts:
    - path: "src/wxcode/mcp/tools/graph.py"
      provides: "Core graph analysis MCP tools"
      exports: ["get_dependencies", "get_impact", "get_path"]
    - path: "src/wxcode/mcp/tools/__init__.py"
      provides: "Tool registration"
      contains: "from wxcode.mcp.tools import graph"
  key_links:
    - from: "src/wxcode/mcp/tools/graph.py"
      to: "ImpactAnalyzer"
      via: "import from wxcode.graph.impact_analyzer"
      pattern: "from wxcode.graph.impact_analyzer import ImpactAnalyzer"
    - from: "graph.py tools"
      to: "lifespan context"
      via: "ctx.request_context.lifespan_context"
      pattern: "ctx\\.request_context\\.lifespan_context"
---

<objective>
Implement core graph analysis MCP tools for Neo4j dependency queries.

Purpose: Enable Claude Code to analyze element dependencies, change impact, and relationship paths directly through MCP tools without CLI.

Output:
- `graph.py` with 3 tools: get_dependencies, get_impact, get_path
- `_check_neo4j` helper for Neo4j availability checking
- Updated `tools/__init__.py` to register graph module
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-graph-analysis-tools/06-RESEARCH.md
@src/wxcode/graph/impact_analyzer.py
@src/wxcode/mcp/tools/elements.py
@src/wxcode/mcp/tools/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create graph.py with helper and 3 core tools</name>
  <files>src/wxcode/mcp/tools/graph.py</files>
  <action>
Create `graph.py` with MCP tools for Neo4j graph analysis.

**Helper function:**
- `_check_neo4j(ctx: Context) -> tuple[Neo4jConnection | None, dict | None]`
  - Check `ctx.request_context.lifespan_context.get("neo4j_available", False)`
  - If unavailable, return `(None, error_dict)` with code "NEO4J_UNAVAILABLE"
  - Include suggestion to start Neo4j with docker command
  - If available, return `(ctx.request_context.lifespan_context["neo4j_conn"], None)`

**Tool 1: get_dependencies**
- Parameters: `element_name: str`, `direction: str = "both"`, `project_name: str | None = None`
- Direction options: "uses" (outgoing), "used_by" (incoming), "both"
- Custom Cypher for direct 1-hop relationships (NOT transitive)
- Return format: `{"error": False, "element": "...", "uses": [...], "used_by": [...]}`
- Each dependency: `{"name": "...", "type": "...", "relationship": "..."}`

**Tool 2: get_impact**
- Parameters: `element_name: str`, `max_depth: int = 5`, `project_name: str | None = None`
- Wrap `ImpactAnalyzer(conn).get_impact(node_id=element_name, max_depth=max_depth, project=project_name)`
- Handle `result.error` with code "NOT_FOUND"
- Convert dataclass to dict: source_name, source_type, total_affected, max_depth, affected list, by_depth, by_type

**Tool 3: get_path**
- Parameters: `source: str`, `target: str`, `project_name: str | None = None`
- Wrap `ImpactAnalyzer(conn).get_path(source, target, project=project_name)`
- Handle `result.error` with code "NO_PATH"
- Return: source, target, path_count, shortest_length, paths list

**Follow established patterns from Phase 5:**
- Use `@mcp.tool` decorator from `wxcode.mcp.server`
- Return `{"error": True, "code": "...", "message": "..."}` on errors
- Catch all exceptions with INTERNAL_ERROR code
- Docstrings with Args and Returns sections

Reference: 06-RESEARCH.md has complete implementation templates for all tools.
  </action>
  <verify>
    python -c "from wxcode.mcp.tools import graph; print('Tools:', [t for t in dir(graph) if not t.startswith('_')])"
  </verify>
  <done>
    graph.py exists with get_dependencies, get_impact, get_path tools registered
  </done>
</task>

<task type="auto">
  <name>Task 2: Register graph module in tools __init__.py</name>
  <files>src/wxcode/mcp/tools/__init__.py</files>
  <action>
Update `tools/__init__.py` to import and register the graph module.

**Changes:**
1. Add docstring entry: `- graph: get_dependencies, get_impact, get_path, find_hubs, find_dead_code, find_cycles`
2. Add import: `from wxcode.mcp.tools import graph  # noqa: F401`
3. Update `__all__`: `["elements", "controls", "procedures", "schema", "graph"]`

Note: Include all 6 tools in docstring even though only 3 implemented now (06-02 adds the rest). This matches Phase 5 pattern where init documents the full module capability.
  </action>
  <verify>
    python -c "from wxcode.mcp import tools; print('Modules:', tools.__all__)"
  </verify>
  <done>
    graph module registered in __all__, import executes without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify MCP server starts with new tools</name>
  <files></files>
  <action>
Verify MCP server starts correctly with the 3 new graph tools registered.

**Commands to run:**
1. `python -m wxcode.mcp.server --help` (or minimal startup test)
2. Check that tools are discoverable via Python import

**Validation:**
- No import errors
- Tools registered with mcp.tool decorator
- Total tool count should be 12 (9 from Phase 5 + 3 new)

If Neo4j unavailable: This is OK - tools should handle gracefully with error response.
  </action>
  <verify>
    python -c "from wxcode.mcp.server import mcp; from wxcode.mcp.tools import graph; print('Server ready')"
  </verify>
  <done>
    MCP server loads all 12 tools without errors, ready to handle requests
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Verify tool imports
python -c "
from wxcode.mcp.tools.graph import get_dependencies, get_impact, get_path
print('Core graph tools imported successfully')
"

# Verify module registration
python -c "
from wxcode.mcp import tools
assert 'graph' in tools.__all__
print('Graph module registered')
"

# Verify server loads (does not require Neo4j)
python -c "
from wxcode.mcp.server import mcp
from wxcode.mcp import tools
print('MCP server with graph tools ready')
"
```
</verification>

<success_criteria>
- [ ] `graph.py` exists with `_check_neo4j` helper and 3 tools
- [ ] `get_dependencies` returns direct uses/used_by relationships
- [ ] `get_impact` wraps ImpactAnalyzer.get_impact with dataclass-to-dict conversion
- [ ] `get_path` wraps ImpactAnalyzer.get_path with path formatting
- [ ] All tools return structured error when Neo4j unavailable
- [ ] `tools/__init__.py` imports and registers graph module
- [ ] MCP server starts without errors (12 total tools)
</success_criteria>

<output>
After completion, create `.planning/phases/06-graph-analysis-tools/06-01-SUMMARY.md`
</output>
