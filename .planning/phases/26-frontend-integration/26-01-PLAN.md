---
phase: 26-frontend-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/types/terminal.ts
  - frontend/src/types/index.ts
  - frontend/src/hooks/useTerminalWebSocket.ts
  - frontend/src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match backend Pydantic protocol exactly"
    - "Hook connects to /api/milestones/{id}/terminal endpoint"
    - "Hook exposes sendInput, sendResize, sendSignal methods"
    - "Hook reports connection status and session ID"
  artifacts:
    - path: "frontend/src/types/terminal.ts"
      provides: "Terminal message type definitions"
      exports: ["TerminalInputMessage", "TerminalResizeMessage", "TerminalSignalMessage", "TerminalOutputMessage", "TerminalStatusMessage", "TerminalErrorMessage", "TerminalClosedMessage", "OutgoingTerminalMessage", "IncomingTerminalMessage"]
    - path: "frontend/src/hooks/useTerminalWebSocket.ts"
      provides: "WebSocket hook for terminal bidirectional communication"
      exports: ["useTerminalWebSocket", "UseTerminalWebSocketOptions", "UseTerminalWebSocketReturn"]
  key_links:
    - from: "frontend/src/hooks/useTerminalWebSocket.ts"
      to: "/api/milestones/{id}/terminal"
      via: "WebSocket connection"
      pattern: "milestones.*terminal"
    - from: "frontend/src/types/terminal.ts"
      to: "src/wxcode/models/terminal_messages.py"
      via: "Type mirroring"
      pattern: "type.*input|output|resize|signal|status|error|closed"
---

<objective>
Create TypeScript types and WebSocket hook for terminal bidirectional communication.

Purpose: Establish the foundation for frontend-backend terminal communication by defining type-safe message structures and a reusable hook that follows existing project patterns (similar to useConversionStream).

Output: Types and hook that can be consumed by InteractiveTerminal component.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-frontend-integration/26-RESEARCH.md
@src/wxcode/models/terminal_messages.py
@frontend/src/hooks/useConversionStream.ts
@frontend/src/types/index.ts
@frontend/src/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create terminal message types</name>
  <files>frontend/src/types/terminal.ts, frontend/src/types/index.ts</files>
  <action>
Create `frontend/src/types/terminal.ts` with TypeScript types that mirror the backend Pydantic models in `src/wxcode/models/terminal_messages.py`.

**Types to create (mirroring backend exactly):**

Outgoing (client -> server):
- `TerminalInputMessage`: `{ type: "input"; data: string }`
- `TerminalResizeMessage`: `{ type: "resize"; rows: number; cols: number }`
- `TerminalSignalMessage`: `{ type: "signal"; signal: "SIGINT" | "SIGTERM" | "EOF" }`
- `OutgoingTerminalMessage`: union of above 3

Incoming (server -> client):
- `TerminalOutputMessage`: `{ type: "output"; data: string }`
- `TerminalStatusMessage`: `{ type: "status"; connected: boolean; session_id: string | null }`
- `TerminalErrorMessage`: `{ type: "error"; message: string; code: string | null }`
- `TerminalClosedMessage`: `{ type: "closed"; exit_code: number | null }`
- `IncomingTerminalMessage`: union of above 4

**Update `frontend/src/types/index.ts`:**
Add `export * from "./terminal";` line.

**Notes:**
- Use Literal types for discriminator fields (e.g., `type: "input"`)
- Match backend field names exactly (snake_case: session_id, exit_code)
- Add JSDoc comments explaining each type's purpose
  </action>
  <verify>Run `npx tsc --noEmit` in frontend directory - no type errors</verify>
  <done>Types file exists with all 8 message types and union types, index.ts re-exports them</done>
</task>

<task type="auto">
  <name>Task 2: Create useTerminalWebSocket hook</name>
  <files>frontend/src/hooks/useTerminalWebSocket.ts, frontend/src/hooks/index.ts</files>
  <action>
Create `frontend/src/hooks/useTerminalWebSocket.ts` following the pattern established by `useConversionStream.ts`.

**Hook signature:**
```typescript
export interface UseTerminalWebSocketOptions {
  onOutput?: (data: string) => void;
  onStatus?: (connected: boolean, sessionId: string | null) => void;
  onError?: (message: string, code: string | null) => void;
  onClosed?: (exitCode: number | null) => void;
  autoConnect?: boolean;  // default: false (connect after terminal mount)
}

export interface UseTerminalWebSocketReturn {
  isConnected: boolean;
  sessionId: string | null;
  connect: () => void;
  disconnect: () => void;
  sendInput: (data: string) => void;
  sendResize: (rows: number, cols: number) => void;
  sendSignal: (signal: "SIGINT" | "SIGTERM" | "EOF") => void;
}

export function useTerminalWebSocket(
  milestoneId: string | null,
  options?: UseTerminalWebSocketOptions
): UseTerminalWebSocketReturn
```

**Implementation details:**

1. **WebSocket URL construction:**
   ```typescript
   const apiUrl = process.env.NEXT_PUBLIC_API_URL || "http://127.0.0.1:8035";
   const wsProtocol = apiUrl.startsWith("https") ? "wss:" : "ws:";
   const apiHost = apiUrl.replace(/^https?:\/\//, "");
   const wsUrl = `${wsProtocol}//${apiHost}/api/milestones/${milestoneId}/terminal`;
   ```

2. **State:**
   - `wsRef = useRef<WebSocket | null>(null)`
   - `isConnected = useState(false)`
   - `sessionId = useState<string | null>(null)`

3. **Callbacks stored in ref** to avoid recreating connect function:
   ```typescript
   const callbacksRef = useRef(options);
   callbacksRef.current = options;
   ```

4. **connect():**
   - Guard: if milestoneId is null, return
   - Guard: if already connecting/connected, return
   - Create WebSocket, set handlers
   - onmessage: parse JSON, switch on msg.type, call appropriate callback
   - onopen: setIsConnected(true)
   - onclose: setIsConnected(false), setSessionId(null)
   - onerror: log error

5. **disconnect():**
   - Close WebSocket if open
   - Clear state

6. **sendInput(data):**
   ```typescript
   if (wsRef.current?.readyState === WebSocket.OPEN) {
     wsRef.current.send(JSON.stringify({ type: "input", data }));
   }
   ```

7. **sendResize(rows, cols):**
   ```typescript
   if (wsRef.current?.readyState === WebSocket.OPEN) {
     wsRef.current.send(JSON.stringify({ type: "resize", rows, cols }));
   }
   ```

8. **sendSignal(signal):**
   ```typescript
   if (wsRef.current?.readyState === WebSocket.OPEN) {
     wsRef.current.send(JSON.stringify({ type: "signal", signal }));
   }
   ```

9. **Cleanup on unmount:**
   ```typescript
   useEffect(() => {
     return () => disconnect();
   }, [disconnect]);
   ```

10. **Auto-connect if enabled:**
    ```typescript
    useEffect(() => {
      if (autoConnect && milestoneId) {
        connect();
      }
    }, [autoConnect, milestoneId, connect]);
    ```

**Update `frontend/src/hooks/index.ts`:**
Add export for useTerminalWebSocket and its types.

**Important patterns from useConversionStream.ts to follow:**
- Use `isConnectingRef` to prevent double connections
- Store callbacks in ref to avoid stale closures
- Log connection events with console.log for debugging
- Use "use client" directive at top
  </action>
  <verify>Run `npx tsc --noEmit` in frontend directory - no type errors. Check hook is exported in index.ts.</verify>
  <done>Hook file exists with connect/disconnect/send methods, properly typed, exported from hooks/index.ts</done>
</task>

</tasks>

<verification>
1. Type check: `cd frontend && npx tsc --noEmit` - should pass
2. Verify types match backend: Compare terminal.ts types with terminal_messages.py models
3. Verify hook follows project patterns: Similar structure to useConversionStream.ts
4. Verify exports: Import { useTerminalWebSocket } from "@/hooks" works
</verification>

<success_criteria>
- terminal.ts exports 8 message types + 2 union types
- useTerminalWebSocket hook compiles without errors
- Hook exposes: isConnected, sessionId, connect, disconnect, sendInput, sendResize, sendSignal
- Types are re-exported from types/index.ts
- Hook is re-exported from hooks/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/26-frontend-integration/26-01-SUMMARY.md`
</output>
