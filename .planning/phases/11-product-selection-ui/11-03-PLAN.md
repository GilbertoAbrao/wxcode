---
phase: 11-product-selection-ui
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - frontend/src/app/project/[id]/factory/page.tsx
  - frontend/src/app/project/[id]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'O que vamos criar juntos?' heading on factory page"
    - "User sees all 4 product cards with availability status"
    - "User sees list of existing products they have created (UI-04)"
    - "Clicking conversion card creates product and navigates to wizard"
    - "User can navigate to factory via 'Produtos' sidebar item"
  artifacts:
    - path: "frontend/src/app/project/[id]/factory/page.tsx"
      provides: "Product selection page with existing products list"
      min_lines: 80
    - path: "frontend/src/app/project/[id]/layout.tsx"
      provides: "Sidebar with Produtos item"
      contains: "Produtos"
  key_links:
    - from: "frontend/src/app/project/[id]/factory/page.tsx"
      to: "useProducts hook"
      via: "import and call with project.id (ObjectId)"
      pattern: "useProducts\\(project\\?\\.id\\)"
    - from: "frontend/src/app/project/[id]/factory/page.tsx"
      to: "ProductGrid component"
      via: "import from @/components/product"
      pattern: "import.*ProductGrid"
    - from: "frontend/src/app/project/[id]/factory/page.tsx"
      to: "useCreateProduct hook"
      via: "createProduct.mutateAsync call in handleSelectProduct"
      pattern: "createProduct\\.mutateAsync"
    - from: "frontend/src/app/project/[id]/layout.tsx"
      to: "factory route"
      via: "href in sidebarSections"
      pattern: "href.*factory"
---

<objective>
Create the Product Factory page and add navigation to project sidebar.

Purpose: Enable users to select new products and view existing ones after import.
Output: Fully functional product selection experience with created products list (UI-04).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-product-selection-ui/11-RESEARCH.md

# Existing page pattern
@frontend/src/app/project/[id]/page.tsx
@frontend/src/app/project/[id]/layout.tsx

# Components from Plan 02 (will exist after Plan 02 executes)
@frontend/src/components/product/ProductGrid.tsx
@frontend/src/components/product/ProductCard.tsx

# Hooks from Plan 01 (will exist after Plan 01 executes)
@frontend/src/hooks/useProducts.ts
@frontend/src/hooks/useProject.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create factory page with product selection and existing products list</name>
  <files>frontend/src/app/project/[id]/factory/page.tsx</files>
  <action>
Create `frontend/src/app/project/[id]/factory/page.tsx`:

1. "use client" directive at top

2. Imports:
   - use from "react"
   - useRouter from "next/navigation"
   - useProject from "@/hooks/useProject"
   - useProducts, useCreateProduct from "@/hooks/useProducts"
   - ProductGrid from "@/components/product"
   - Loader2, Package, ArrowRight from "lucide-react"
   - Link from "next/link"

3. Define PageProps interface (same as other project pages):
   ```typescript
   interface PageProps {
     params: Promise<{ id: string }>;
   }
   ```

4. Implement FactoryPage component:

   a. Extract projectId using `use(params)` - this is the project NAME from URL
   b. Get project data with useProject(projectId)
   c. Get products with useProducts(project?.id)
      CRITICAL: Pass project.id (the MongoDB ObjectId string), NOT projectId (the name)
      The useProducts hook expects the ObjectId to query /api/products?project_id={id}
   d. Get createProduct mutation with useCreateProduct()
   e. Setup router for navigation

   f. Handle loading state:
      - Show centered Loader2 spinner while project or products loading

   g. Handle product selection:
      ```typescript
      const handleSelectProduct = async (productType: ProductType) => {
        if (!project?.id) return;

        // Check if product already exists
        const existing = products?.products.find(p => p.product_type === productType);
        if (existing) {
          // Navigate to existing product
          router.push(`/project/${projectId}/products/${existing.id}`);
          return;
        }

        // Create new product via API
        const newProduct = await createProduct.mutateAsync({
          project_id: project.id,  // ObjectId, not name
          product_type: productType,
        });

        // Navigate to product wizard (wizard route created in Phase 12)
        router.push(`/project/${projectId}/products/${newProduct.id}`);
      };
      ```

   h. Render page content in TWO sections:

      SECTION 1 - Product Selection (new products):
      - Header with "O que vamos criar juntos?" heading (text-3xl font-bold text-zinc-100)
      - Subtitle: "Escolha um produto para comecar" (text-zinc-400)
      - ProductGrid with existingProducts and onSelectProduct handler

      SECTION 2 - Existing Products List (UI-04 requirement):
      - Only render if products?.products.length > 0
      - Header: "Produtos criados" (text-xl font-semibold text-zinc-100)
      - List of existing products as clickable cards:
        ```typescript
        {products?.products.map((product) => (
          <Link
            key={product.id}
            href={`/project/${projectId}/products/${product.id}`}
            className="flex items-center justify-between p-4 bg-zinc-900/50 rounded-lg border border-zinc-800 hover:border-zinc-700 transition-colors"
          >
            <div className="flex items-center gap-3">
              <Package className="h-5 w-5 text-zinc-400" />
              <div>
                <p className="text-zinc-100 font-medium">{product.product_type}</p>
                <p className="text-sm text-zinc-400">Status: {product.status}</p>
              </div>
            </div>
            <ArrowRight className="h-4 w-4 text-zinc-500" />
          </Link>
        ))}
        ```

5. Layout:
   - Container: max-w-4xl mx-auto p-8
   - Section 1 (selection): mb-12
   - Section 2 (existing): mt-8 border-t border-zinc-800 pt-8
   - Use bg-zinc-950 if not inherited from layout

6. Export as default function FactoryPage

NOTE: The product wizard route (/project/{id}/products/{productId}) will be created in Phase 12.
For now, the navigation will lead to a 404, which is expected.
  </action>
  <verify>
    - File exists at frontend/src/app/project/[id]/factory/page.tsx
    - Contains "O que vamos criar juntos?"
    - Contains "Produtos criados" section header (UI-04 requirement)
    - Contains useProducts(project?.id) - passing ObjectId, not name
    - Contains ProductGrid component
    - Contains handleSelectProduct function with createProduct.mutateAsync call
    - grep -n "createProduct.mutateAsync" shows product creation logic
  </verify>
  <done>Factory page displays product selection and existing products list (UI-04)</done>
</task>

<task type="auto">
  <name>Task 2: Add Produtos to sidebar navigation</name>
  <files>frontend/src/app/project/[id]/layout.tsx</files>
  <action>
Modify `frontend/src/app/project/[id]/layout.tsx`:

1. Import the Package icon from lucide-react (represents products/packages):
   - Add Package to the existing lucide-react import

2. Find the sidebarSections array (around line 32-56)

3. Add "Produtos" item to the "Navegacao" section, after "Conversoes":
   ```typescript
   {
     id: "produtos",
     label: "Produtos",
     href: `/project/${projectId}/factory`,
     icon: Package,
   },
   ```

   The order should be:
   1. Workspace
   2. Grafo
   3. Conversoes
   4. Produtos (NEW)

This enables users to return to product selection from anywhere in the project.
  </action>
  <verify>
    - File contains Package import
    - File contains "Produtos" label
    - File contains href with /factory
    - grep -A2 "Produtos" frontend/src/app/project/[id]/layout.tsx shows the item
  </verify>
  <done>Sidebar shows Produtos navigation item linking to factory</done>
</task>

</tasks>

<verification>
- Factory page renders at /project/{name}/factory
- Factory page shows "O que vamos criar juntos?" heading
- Factory page displays ProductGrid with 4 product cards
- Factory page shows "Produtos criados" section with existing products (UI-04)
- Clicking conversion card calls createProduct.mutateAsync and navigates
- Sidebar shows "Produtos" item that links to factory page
- TypeScript compiles: `cd frontend && npx tsc --noEmit`
</verification>

<success_criteria>
- After import completion, user lands on factory page (via redirect from Plan 01)
- Factory page displays "O que vamos criar juntos?" heading
- 4 product cards visible: Conversion (enabled), API/MCP/Agents (disabled with "Em breve")
- Existing products shown in "Produtos criados" list (UI-04 requirement)
- Clicking Conversion creates product in backend and navigates to product page
- Project sidebar includes "Produtos" item for returning to factory
</success_criteria>

<output>
After completion, create `.planning/phases/11-product-selection-ui/11-03-SUMMARY.md`
</output>
