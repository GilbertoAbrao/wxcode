---
phase: 15-stack-configuration
plan: 04
type: execute
wave: 2
depends_on: ["15-01", "15-02", "15-03"]
files_modified:
  - src/wxcode/services/stack_service.py
  - src/wxcode/services/__init__.py
autonomous: true

must_haves:
  truths:
    - "StackService can load all YAML files from data/stacks/"
    - "seed_stacks() upserts stacks to MongoDB"
    - "get_stack_by_id() retrieves a single stack"
    - "list_stacks() supports filtering by group and language"
    - "get_stacks_grouped() returns stacks organized by group"
  artifacts:
    - path: "src/wxcode/services/stack_service.py"
      provides: "Stack management service"
      exports: ["seed_stacks", "get_stack_by_id", "list_stacks", "get_stacks_grouped"]
      min_lines: 80
    - path: "src/wxcode/services/__init__.py"
      provides: "Service exports"
      contains: "from wxcode.services.stack_service"
  key_links:
    - from: "src/wxcode/services/stack_service.py"
      to: "src/wxcode/data/stacks/"
      via: "pathlib.rglob('*.yaml')"
      pattern: "STACKS_DATA_DIR.*rglob"
    - from: "src/wxcode/services/stack_service.py"
      to: "src/wxcode/models/stack.py"
      via: "Beanie ODM"
      pattern: "Stack\\.find|Stack\\.find_one|Stack.*insert"
---

<objective>
Create the StackService that loads YAML configurations and provides query methods.

Purpose: The StackService bridges YAML files on disk with MongoDB, enabling runtime queries for stack metadata. It seeds the database on startup and provides filtering/grouping for the stack selection UI.

Output: src/wxcode/services/stack_service.py with seed_stacks(), get_stack_by_id(), list_stacks(), get_stacks_grouped()
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-stack-configuration/15-RESEARCH.md
@src/wxcode/models/stack.py
@src/wxcode/services/project_service.py
@src/wxcode/services/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stack_service.py</name>
  <files>src/wxcode/services/stack_service.py</files>
  <action>
Create `src/wxcode/services/stack_service.py` following the project's service patterns (see project_service.py for reference).

**Required functions:**

```python
"""
Stack configuration service.

Loads stack YAML files from data/stacks/ and provides query methods.
Stacks are seeded to MongoDB on application startup for runtime querying.
"""
import logging
from pathlib import Path
from typing import Optional

import yaml

from wxcode.models import Stack

logger = logging.getLogger(__name__)

# Path to stack configuration files
STACKS_DATA_DIR = Path(__file__).parent.parent / "data" / "stacks"


async def seed_stacks(force: bool = False) -> int:
    """
    Seed all stack configurations from YAML files to MongoDB.

    Uses upsert pattern: updates existing stacks, creates new ones.
    Called on application startup to ensure MongoDB has latest configs.

    Args:
        force: If True, always update even if stack exists unchanged

    Returns:
        Number of stacks seeded
    """
    # Implementation:
    # 1. Check if STACKS_DATA_DIR exists
    # 2. Iterate over all *.yaml files using rglob
    # 3. For each file:
    #    a. Load YAML with yaml.safe_load()
    #    b. Validate stack_id exists
    #    c. Find existing stack by stack_id
    #    d. If exists: update fields with setattr + save()
    #    e. If not exists: create new Stack and insert()
    # 4. Log count and return


async def get_stack_by_id(stack_id: str) -> Optional[Stack]:
    """
    Get a stack by its unique identifier.

    Args:
        stack_id: Unique stack identifier (e.g., "fastapi-htmx")

    Returns:
        Stack document if found, None otherwise
    """
    return await Stack.find_one(Stack.stack_id == stack_id)


async def list_stacks(
    group: Optional[str] = None,
    language: Optional[str] = None,
) -> list[Stack]:
    """
    List stacks with optional filtering.

    Args:
        group: Filter by group ("server-rendered", "spa", "fullstack")
        language: Filter by primary language ("python", "typescript", etc.)

    Returns:
        List of matching Stack documents
    """
    # Build query dict based on provided filters
    # Return Stack.find(query).to_list() or Stack.find_all().to_list()


async def get_stacks_grouped() -> dict[str, list[Stack]]:
    """
    Get all stacks organized by their group.

    Returns:
        Dict with keys: "server-rendered", "spa", "fullstack"
        Each value is a list of Stack documents in that group.
    """
    all_stacks = await Stack.find_all().to_list()

    grouped = {
        "server-rendered": [],
        "spa": [],
        "fullstack": [],
    }

    for stack in all_stacks:
        if stack.group in grouped:
            grouped[stack.group].append(stack)

    return grouped
```

**Implementation details for seed_stacks:**

```python
async def seed_stacks(force: bool = False) -> int:
    if not STACKS_DATA_DIR.exists():
        logger.warning(f"Stacks data directory not found: {STACKS_DATA_DIR}")
        return 0

    count = 0
    for yaml_file in STACKS_DATA_DIR.rglob("*.yaml"):
        try:
            with open(yaml_file, encoding="utf-8") as f:
                data = yaml.safe_load(f)

            if not data or "stack_id" not in data:
                logger.warning(f"Invalid stack file (missing stack_id): {yaml_file}")
                continue

            stack_id = data["stack_id"]
            existing = await Stack.find_one(Stack.stack_id == stack_id)

            if existing:
                # Update existing stack
                for key, value in data.items():
                    setattr(existing, key, value)
                await existing.save()
                logger.debug(f"Updated stack: {stack_id}")
            else:
                # Create new stack
                stack = Stack(**data)
                await stack.insert()
                logger.debug(f"Created stack: {stack_id}")

            count += 1

        except yaml.YAMLError as e:
            logger.error(f"YAML parse error in {yaml_file}: {e}")
        except Exception as e:
            logger.error(f"Error loading stack {yaml_file}: {e}")

    logger.info(f"Seeded {count} stacks from {STACKS_DATA_DIR}")
    return count
```

**Error handling:**
- Log warnings for missing directory (don't fail - allows tests without YAML files)
- Log warnings for invalid YAML files (missing stack_id)
- Log errors for YAML parse failures
- Continue processing other files on individual failures
  </action>
  <verify>
    # Check file exists with required functions
    grep -E "^async def (seed_stacks|get_stack_by_id|list_stacks|get_stacks_grouped)" src/wxcode/services/stack_service.py
    # Should show all 4 function definitions

    # Verify imports
    python -c "from wxcode.services.stack_service import seed_stacks, get_stack_by_id, list_stacks, get_stacks_grouped"
    # Should complete without import errors
  </verify>
  <done>stack_service.py created with all required functions</done>
</task>

<task type="auto">
  <name>Task 2: Export StackService functions</name>
  <files>src/wxcode/services/__init__.py</files>
  <action>
Update `src/wxcode/services/__init__.py` to export the new stack service functions.

Add imports:
```python
from wxcode.services.stack_service import (
    seed_stacks,
    get_stack_by_id,
    list_stacks,
    get_stacks_grouped,
)
```

Add to __all__:
```python
__all__ = [
    # ... existing exports ...
    # Stack service
    "seed_stacks",
    "get_stack_by_id",
    "list_stacks",
    "get_stacks_grouped",
]
```

The current __init__.py has:
- purge_project, purge_project_by_name, check_duplicate_projects, PurgeStats
- ConversionExecutor, ConversionExecutionResult
- WorkspaceManager

Add the stack service exports alongside these.
  </action>
  <verify>
    # Verify exports work
    python -c "from wxcode.services import seed_stacks, get_stack_by_id, list_stacks, get_stacks_grouped; print('OK')"
    # Should output: OK
  </verify>
  <done>Stack service functions exported from services package</done>
</task>

</tasks>

<verification>
1. stack_service.py exists with all 4 functions
2. Functions can be imported from wxcode.services
3. STACKS_DATA_DIR points to correct path
4. seed_stacks uses upsert pattern (update existing, create new)
</verification>

<success_criteria>
- src/wxcode/services/stack_service.py created
- 4 functions: seed_stacks, get_stack_by_id, list_stacks, get_stacks_grouped
- Functions exported from services/__init__.py
- Follows project service patterns (logging, async, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/15-stack-configuration/15-04-SUMMARY.md`
</output>
