---
phase: 15-stack-configuration
plan: 05
type: execute
wave: 3
depends_on: ["15-04"]
files_modified:
  - src/wxcode/main.py
  - src/wxcode/cli.py
autonomous: true

must_haves:
  truths:
    - "Stacks are seeded on FastAPI application startup"
    - "CLI command 'wxcode seed-stacks' manually triggers seeding"
    - "Application starts successfully with stack seeding"
    - "CLI command reports number of stacks seeded"
  artifacts:
    - path: "src/wxcode/main.py"
      provides: "FastAPI app with stack seeding on startup"
      contains: "seed_stacks"
    - path: "src/wxcode/cli.py"
      provides: "CLI with seed-stacks command"
      contains: "seed-stacks"
  key_links:
    - from: "src/wxcode/main.py"
      to: "src/wxcode/services/stack_service.py"
      via: "lifespan import and call"
      pattern: "from wxcode.services import seed_stacks|await seed_stacks"
    - from: "src/wxcode/cli.py"
      to: "src/wxcode/services/stack_service.py"
      via: "CLI command import"
      pattern: "seed_stacks"
---

<objective>
Integrate stack seeding into application startup and add CLI command.

Purpose: Stacks must be seeded to MongoDB before the application can serve stack-related queries. The startup integration ensures data consistency, while the CLI command allows manual refresh during development or troubleshooting.

Output: Updated main.py with startup seeding, updated cli.py with seed-stacks command
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-stack-configuration/15-RESEARCH.md
@src/wxcode/main.py
@src/wxcode/cli.py
@src/wxcode/services/stack_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stack seeding to FastAPI startup</name>
  <files>src/wxcode/main.py</files>
  <action>
Update `src/wxcode/main.py` to seed stacks during application startup.

**Current lifespan function:**
```python
@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
    """Gerencia conexão com banco de dados."""
    # Startup
    client = await init_db()
    app.state.db_client = client

    yield

    # Shutdown
    await close_db(client)
```

**Updated lifespan function:**
```python
from wxcode.services import seed_stacks

@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
    """Gerencia conexão com banco de dados e inicializa dados."""
    # Startup
    client = await init_db()
    app.state.db_client = client

    # Seed stack configurations from YAML files
    try:
        stack_count = await seed_stacks()
        # Log is already done inside seed_stacks, but we can add app-level log
        import logging
        logger = logging.getLogger(__name__)
        logger.info(f"Application startup: {stack_count} stacks loaded")
    except Exception as e:
        import logging
        logger = logging.getLogger(__name__)
        logger.warning(f"Failed to seed stacks (non-critical): {e}")

    yield

    # Shutdown
    await close_db(client)
```

**Key points:**
1. Add import for seed_stacks at top of file
2. Call seed_stacks() after init_db() (Beanie must be initialized first)
3. Wrap in try/except - stack seeding failure should NOT prevent app startup
4. Log the result for visibility

**Alternative simpler approach (recommended):**
```python
from wxcode.services import seed_stacks

@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
    """Gerencia conexão com banco de dados e inicializa dados."""
    # Startup
    client = await init_db()
    app.state.db_client = client

    # Seed stack configurations (non-blocking on failure)
    await seed_stacks()

    yield

    # Shutdown
    await close_db(client)
```

The simpler approach works because seed_stacks() already handles errors internally with logging.
  </action>
  <verify>
    # Verify import was added
    grep "from wxcode.services import.*seed_stacks" src/wxcode/main.py || grep "from wxcode.services.stack_service import seed_stacks" src/wxcode/main.py
    # Should find the import

    # Verify seed_stacks is called in lifespan
    grep "await seed_stacks" src/wxcode/main.py
    # Should find the call

    # Test application starts
    timeout 5 python -c "import asyncio; from wxcode.main import app; print('App created successfully')" || echo "Timeout OK - app would start"
  </verify>
  <done>FastAPI app seeds stacks on startup</done>
</task>

<task type="auto">
  <name>Task 2: Add seed-stacks CLI command</name>
  <files>src/wxcode/cli.py</files>
  <action>
Add a `seed-stacks` command to the CLI in `src/wxcode/cli.py`.

**Find the CLI app (likely uses Typer):**
Look for the main typer.Typer() instance, typically named `app` or `cli`.

**Add the new command:**
```python
@app.command("seed-stacks")
def seed_stacks_command(
    force: bool = typer.Option(False, "--force", "-f", help="Re-seed all stacks even if unchanged"),
    verbose: bool = typer.Option(False, "--verbose", "-v", help="Show detailed output"),
):
    """
    Seed stack configurations from YAML files to MongoDB.

    Reads all YAML files from src/wxcode/data/stacks/ and upserts
    them to the MongoDB stacks collection. Run this after modifying
    stack YAML files to update the database.

    Examples:
        wxcode seed-stacks
        wxcode seed-stacks --force
        wxcode seed-stacks -v
    """
    import asyncio
    from wxcode.database import init_db, close_db
    from wxcode.services import seed_stacks

    async def run():
        client = await init_db()
        try:
            count = await seed_stacks(force=force)
            if verbose:
                typer.echo(f"Seeded {count} stacks from YAML files")
            else:
                typer.echo(f"{count} stacks seeded")
        finally:
            await close_db(client)

    asyncio.run(run())
```

**Placement:**
- Add after other existing commands
- Group with other data management commands if they exist

**Styling:**
- Use typer.echo() for output (consistent with other CLI commands)
- Use green for success if other commands use colors
- Match the existing command style in the file
  </action>
  <verify>
    # Verify command exists
    grep -A 5 "seed-stacks" src/wxcode/cli.py
    # Should show the command definition

    # Test command help
    python -m wxcode.cli seed-stacks --help 2>/dev/null || wxcode seed-stacks --help
    # Should show help text
  </verify>
  <done>CLI command 'wxcode seed-stacks' available</done>
</task>

<task type="auto">
  <name>Task 3: Verify integration end-to-end</name>
  <files>None (verification only)</files>
  <action>
Run verification tests to ensure the complete integration works:

1. **Verify YAML files exist:**
   ```bash
   ls src/wxcode/data/stacks/*/*.yaml | wc -l
   # Should output 15
   ```

2. **Verify all YAML files are valid:**
   ```bash
   python -c "
import yaml
from pathlib import Path
stacks_dir = Path('src/wxcode/data/stacks')
count = 0
for f in stacks_dir.rglob('*.yaml'):
    data = yaml.safe_load(open(f))
    assert 'stack_id' in data, f'Missing stack_id in {f}'
    assert 'type_mappings' in data, f'Missing type_mappings in {f}'
    count += 1
print(f'Validated {count} YAML files')
   "
   ```

3. **Test seed_stacks function (requires MongoDB running):**
   ```bash
   python -c "
import asyncio
from wxcode.database import init_db, close_db
from wxcode.services import seed_stacks

async def test():
    client = await init_db()
    count = await seed_stacks()
    print(f'Seeded {count} stacks')
    await close_db(client)

asyncio.run(test())
   "
   ```

4. **Test list_stacks function:**
   ```bash
   python -c "
import asyncio
from wxcode.database import init_db, close_db
from wxcode.services import list_stacks, get_stacks_grouped

async def test():
    client = await init_db()

    # List all
    all_stacks = await list_stacks()
    print(f'Total stacks: {len(all_stacks)}')

    # List by group
    grouped = await get_stacks_grouped()
    for group, stacks in grouped.items():
        print(f'{group}: {len(stacks)} stacks')

    await close_db(client)

asyncio.run(test())
   "
   # Expected: 5 server-rendered, 5 spa, 5 fullstack = 15 total
   ```

**Note:** If MongoDB is not running, tests will fail with connection error. This is expected and acceptable for verification purposes.
  </action>
  <verify>
    # Final count check
    echo "Expected: 15 YAML files, 15 stacks in MongoDB"
    ls src/wxcode/data/stacks/*/*.yaml 2>/dev/null | wc -l
  </verify>
  <done>End-to-end integration verified</done>
</task>

</tasks>

<verification>
1. FastAPI app starts and logs stack count
2. CLI command `wxcode seed-stacks` works
3. 15 stacks are seeded to MongoDB
4. get_stacks_grouped() returns correct grouping
</verification>

<success_criteria>
- main.py calls seed_stacks() on startup (after init_db)
- CLI has `seed-stacks` command with --force and --verbose options
- Application starts successfully
- All 15 stacks are seeded and queryable
</success_criteria>

<output>
After completion, create `.planning/phases/15-stack-configuration/15-05-SUMMARY.md`
</output>
