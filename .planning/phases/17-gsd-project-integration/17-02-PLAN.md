---
phase: 17-gsd-project-integration
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/wxcode/api/output_projects.py
autonomous: true

must_haves:
  truths:
    - "WebSocket endpoint /api/output-projects/{id}/initialize accepts connection"
    - "Endpoint validates OutputProject exists and status is CREATED"
    - "CONTEXT.md is written to workspace before GSD invocation"
    - "Claude Code CLI is invoked with /gsd:new-project command"
    - "Real-time streaming output sent via WebSocket"
    - "OutputProject status transitions: CREATED -> INITIALIZED -> ACTIVE"
  artifacts:
    - path: "src/wxcode/api/output_projects.py"
      provides: "WebSocket endpoint for /initialize"
      contains: "@router.websocket"
  key_links:
    - from: "output_projects.py"
      to: "prompt_builder"
      via: "import and call write_context_file"
      pattern: "PromptBuilder\\.write_context_file"
    - from: "output_projects.py"
      to: "schema_extractor"
      via: "import and call extract_schema_for_configuration"
      pattern: "extract_schema_for_configuration"
    - from: "output_projects.py"
      to: "GSDInvoker"
      via: "invoke_with_streaming method"
      pattern: "GSDInvoker.*invoke_with_streaming"
---

<objective>
Add WebSocket endpoint to initialize OutputProject with Claude Code GSD workflow.

Purpose: When user clicks Initialize, this endpoint orchestrates schema extraction, prompt building, and Claude Code invocation with real-time streaming output.

Output: Extended output_projects.py with WebSocket endpoint `/api/output-projects/{id}/initialize`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-gsd-project-integration/17-RESEARCH.md
@.planning/phases/17-gsd-project-integration/17-01-SUMMARY.md

# Relevant source files
@src/wxcode/api/output_projects.py
@src/wxcode/services/gsd_invoker.py
@src/wxcode/models/output_project.py
@src/wxcode/models/stack.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WebSocket initialize endpoint</name>
  <files>src/wxcode/api/output_projects.py</files>
  <action>
Extend output_projects.py with WebSocket endpoint:

1. Add imports at top:
   ```python
   from pathlib import Path
   from fastapi import WebSocket, WebSocketDisconnect
   from wxcode.models.stack import Stack
   from wxcode.services.gsd_invoker import GSDInvoker
   from wxcode.services.schema_extractor import extract_schema_for_configuration
   from wxcode.services.prompt_builder import PromptBuilder
   ```

2. Add WebSocket endpoint after existing endpoints:
   ```python
   @router.websocket("/{id}/initialize")
   async def initialize_output_project(
       websocket: WebSocket,
       id: str,
   ):
   ```

3. Implementation flow:
   a. Accept WebSocket connection: `await websocket.accept()`
   b. Validate ID format (PydanticObjectId)
   c. Get OutputProject: `await OutputProject.get(project_oid)`
   d. Validate status is CREATED (reject if INITIALIZED or ACTIVE)
   e. Get Stack: `await Stack.find_one(Stack.stack_id == output_project.stack_id)`
   f. Extract schema: `await extract_schema_for_configuration(output_project.kb_id, output_project.configuration_id)`
   g. Write CONTEXT.md: `await PromptBuilder.write_context_file(...)`
   h. Update status to INITIALIZED
   i. Send info message: `{"type": "info", "message": f"CONTEXT.md created with {len(tables)} tables"}`
   j. Create GSDInvoker with context_path and workspace_path
   k. Call `invoker.invoke_with_streaming(websocket, id, timeout=1800)`
   l. On success (exit_code == 0): update status to ACTIVE, send complete message
   m. On failure: send error message with exit code

4. Error handling:
   - Wrap in try/except
   - Catch WebSocketDisconnect (silent handling)
   - Catch generic Exception and send error via WebSocket
   - Always close WebSocket in finally block

5. Message types for WebSocket:
   - `{"type": "info", "message": "..."}` - status updates
   - `{"type": "error", "message": "..."}` - errors
   - `{"type": "complete", "message": "..."}` - success

Note: GSDInvoker.invoke_with_streaming() handles the stream-json parsing and sends log messages. This endpoint only needs to send the bookend messages (info before, complete/error after).
  </action>
  <verify>
Run backend and test with wscat or curl:
```bash
# Start server
cd /Users/gilberto/projetos/wxk/wxcode && python -m uvicorn wxcode.main:app --reload &

# Check endpoint exists (will fail connect without valid ID, but should not 404)
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" -H "Sec-WebSocket-Version: 13" -H "Sec-WebSocket-Key: test" http://localhost:8000/api/output-projects/test/initialize

# Should get 400 or WebSocket upgrade attempt, NOT 404
```
  </verify>
  <done>
WebSocket endpoint registered at /api/output-projects/{id}/initialize. Endpoint validates OutputProject, extracts schema, writes CONTEXT.md, and invokes GSD with streaming.
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle GSDInvoker context path</name>
  <files>src/wxcode/api/output_projects.py</files>
  <action>
Ensure the GSDInvoker is initialized correctly:

1. GSDInvoker requires:
   - `context_md_path: Path` - Full path to CONTEXT.md
   - `working_dir: Path` - Workspace directory (where claude CLI runs)

2. The prompt_builder.write_context_file returns the full Path to CONTEXT.md

3. The OutputProject.workspace_path is a string, convert to Path:
   ```python
   workspace_path = Path(output_project.workspace_path)
   context_path = await PromptBuilder.write_context_file(
       output_project=output_project,
       stack=stack,
       tables=tables,
       workspace_path=workspace_path,
   )
   invoker = GSDInvoker(
       context_md_path=context_path,
       working_dir=workspace_path,
   )
   ```

4. Update the OutputProject timestamps when status changes:
   ```python
   output_project.status = OutputProjectStatus.INITIALIZED
   output_project.updated_at = datetime.utcnow()
   await output_project.save()
   ```

5. Add datetime import if not present: `from datetime import datetime` (already imported)
  </action>
  <verify>
Check imports and GSDInvoker usage compiles:
```bash
python -c "from wxcode.api.output_projects import router; print('Router OK')"
```
  </verify>
  <done>
GSDInvoker initialized with correct paths. OutputProject timestamps updated on status change.
  </done>
</task>

</tasks>

<verification>
1. output_projects.py has WebSocket endpoint at /{id}/initialize
2. Endpoint imports schema_extractor and prompt_builder
3. Endpoint calls GSDInvoker.invoke_with_streaming
4. Status transitions are CREATED -> INITIALIZED -> ACTIVE
5. Module imports without errors:
   ```bash
   python -c "from wxcode.api.output_projects import router; print('OK')"
   ```
</verification>

<success_criteria>
- [ ] WebSocket endpoint added to output_projects.py
- [ ] Endpoint validates OutputProject status before proceeding
- [ ] Schema extracted using extract_schema_for_configuration
- [ ] CONTEXT.md written to workspace via PromptBuilder
- [ ] GSDInvoker.invoke_with_streaming called with correct parameters
- [ ] Status transitions logged and saved
- [ ] Error handling with WebSocket messages
</success_criteria>

<output>
After completion, create `.planning/phases/17-gsd-project-integration/17-02-SUMMARY.md`
</output>
