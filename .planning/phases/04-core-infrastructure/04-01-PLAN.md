---
phase: 04-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/mcp/__init__.py
  - src/wxcode/mcp/server.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "MCP Server starts via python -m wxcode.mcp.server without errors"
    - "MongoDB connects during lifespan (Beanie initialized)"
    - "Neo4j connects or fails gracefully without blocking startup"
    - "All logging goes to stderr (stdout reserved for JSON-RPC)"
  artifacts:
    - path: "src/wxcode/mcp/__init__.py"
      provides: "Package marker for mcp module"
      min_lines: 3
    - path: "src/wxcode/mcp/server.py"
      provides: "FastMCP server with lifespan"
      exports: ["mcp", "app_lifespan"]
      min_lines: 60
    - path: "requirements.txt"
      provides: "FastMCP dependency"
      contains: "fastmcp<3"
  key_links:
    - from: "src/wxcode/mcp/server.py"
      to: "wxcode.database.init_db"
      via: "import and call in lifespan"
      pattern: "from wxcode\\.database import init_db"
    - from: "src/wxcode/mcp/server.py"
      to: "wxcode.graph.neo4j_connection"
      via: "import and graceful fallback"
      pattern: "Neo4jConnectionError"
---

<objective>
Create the MCP Server package with FastMCP, implementing lifespan-based database initialization.

Purpose: Establish foundational server infrastructure that connects to MongoDB and Neo4j, following existing project patterns.
Output: Working MCP server module at `src/wxcode/mcp/server.py` that initializes databases at startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-infrastructure/04-RESEARCH.md
@src/wxcode/database.py
@src/wxcode/graph/neo4j_connection.py
@src/wxcode/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastMCP dependency</name>
  <files>requirements.txt</files>
  <action>
Add `fastmcp<3` to requirements.txt.

IMPORTANT: Pin to `<3` because v3 is currently beta with breaking changes (see RESEARCH.md).

Add it after the existing dependencies. The line should be:
```
fastmcp<3
```
  </action>
  <verify>
Run `grep fastmcp requirements.txt` - should show `fastmcp<3`
Run `pip install -r requirements.txt` - should complete without errors
  </verify>
  <done>FastMCP library is installed and pinned to v2.x</done>
</task>

<task type="auto">
  <name>Task 2: Create MCP server package with lifespan</name>
  <files>src/wxcode/mcp/__init__.py, src/wxcode/mcp/server.py</files>
  <action>
Create the MCP server package following patterns from RESEARCH.md:

**`src/wxcode/mcp/__init__.py`:**
```python
"""MCP Server package for wxcode Knowledge Base."""
```

**`src/wxcode/mcp/server.py`:**

1. Configure logging to stderr FIRST (before any imports that might log):
   - Remove all existing handlers from root logger
   - Add StreamHandler pointing to sys.stderr
   - Format: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`
   - Set level to INFO (or DEBUG if settings.debug)

2. Create `@lifespan` decorated async function `app_lifespan(server)`:
   - Call `init_db()` from wxcode.database (REQUIRED)
   - Log success: "MongoDB connected and Beanie initialized"
   - Try to connect Neo4j (OPTIONAL - graceful fallback):
     - Create Neo4jConnection() and call connect()
     - On success: set neo4j_available=True, log "Neo4j connected"
     - On Neo4jConnectionError or Exception: set neo4j_available=False, log warning "Neo4j unavailable: {e}, using MongoDB only"
   - Yield context dict: {"mongo_client": client, "neo4j_conn": conn, "neo4j_available": bool}
   - In finally block: close_db(), close neo4j if connected, log "Shutdown complete"

3. Create FastMCP instance:
   ```python
   mcp = FastMCP("wxcode-kb", lifespan=app_lifespan)
   ```

4. Add entry point:
   ```python
   if __name__ == "__main__":
       configure_logging()
       mcp.run()
   ```

CRITICAL CONSTRAINTS:
- NEVER use print() - all output via logging to stderr
- Use existing init_db() from wxcode.database - do NOT hand-roll
- Use existing Neo4jConnection from wxcode.graph - do NOT hand-roll
- Neo4j failure must NOT block server startup
  </action>
  <verify>
Run `python -m wxcode.mcp.server` - server should start without errors
Check stderr for "MongoDB connected" message
Check that stdout is empty (no prints corrupting JSON-RPC)
If Neo4j unavailable, should see warning but server continues
Ctrl+C to stop server cleanly
  </verify>
  <done>
MCP server starts, connects to MongoDB (required), optionally connects to Neo4j (graceful fallback), logs only to stderr
  </done>
</task>

</tasks>

<verification>
1. Server module structure:
   - `ls src/wxcode/mcp/` shows `__init__.py` and `server.py`
   - `python -c "from wxcode.mcp.server import mcp"` imports without error

2. Server starts correctly:
   - `python -m wxcode.mcp.server` starts without errors
   - Logs appear on stderr (not stdout)
   - Server responds to Ctrl+C with clean shutdown

3. Database connections:
   - MongoDB: "MongoDB connected and Beanie initialized" appears in logs
   - Neo4j (if running): "Neo4j connected" appears in logs
   - Neo4j (if NOT running): Warning appears but server continues
</verification>

<success_criteria>
- FastMCP dependency installed (`fastmcp<3` in requirements.txt)
- MCP server module exists at src/wxcode/mcp/server.py
- Server starts via `python -m wxcode.mcp.server`
- MongoDB connection established during startup
- Neo4j connection attempted with graceful fallback
- All logging goes to stderr only
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-infrastructure/04-01-SUMMARY.md`
</output>
