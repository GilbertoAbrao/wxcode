---
phase: 04-core-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .mcp.json
autonomous: false

must_haves:
  truths:
    - "Claude Code discovers wxcode-kb server via .mcp.json"
    - "Server starts when Claude Code invokes it"
    - "Server logs appear in stderr only"
  artifacts:
    - path: ".mcp.json"
      provides: "MCP server configuration for Claude Code"
      min_lines: 8
  key_links:
    - from: ".mcp.json"
      to: "python -m wxcode.mcp.server"
      via: "command + args specification"
      pattern: "wxcode\\.mcp\\.server"
---

<objective>
Configure Claude Code integration via `.mcp.json` and verify end-to-end connection.

Purpose: Enable Claude Code to discover and connect to the wxcode-kb MCP server.
Output: Working `.mcp.json` configuration that Claude Code uses to spawn the server.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-infrastructure/04-RESEARCH.md
@.planning/phases/04-core-infrastructure/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .mcp.json configuration</name>
  <files>.mcp.json</files>
  <action>
Create `.mcp.json` in the project root following the format from RESEARCH.md:

```json
{
  "mcpServers": {
    "wxcode-kb": {
      "command": "python",
      "args": ["-m", "wxcode.mcp.server"],
      "env": {
        "PYTHONPATH": "${PROJECT_ROOT}/src"
      }
    }
  }
}
```

IMPORTANT: Replace `${PROJECT_ROOT}` with the ABSOLUTE path to the wxcode directory.
For this project: `/Users/gilberto/projetos/wxk/wxcode/src`

The PYTHONPATH is required because:
- The mcp module is under src/wxcode/mcp/
- Without PYTHONPATH, Python won't find the wxcode package

Alternative using uv (if project uses uv):
```json
{
  "mcpServers": {
    "wxcode-kb": {
      "command": "uv",
      "args": [
        "run",
        "--project", "/Users/gilberto/projetos/wxk/wxcode",
        "python", "-m", "wxcode.mcp.server"
      ]
    }
  }
}
```

Determine which approach to use:
1. Check if `uv.lock` or `pyproject.toml` with uv exists in project root
2. If yes, use uv approach
3. If no, use PYTHONPATH approach
  </action>
  <verify>
Run `cat .mcp.json` - should show valid JSON
Run `python -c "import json; json.load(open('.mcp.json'))"` - should not error
Verify paths are absolute (not relative or containing ${})
  </verify>
  <done>.mcp.json exists with correct configuration for Claude Code</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
MCP Server infrastructure with Claude Code integration:
- FastMCP server at src/wxcode/mcp/server.py
- Database connections via lifespan (MongoDB required, Neo4j optional)
- .mcp.json configuration for Claude Code
  </what-built>
  <how-to-verify>
1. **Verify server starts manually:**
   ```bash
   cd /Users/gilberto/projetos/wxk/wxcode
   PYTHONPATH=./src python -m wxcode.mcp.server
   ```
   Expected: Server starts, logs to stderr, no stdout output
   Press Ctrl+C to stop

2. **Verify Claude Code integration:**
   ```bash
   claude mcp list
   ```
   Expected: Should show `wxcode-kb` in the list

3. **Test server spawn via Claude Code:**
   Start a new Claude Code session in the wxcode directory.
   The server should be available. Try asking Claude to list MCP tools.

4. **Check logs:**
   When Claude Code starts the server, logs should appear in Claude's debug output showing:
   - "Starting wxcode MCP Server..."
   - "MongoDB connected and Beanie initialized"
   - Either "Neo4j connected" or "Neo4j unavailable: ... using MongoDB only"
  </how-to-verify>
  <resume-signal>
Type "approved" if Claude Code successfully connects to the MCP server.
If issues found, describe them and we'll fix.
  </resume-signal>
</task>

</tasks>

<verification>
1. Configuration file:
   - `.mcp.json` exists in project root
   - JSON is valid (parseable)
   - Contains `mcpServers.wxcode-kb` entry
   - Command and args are correct

2. Claude Code discovery:
   - `claude mcp list` shows wxcode-kb
   - Server spawns when Claude Code invokes it

3. End-to-end:
   - Claude Code can communicate with server
   - Server logs appear (stderr only)
   - No JSON-RPC corruption (stdout clean)
</verification>

<success_criteria>
- .mcp.json exists with valid configuration
- Claude Code discovers the wxcode-kb server
- Server starts when invoked by Claude Code
- MongoDB connection works from Claude Code context
- Neo4j fails gracefully if unavailable
- All Phase 4 success criteria from ROADMAP.md satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-infrastructure/04-02-SUMMARY.md`
</output>
