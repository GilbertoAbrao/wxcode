---
phase: 29-session-lifecycle-frontend
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - frontend/src/components/terminal/ConnectionStatus.tsx
  - frontend/src/components/terminal/InteractiveTerminal.tsx
  - frontend/src/components/terminal/index.ts
autonomous: true

must_haves:
  truths:
    - "Terminal shows 'Connecting...' overlay while WebSocket is establishing"
    - "Terminal shows 'Resuming session...' when reconnecting to existing session"
    - "Terminal shows error message with code when session_id is invalid/expired"
    - "Overlay disappears when connection is established"
  artifacts:
    - path: "frontend/src/components/terminal/ConnectionStatus.tsx"
      provides: "Terminal overlay component for connection states"
      exports: ["ConnectionStatus"]
    - path: "frontend/src/components/terminal/InteractiveTerminal.tsx"
      provides: "Terminal with connection status overlay"
      contains: "ConnectionStatus"
  key_links:
    - from: "InteractiveTerminal"
      to: "ConnectionStatus"
      via: "import and render"
      pattern: "ConnectionStatus.*connectionState"
    - from: "InteractiveTerminal"
      to: "useTerminalWebSocket"
      via: "connectionState destructuring"
      pattern: "connectionState.*useTerminalWebSocket"
---

<objective>
Create ConnectionStatus overlay component and integrate with InteractiveTerminal.

Purpose: Users need visual feedback during terminal connection lifecycle - connecting, resuming, errors. This phase implements TERM-01, TERM-02, TERM-03 requirements with a polished overlay UI that doesn't interfere with normal terminal operation.

Output: ConnectionStatus component and updated InteractiveTerminal with overlay integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-session-lifecycle-frontend/29-RESEARCH.md
@.planning/phases/29-session-lifecycle-frontend/29-01-SUMMARY.md

@frontend/src/components/terminal/InteractiveTerminal.tsx
@frontend/src/components/terminal/index.ts
@frontend/src/types/terminal.ts
@frontend/src/hooks/useTerminalWebSocket.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionStatus overlay component</name>
  <files>frontend/src/components/terminal/ConnectionStatus.tsx</files>
  <action>
Create a new ConnectionStatus component that renders an overlay on the terminal:

```typescript
"use client";

/**
 * ConnectionStatus - Terminal overlay for connection lifecycle states.
 *
 * Shows contextual messages during connecting, resuming, and error states.
 * Hidden during normal connected operation to not block terminal interaction.
 */

import React from "react";
import { Loader2, RefreshCw, AlertCircle, WifiOff } from "lucide-react";
import { cn } from "@/lib/utils";
import type { ConnectionState } from "@/types/terminal";
import { getTerminalErrorMessage } from "@/types/terminal";

export interface ConnectionStatusProps {
  /** Current connection state */
  state: ConnectionState;
  /** Error message from backend (optional) */
  errorMessage?: string | null;
  /** Error code for message lookup */
  errorCode?: string | null;
  /** Callback for retry button click */
  onRetry?: () => void;
  /** Additional CSS classes */
  className?: string;
}

const stateConfig: Record<
  Exclude<ConnectionState, "connected">,
  {
    message: string;
    Icon: React.ElementType;
    animate: boolean;
    bgColor: string;
    showRetry?: boolean;
  }
> = {
  idle: {
    message: "Terminal pronto",
    Icon: WifiOff,
    animate: false,
    bgColor: "bg-zinc-900/90",
  },
  connecting: {
    message: "Conectando...",
    Icon: Loader2,
    animate: true,
    bgColor: "bg-zinc-900/90",
  },
  resuming: {
    message: "Restaurando sessao...",
    Icon: RefreshCw,
    animate: true,
    bgColor: "bg-blue-900/90",
  },
  error: {
    message: "Erro de conexao",
    Icon: AlertCircle,
    animate: false,
    bgColor: "bg-red-900/90",
    showRetry: true,
  },
  disconnected: {
    message: "Desconectado",
    Icon: WifiOff,
    animate: false,
    bgColor: "bg-zinc-900/90",
    showRetry: true,
  },
};

export function ConnectionStatus({
  state,
  errorMessage,
  errorCode,
  onRetry,
  className,
}: ConnectionStatusProps): React.ReactElement | null {
  // Don't show overlay when connected - terminal should be interactive
  if (state === "connected") return null;

  const config = stateConfig[state];
  const Icon = config.Icon;

  // Get user-friendly error message
  const displayMessage =
    state === "error"
      ? getTerminalErrorMessage(errorCode, errorMessage || config.message)
      : config.message;

  return (
    <div
      className={cn(
        "absolute inset-0 flex items-center justify-center z-10",
        config.bgColor,
        className
      )}
    >
      <div className="flex flex-col items-center gap-3 text-zinc-300">
        <Icon
          className={cn("w-8 h-8", config.animate && "animate-spin")}
        />
        <span className="text-sm font-medium text-center max-w-xs px-4">
          {displayMessage}
        </span>
        {config.showRetry && onRetry && (
          <button
            onClick={onRetry}
            className="mt-2 px-4 py-1.5 text-xs font-medium bg-zinc-800 hover:bg-zinc-700 rounded-md transition-colors"
          >
            Tentar novamente
          </button>
        )}
      </div>
    </div>
  );
}

export default ConnectionStatus;
```

Key design decisions:
- Absolute positioning with inset-0 to cover terminal container
- z-10 ensures overlay is above terminal content
- Semi-transparent background allows terminal content to remain visible
- Retry button only shown for error/disconnected states
- Uses lucide-react icons consistent with project
- getTerminalErrorMessage maps codes to Portuguese messages
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>ConnectionStatus component created with state-based rendering</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConnectionStatus into InteractiveTerminal</name>
  <files>frontend/src/components/terminal/InteractiveTerminal.tsx, frontend/src/components/terminal/index.ts</files>
  <action>
Update InteractiveTerminal to use ConnectionStatus overlay and expose connection state:

1. Add import at top of InteractiveTerminal.tsx:
```typescript
import { ConnectionStatus } from "./ConnectionStatus";
```

2. Update the useTerminalWebSocket destructuring to get new fields:
```typescript
const {
  connect,
  disconnect,
  sendInput,
  sendResize,
  connectionState,
  errorMessage,
  errorCode,
} = useTerminalWebSocket(milestoneId, {
  // ... existing callbacks
});
```

3. Create retry handler callback (after the hook usage):
```typescript
const handleRetry = useCallback(() => {
  // Disconnect and reconnect
  disconnectRef.current();
  setTimeout(() => {
    connectRef.current();
  }, 100);
}, []);

const handleRetryRef = useRef(handleRetry);
handleRetryRef.current = handleRetry;
```

4. Update the return JSX to wrap terminal container with relative positioning and add overlay:
```typescript
return (
  <div
    ref={containerRef}
    onClick={handleClick}
    className={`bg-zinc-950 p-2 overflow-hidden h-full relative ${className || ""}`}
  >
    {/* Connection status overlay */}
    <ConnectionStatus
      state={connectionState}
      errorMessage={errorMessage}
      errorCode={errorCode}
      onRetry={handleRetryRef.current}
    />
  </div>
);
```

Key changes:
- Add `relative` to container class for overlay positioning
- ConnectionStatus renders as first child (will be on top due to z-10)
- Overlay only visible when connectionState is not "connected"
- Terminal remains in DOM during overlay (no unmount/remount)

5. Export ConnectionStatus from index.ts by adding:
```typescript
export { ConnectionStatus } from "./ConnectionStatus";
```
  </action>
  <verify>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. ConnectionStatus exported from terminal index
  </verify>
  <done>InteractiveTerminal shows connection status overlay during connecting/resuming/error states</done>
</task>

</tasks>

<verification>
- [ ] `cd frontend && npx tsc --noEmit` passes without errors
- [ ] ConnectionStatus.tsx exists with all state configs
- [ ] InteractiveTerminal imports and renders ConnectionStatus
- [ ] Container has relative positioning for overlay
- [ ] ConnectionStatus exported from components/terminal/index.ts
</verification>

<success_criteria>
- TERM-01: Terminal shows "Connecting..." while establishing WebSocket
- TERM-02: Terminal shows "Resuming session..." when using --resume
- TERM-03: Terminal shows error message if session_id invalid/expired
- Overlay disappears when connection established
- Retry button allows manual reconnection from error state
</success_criteria>

<output>
After completion, create `.planning/phases/29-session-lifecycle-frontend/29-02-SUMMARY.md`
</output>
