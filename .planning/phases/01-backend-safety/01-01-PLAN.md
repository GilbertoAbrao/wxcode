---
phase: 01-backend-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/config.py
  - src/wxcode/services/project_service.py
autonomous: true

must_haves:
  truths:
    - "Calling purge_project deletes local project files alongside MongoDB/Neo4j data"
    - "Invalid paths (outside allowed base) are rejected with clear ValueError"
    - "API response includes files_deleted and directories_deleted counts"
    - "Read-only files are handled gracefully during deletion"
  artifacts:
    - path: "src/wxcode/config.py"
      provides: "allowed_deletion_base setting"
      contains: "allowed_deletion_base"
    - path: "src/wxcode/services/project_service.py"
      provides: "File deletion with path validation"
      exports: ["purge_project", "PurgeStats"]
  key_links:
    - from: "src/wxcode/services/project_service.py"
      to: "src/wxcode/config.py"
      via: "get_settings().allowed_deletion_base"
      pattern: "get_settings\\(\\)"
    - from: "_purge_project_data"
      to: "_purge_local_files"
      via: "function call after MongoDB deletion"
      pattern: "_purge_local_files\\("
---

<objective>
Extend purge_project to safely delete local project files with path validation.

Purpose: Complete the deletion workflow so users can fully remove projects (MongoDB + Neo4j + files) with a single API call. Path validation prevents accidental deletion of files outside the allowed directory.

Output: Updated project_service.py with file deletion capability and config.py with allowed_deletion_base setting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-safety/01-RESEARCH.md
@src/wxcode/services/project_service.py
@src/wxcode/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allowed_deletion_base to config</name>
  <files>src/wxcode/config.py</files>
  <action>
Add a new setting `allowed_deletion_base` to the Settings class.

1. Add the field with default value pointing to project-refs directory:
   ```python
   # File deletion safety - base directory for allowed deletions
   allowed_deletion_base: str = str(PROJECT_ROOT / "project-refs")
   ```

2. Place it after the Neo4j settings block (at end of class).

This setting defines where project files can be deleted from. Paths outside this directory will be rejected.
  </action>
  <verify>
Run: `python -c "from wxcode.config import get_settings; print(get_settings().allowed_deletion_base)"`
Should print the absolute path to project-refs directory.
  </verify>
  <done>Settings class has allowed_deletion_base field with default pointing to project-refs.</done>
</task>

<task type="auto">
  <name>Task 2: Extend PurgeStats and add file deletion helpers</name>
  <files>src/wxcode/services/project_service.py</files>
  <action>
Extend PurgeStats dataclass and add helper functions for file deletion.

1. Add imports at top of file:
   ```python
   import os
   import stat
   import shutil
   from pathlib import Path
   ```
   And add import for config:
   ```python
   from wxcode.config import get_settings
   ```

2. Extend PurgeStats dataclass with new fields (after neo4j_error):
   ```python
   files_deleted: int = 0
   directories_deleted: int = 0
   files_error: Optional[str] = None
   ```

3. Add property to PurgeStats for total files:
   ```python
   @property
   def total_files(self) -> int:
       """Total de arquivos e diretorios removidos."""
       return self.files_deleted + self.directories_deleted
   ```

4. Update to_dict method to include file stats:
   - Add files_deleted, directories_deleted to result dict
   - Add total_files to result dict
   - Conditionally add files_error if present (like neo4j_error)

5. Add helper function _remove_readonly (before _purge_project_data):
   ```python
   def _remove_readonly(func, path, exc_info):
       """Handler para arquivos read-only (especialmente Windows)."""
       os.chmod(path, stat.S_IWRITE)
       func(path)
   ```

6. Add helper function _validate_deletion_path:
   ```python
   def _validate_deletion_path(source_path: str, allowed_base: Path) -> Path:
       """
       Valida que o path esta dentro do diretorio permitido.

       Args:
           source_path: Path do arquivo .wwp do projeto
           allowed_base: Diretorio base permitido para delecao

       Returns:
           Path resolvido do diretorio do projeto (parent do .wwp)

       Raises:
           ValueError: Se path esta fora do diretorio permitido
       """
       wwp_path = Path(source_path).resolve()
       project_dir = wwp_path.parent
       allowed = allowed_base.resolve()

       if not project_dir.is_relative_to(allowed):
           raise ValueError(
               f"Path '{project_dir}' esta fora do diretorio permitido '{allowed}'"
           )

       return project_dir
   ```

7. Add helper function _purge_local_files:
   ```python
   def _purge_local_files(project_dir: Path, stats: PurgeStats) -> None:
       """
       Remove o diretorio do projeto e todo seu conteudo.

       Similar a _purge_neo4j_data: nao falha se houver erro,
       apenas registra no stats.

       Args:
           project_dir: Path do diretorio do projeto
           stats: PurgeStats para atualizar com contagens
       """
       try:
           if not project_dir.exists():
               logger.debug(f"Diretorio nao existe, pulando: {project_dir}")
               return

           if not project_dir.is_dir():
               stats.files_error = f"Path nao e um diretorio: {project_dir}"
               logger.warning(stats.files_error)
               return

           # Conta antes de deletar
           stats.files_deleted = sum(1 for p in project_dir.rglob("*") if p.is_file())
           stats.directories_deleted = sum(1 for p in project_dir.rglob("*") if p.is_dir()) + 1

           # Deleta com handler para read-only
           shutil.rmtree(project_dir, onexc=_remove_readonly)
           logger.info(
               f"Removidos {stats.files_deleted} arquivos e "
               f"{stats.directories_deleted} diretorios de {project_dir}"
           )

       except OSError as e:
           stats.files_error = f"Falha ao deletar arquivos: {e}"
           stats.files_deleted = 0
           stats.directories_deleted = 0
           logger.warning(stats.files_error)
   ```

8. Modify _purge_project_data to call file deletion (after Neo4j, before deleting project):
   - Get settings and validate path:
     ```python
     # Remove arquivos locais (opcional - nao falha se houver erro)
     if project.source_path:
         settings = get_settings()
         allowed_base = Path(settings.allowed_deletion_base)
         try:
             project_dir = _validate_deletion_path(project.source_path, allowed_base)
             _purge_local_files(project_dir, stats)
         except ValueError as e:
             stats.files_error = str(e)
             logger.warning(f"Path validation failed: {e}")
     ```
   - Place this block after `await _purge_neo4j_data(...)` and before `await project.delete()`
  </action>
  <verify>
1. Run type check: `python -m mypy src/wxcode/services/project_service.py --ignore-missing-imports`
2. Run: `python -c "from wxcode.services.project_service import PurgeStats; s = PurgeStats(); print(s.total_files, s.files_deleted, s.directories_deleted)"`
   Should print: `0 0 0`
3. Run: `python -c "from wxcode.services.project_service import _validate_deletion_path; from pathlib import Path; _validate_deletion_path('/tmp/test.wwp', Path('/home'))"`
   Should raise ValueError about path being outside allowed directory.
  </verify>
  <done>
PurgeStats includes files_deleted, directories_deleted, files_error fields.
_validate_deletion_path rejects paths outside allowed_deletion_base.
_purge_local_files deletes project directory with read-only handling.
_purge_project_data calls file deletion after Neo4j cleanup.
  </done>
</task>

</tasks>

<verification>
1. **Unit verification:**
   - `python -m mypy src/wxcode/services/project_service.py --ignore-missing-imports` passes
   - `python -c "from wxcode.services.project_service import PurgeStats; print(PurgeStats().to_dict())"` includes file fields

2. **Path validation:**
   ```python
   python -c "
   from wxcode.services.project_service import _validate_deletion_path
   from pathlib import Path

   # Should succeed (inside project-refs)
   try:
       result = _validate_deletion_path('project-refs/Test/Test.wwp', Path('project-refs'))
       print(f'OK: {result}')
   except ValueError as e:
       print(f'FAIL: {e}')

   # Should fail (outside project-refs)
   try:
       _validate_deletion_path('/etc/passwd', Path('project-refs'))
       print('FAIL: Should have raised ValueError')
   except ValueError:
       print('OK: Path traversal blocked')
   "
   ```

3. **Integration (manual - requires test project):**
   If a test project exists in project-refs/, can verify full flow via API.
</verification>

<success_criteria>
- PurgeStats has files_deleted, directories_deleted, files_error fields
- to_dict() returns file deletion counts
- _validate_deletion_path raises ValueError for paths outside allowed base
- _purge_local_files handles non-existent directories, non-directories, and read-only files gracefully
- _purge_project_data calls _purge_local_files after Neo4j cleanup
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-safety/01-01-SUMMARY.md`
</output>
