---
phase: 07-conversion-workflow-gsd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/mcp/tools/conversion.py
  - src/wxcode/mcp/tools/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can query which elements are ready for conversion"
    - "User can get recommended conversion order based on dependencies"
    - "User can view conversion progress statistics"
  artifacts:
    - path: "src/wxcode/mcp/tools/conversion.py"
      provides: "Conversion workflow MCP tools"
      exports: ["get_conversion_candidates", "get_topological_order", "get_conversion_stats"]
    - path: "src/wxcode/mcp/tools/__init__.py"
      provides: "Tool registration including conversion module"
      contains: "from wxcode.mcp.tools import conversion"
  key_links:
    - from: "src/wxcode/mcp/tools/conversion.py"
      to: "DependencyAnalyzer"
      via: "import and analyze() call"
      pattern: "analyzer\\.analyze\\(persist=False\\)"
    - from: "src/wxcode/mcp/tools/conversion.py"
      to: "Element model"
      via: "conversion.status queries"
      pattern: "conversion\\.status"
---

<objective>
Create read-only conversion workflow MCP tools (get_conversion_candidates, get_topological_order, get_conversion_stats)

Purpose: Enable users to track conversion progress and determine optimal conversion order without write operations
Output: src/wxcode/mcp/tools/conversion.py with 3 read-only tools registered in MCP server
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-conversion-workflow-gsd/07-RESEARCH.md

# Reference existing patterns
@src/wxcode/mcp/tools/elements.py
@src/wxcode/mcp/tools/graph.py
@src/wxcode/mcp/tools/__init__.py
@src/wxcode/models/element.py
@src/wxcode/analyzer/dependency_analyzer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conversion.py with read-only tools</name>
  <files>src/wxcode/mcp/tools/conversion.py</files>
  <action>
Create new file with 3 MCP tools following established patterns from elements.py and graph.py:

1. **get_conversion_candidates** (CONV-01):
   - Parameters: project_name (required), layer (optional), limit (default 20)
   - Logic: Find pending elements whose dependencies.uses are all in converted/validated status
   - Sort by topological_order, return limited results
   - Use DBRef pattern from elements.py for project-scoped queries
   - Return dict with error field and data.candidates array

2. **get_topological_order** (CONV-02):
   - Parameters: project_name (required), layer (optional), include_converted (default False)
   - Use DependencyAnalyzer(project.id).analyze(persist=False) to get fresh order
   - Filter by layer if specified
   - Filter out converted elements unless include_converted=True
   - node_id format is "type:name" - extract name for filtering
   - Return dict with order array and by_layer grouping

3. **get_conversion_stats** (CONV-04):
   - Parameters: project_name (required)
   - Use MongoDB aggregation pipeline for efficiency
   - Aggregate by conversion.status and by layer+status
   - Calculate progress_percentage as (converted+validated)/total
   - Return dict with totals and breakdowns

Include _find_element helper duplicated from elements.py (for parallel execution with Plan 02).
All tools must use try/except with error dict return pattern (no exceptions).
Use ConversionStatus enum values (.value) for query matching.
  </action>
  <verify>python -c "from wxcode.mcp.tools.conversion import get_conversion_candidates, get_topological_order, get_conversion_stats"</verify>
  <done>Three read-only conversion tools importable from conversion.py</done>
</task>

<task type="auto">
  <name>Task 2: Register conversion tools in __init__.py</name>
  <files>src/wxcode/mcp/tools/__init__.py</files>
  <action>
Update __init__.py to import conversion module:

1. Add to docstring:
   - conversion: get_conversion_candidates, get_topological_order, get_conversion_stats

2. Add import line after graph import:
   from wxcode.mcp.tools import conversion  # noqa: F401

3. Add "conversion" to __all__ list

Note: mark_converted will be added in Plan 02, not listed here yet.
  </action>
  <verify>python -c "from wxcode.mcp import tools; print('conversion' in tools.__all__)"</verify>
  <done>Conversion tools registered with MCP server on import</done>
</task>

<task type="auto">
  <name>Task 3: Test tools with MCP server</name>
  <files></files>
  <action>
Verify tools are registered and callable:

1. Start MCP server: python -m wxcode.mcp.server (in background)
2. Check tool count increased to 18 (15 from Phase 6 + 3 new)
3. Verify tools appear in MCP tool list

If server fails to start, check imports and fix any syntax errors.
  </action>
  <verify>python -c "from wxcode.mcp.server import mcp; print(f'Tools registered: {len(mcp._tool_manager._tools)}')" 2>/dev/null || echo "Check server startup"</verify>
  <done>MCP server starts with 18 tools registered (15 existing + 3 new)</done>
</task>

</tasks>

<verification>
- [ ] conversion.py exists with 3 tools
- [ ] __init__.py imports conversion module
- [ ] All tools follow error dict return pattern
- [ ] get_conversion_candidates uses dependency checking logic
- [ ] get_topological_order uses DependencyAnalyzer with persist=False
- [ ] get_conversion_stats uses MongoDB aggregation
- [ ] MCP server starts without errors
</verification>

<success_criteria>
- 3 read-only conversion tools (CONV-01, CONV-02, CONV-04) available via MCP
- Tools follow established patterns from Phase 5-6
- No write operations in this plan (mark_converted is Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/07-conversion-workflow-gsd/07-01-SUMMARY.md`
</output>
