---
phase: 07-conversion-workflow-gsd
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/wxcode/mcp/tools/conversion.py
  - src/wxcode/mcp/tools/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can mark elements as converted with confirmation required"
    - "Preview is shown when confirm=False"
    - "Audit log records all status changes"
  artifacts:
    - path: "src/wxcode/mcp/tools/conversion.py"
      provides: "mark_converted MCP tool with confirmation pattern"
      exports: ["mark_converted"]
    - path: "src/wxcode/mcp/tools/__init__.py"
      provides: "Updated docstring with mark_converted"
      contains: "mark_converted"
  key_links:
    - from: "src/wxcode/mcp/tools/conversion.py"
      to: "Element.save()"
      via: "state mutation"
      pattern: "await element\\.save\\(\\)"
    - from: "src/wxcode/mcp/tools/conversion.py"
      to: "audit_logger"
      via: "logging.info call"
      pattern: "audit_logger\\.info"
---

<objective>
Add mark_converted write tool with confirmation pattern and audit logging

Purpose: Enable users to update conversion status safely with explicit confirmation and audit trail
Output: mark_converted tool added to conversion.py with confirmation pattern
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-conversion-workflow-gsd/07-RESEARCH.md
@.planning/phases/07-conversion-workflow-gsd/07-01-SUMMARY.md

# Reference the file we're modifying
@src/wxcode/mcp/tools/conversion.py
@src/wxcode/models/element.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audit logger setup to conversion.py</name>
  <files>src/wxcode/mcp/tools/conversion.py</files>
  <action>
Add at top of file (after imports):

```python
import logging
from datetime import datetime

# Audit logger for write operations
audit_logger = logging.getLogger("wxcode.mcp.audit")
```

Ensure datetime import is present (for converted_at timestamp).
  </action>
  <verify>grep -q "audit_logger" src/wxcode/mcp/tools/conversion.py</verify>
  <done>Audit logger configured for write operation tracking</done>
</task>

<task type="auto">
  <name>Task 2: Implement mark_converted tool with confirmation</name>
  <files>src/wxcode/mcp/tools/conversion.py</files>
  <action>
Add mark_converted tool function (CONV-03):

Parameters:
- element_name: str (required)
- project_name: str (required)
- confirm: bool = False (safety check)
- notes: str | None = None (optional conversion notes)

Logic:
1. Use _find_element helper to locate element (already in file from Plan 01)
2. Get current_status = element.conversion.status.value
3. If confirm=False: Return preview dict with requires_confirmation=True
   - Include element, project, current_status, new_status, instruction
4. If confirm=True: Execute the change
   - Set element.conversion.status = ConversionStatus.CONVERTED
   - Set element.conversion.converted_at = datetime.utcnow()
   - If notes: append timestamped note to element.conversion.issues
   - Call await element.save()
   - Log to audit_logger.info with project/element/old_status/new_status
   - Return executed=True with data dict

Handle errors with try/except returning error dict pattern.

This is the ONLY write operation in the MCP server - document clearly in docstring.
  </action>
  <verify>python -c "from wxcode.mcp.tools.conversion import mark_converted; print('mark_converted imported')"</verify>
  <done>mark_converted tool with confirmation pattern implemented</done>
</task>

<task type="auto">
  <name>Task 3: Update __init__.py docstring with mark_converted</name>
  <files>src/wxcode/mcp/tools/__init__.py</files>
  <action>
Update the docstring to include mark_converted in the conversion tools list:

Change:
- conversion: get_conversion_candidates, get_topological_order, get_conversion_stats

To:
- conversion: get_conversion_candidates, get_topological_order, mark_converted, get_conversion_stats

Note the order: mark_converted listed before get_conversion_stats to match CONV-03 before CONV-04.
  </action>
  <verify>grep -q "mark_converted" src/wxcode/mcp/tools/__init__.py</verify>
  <done>Docstring updated to list all 4 conversion tools</done>
</task>

</tasks>

<verification>
- [ ] audit_logger configured at module level
- [ ] mark_converted requires confirm=True to execute
- [ ] Preview returned when confirm=False
- [ ] Status change persisted with element.save()
- [ ] Audit log written on successful change
- [ ] Notes appended to conversion.issues if provided
- [ ] MCP server starts with 19 tools (18 + mark_converted)
</verification>

<success_criteria>
- mark_converted tool (CONV-03) available via MCP
- Tool requires explicit confirm=True for state mutation
- Audit logging tracks all status changes
- Phase 7 conversion tools complete (4 tools total)
</success_criteria>

<output>
After completion, create `.planning/phases/07-conversion-workflow-gsd/07-02-SUMMARY.md`
</output>
