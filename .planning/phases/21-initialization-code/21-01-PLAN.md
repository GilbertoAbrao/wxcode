---
phase: 21-initialization-code
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/services/prompt_builder.py
autonomous: true

must_haves:
  truths:
    - "CONTEXT.md includes Initialization Code section with WLanguage snippets"
    - "Initialization code truncated at 100 lines with indicator if longer"
    - "CONTEXT.md includes FastAPI lifespan pattern documentation"
    - "Lifespan pattern only shown when initialization blocks exist"
  artifacts:
    - path: "src/wxcode/services/prompt_builder.py"
      provides: "format_initialization_blocks() and format_lifespan_pattern() methods"
      contains: "def format_initialization_blocks"
    - path: "src/wxcode/services/prompt_builder.py"
      provides: "Initialization Code section in PROMPT_TEMPLATE"
      contains: "## Initialization Code"
  key_links:
    - from: "src/wxcode/services/prompt_builder.py"
      to: "GlobalStateContext.initialization_blocks"
      via: "format_initialization_blocks() iterates over blocks"
      pattern: "global_state\\.initialization_blocks"
    - from: "PROMPT_TEMPLATE"
      to: "format_initialization_blocks()"
      via: "initialization_code placeholder"
      pattern: "\\{initialization_code\\}"
---

<objective>
Add initialization code formatting to PromptBuilder so CONTEXT.md includes WLanguage init snippets and FastAPI lifespan conversion guidance.

Purpose: Enable Claude to understand how the WinDev project initializes (connections, globals, config) so it can convert to proper FastAPI lifespan patterns instead of deprecated @app.on_event decorators.

Output: Updated prompt_builder.py with format_initialization_blocks() and format_lifespan_pattern() methods, and PROMPT_TEMPLATE with Initialization Code section.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-initialization-code/21-RESEARCH.md

# Source file to modify
@src/wxcode/services/prompt_builder.py

# Models for reference (GlobalStateContext, InitializationBlock)
@src/wxcode/models/global_state_context.py
@src/wxcode/parser/global_state_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add initialization formatting methods to PromptBuilder</name>
  <files>src/wxcode/services/prompt_builder.py</files>
  <action>
Add two new static methods to PromptBuilder class AFTER format_scope_patterns():

1. **format_initialization_blocks(global_state: GlobalStateContext) -> str**
   - Return "*No initialization code found.*" if no global_state or empty initialization_blocks
   - For each InitializationBlock in global_state.initialization_blocks:
     - Add header "### Initialization Block {i + 1}"
     - Add "**References:** {deps}" with first 5 dependencies as `backtick` format, "(+N more)" if > 5
     - Wrap block.code in ```wlanguage ... ``` code fence
     - **IMPORTANT:** Truncate at 100 lines - if block.code has > 100 lines:
       - Show first 100 lines
       - Add "// ... ({remaining} more lines)" comment before closing fence

2. **format_lifespan_pattern() -> str**
   - Return static markdown documenting FastAPI lifespan conversion pattern
   - Include @asynccontextmanager example with startup/shutdown comments
   - Include table mapping WLanguage patterns to FastAPI/Python equivalents:
     | WLanguage | FastAPI/Python |
     | gCnn is Connection | app.state.db_engine or Depends() |
     | HOpenConnection(gCnn) | create_async_engine(DATABASE_URL) |
     | HChangeConnection("*", gCnn) | Default database routing in ORM |
     | COMPILE IF Configuration="X" | Environment variables / .env files |
     | Global_PegaInfoINI(path, key) | os.getenv() or pydantic_settings.BaseSettings |
   - Add note: "Use @asynccontextmanager (not deprecated @app.on_event)"
  </action>
  <verify>
Run: `python -c "from wxcode.services.prompt_builder import PromptBuilder; from wxcode.models.global_state_context import GlobalStateContext; from wxcode.parser.global_state_extractor import InitializationBlock; ctx = GlobalStateContext(initialization_blocks=[InitializationBlock(code='IF HOpenConnection(gCnn) = False THEN\n  Error()\nEND', dependencies=['gCnn'], order=0)]); print(PromptBuilder.format_initialization_blocks(ctx)[:200])"` should output markdown with "### Initialization Block 1" and wlanguage code fence.
  </verify>
  <done>
format_initialization_blocks() returns markdown with WLanguage code blocks.
format_lifespan_pattern() returns FastAPI lifespan documentation.
Both methods handle empty/None inputs gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PROMPT_TEMPLATE with Initialization Code section</name>
  <files>src/wxcode/services/prompt_builder.py</files>
  <action>
1. **Update PROMPT_TEMPLATE string** - Add new section AFTER "## Global State" block:

```
## Initialization Code

{initialization_code}

{lifespan_pattern}
```

2. **Update build_context() method** - Add two new format() arguments:
   - `initialization_code=cls.format_initialization_blocks(global_state)`
   - `lifespan_pattern=cls.format_lifespan_pattern() if global_state and global_state.initialization_blocks else ""`

Note: The API wiring is already complete from Phase 20 - global_state is already passed to build_context() and write_context_file(). No changes needed in output_projects.py.
  </action>
  <verify>
Run: `python -c "from wxcode.services.prompt_builder import PromptBuilder; from wxcode.models.output_project import OutputProject; from wxcode.models.stack import Stack; from wxcode.models.global_state_context import GlobalStateContext; from wxcode.parser.global_state_extractor import InitializationBlock; op = OutputProject(id='test', name='Test', kb_id='kb1'); stack = Stack(id='s1', name='FastAPI', language='python', framework='fastapi'); ctx = GlobalStateContext(initialization_blocks=[InitializationBlock(code='HOpenConnection(gCnn)', dependencies=['gCnn'], order=0)]); result = PromptBuilder.build_context(op, stack, [], global_state=ctx); assert '## Initialization Code' in result; assert 'HOpenConnection' in result; assert 'asynccontextmanager' in result; print('OK')"` should print "OK".
  </verify>
  <done>
PROMPT_TEMPLATE includes "## Initialization Code" section.
build_context() populates initialization_code and lifespan_pattern placeholders.
Lifespan pattern only appears when initialization blocks exist.
  </done>
</task>

</tasks>

<verification>
All verification commands must pass:

```bash
# 1. Module imports without errors
python -c "from wxcode.services.prompt_builder import PromptBuilder"

# 2. format_initialization_blocks handles empty input
python -c "from wxcode.services.prompt_builder import PromptBuilder; assert 'No initialization code' in PromptBuilder.format_initialization_blocks(None)"

# 3. format_lifespan_pattern returns lifespan docs
python -c "from wxcode.services.prompt_builder import PromptBuilder; p = PromptBuilder.format_lifespan_pattern(); assert 'asynccontextmanager' in p; assert 'lifespan' in p.lower()"

# 4. PROMPT_TEMPLATE has Initialization Code section
python -c "from wxcode.services.prompt_builder import PROMPT_TEMPLATE; assert '## Initialization Code' in PROMPT_TEMPLATE; assert '{initialization_code}' in PROMPT_TEMPLATE"

# 5. build_context integrates initialization correctly
python -c "
from wxcode.services.prompt_builder import PromptBuilder
from wxcode.models.output_project import OutputProject
from wxcode.models.stack import Stack
from wxcode.models.global_state_context import GlobalStateContext
from wxcode.parser.global_state_extractor import InitializationBlock

op = OutputProject(id='t', name='Test', kb_id='kb')
stack = Stack(id='s', name='FastAPI', language='python', framework='fastapi')
ctx = GlobalStateContext(initialization_blocks=[InitializationBlock(code='HOpenConnection(gCnn)', dependencies=['gCnn'], order=0)])

# With init blocks - should include both sections
result_with = PromptBuilder.build_context(op, stack, [], global_state=ctx)
assert '## Initialization Code' in result_with
assert 'HOpenConnection' in result_with
assert 'asynccontextmanager' in result_with

# Without init blocks - lifespan pattern should be empty
ctx_empty = GlobalStateContext(variables=[], initialization_blocks=[])
result_without = PromptBuilder.build_context(op, stack, [], global_state=ctx_empty)
assert '## Initialization Code' in result_without
assert 'asynccontextmanager' not in result_without

print('All checks passed')
"
```
</verification>

<success_criteria>
1. PromptBuilder.format_initialization_blocks() exists and returns WLanguage code in markdown
2. PromptBuilder.format_lifespan_pattern() exists and returns FastAPI lifespan documentation
3. PROMPT_TEMPLATE includes "## Initialization Code" section with placeholders
4. build_context() correctly populates both placeholders
5. Lifespan pattern conditionally shown only when init blocks exist
6. Long init code (>100 lines) truncated with indicator
</success_criteria>

<output>
After completion, create `.planning/phases/21-initialization-code/21-01-SUMMARY.md`
</output>
