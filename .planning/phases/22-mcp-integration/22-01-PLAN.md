---
phase: 22-mcp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/services/prompt_builder.py
autonomous: true

must_haves:
  truths:
    - "CONTEXT.md includes MCP Server Integration section with tool documentation"
    - "All user-derived identifiers (tables, connections, variables) are sanitized to [A-Za-z0-9_]"
    - "CONTEXT.md includes .mcp.json configuration example"
    - "Write operations documented as advanced with explicit confirmation requirement"
  artifacts:
    - path: "src/wxcode/services/prompt_builder.py"
      provides: "sanitize_identifier function, format_mcp_instructions method, updated PROMPT_TEMPLATE"
      exports: ["sanitize_identifier", "format_mcp_instructions"]
  key_links:
    - from: "format_tables()"
      to: "sanitize_identifier()"
      via: "sanitizes table names before markdown output"
      pattern: "sanitize_identifier\\(.*name"
    - from: "format_connections()"
      to: "sanitize_identifier()"
      via: "sanitizes connection names before markdown output"
      pattern: "sanitize_identifier\\(.*name"
    - from: "format_global_state()"
      to: "sanitize_identifier()"
      via: "sanitizes variable names before markdown output"
      pattern: "sanitize_identifier\\(.*name"
    - from: "build_context()"
      to: "format_mcp_instructions()"
      via: "includes MCP section in CONTEXT.md"
      pattern: "format_mcp_instructions"
---

<objective>
Add MCP tool instructions to CONTEXT.md with prompt injection prevention via identifier sanitization.

Purpose: Enable AI assistants using CONTEXT.md to query the wxcode-kb MCP server for additional context during code generation, while preventing malicious element/table/connection names from injecting instructions.

Output: Updated prompt_builder.py with sanitize_identifier() function, sanitized formatters, and new MCP instructions section in PROMPT_TEMPLATE.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-mcp-integration/22-RESEARCH.md
@src/wxcode/services/prompt_builder.py
@docs/mcp-gsd-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sanitize_identifier and apply to formatters</name>
  <files>src/wxcode/services/prompt_builder.py</files>
  <action>
Add sanitize_identifier function at module level (after imports, before _is_sensitive_name):

```python
import re

def sanitize_identifier(name: str, max_length: int = 100) -> str:
    """
    Sanitiza identificador para inclusao segura em CONTEXT.md.

    Remove caracteres fora de [A-Za-z0-9_] para prevenir prompt injection.
    Preserva case original (diferente de workspace_manager que usa lowercase).

    Args:
        name: Nome original (elemento, tabela, conexao, variavel)
        max_length: Comprimento maximo (default 100)

    Returns:
        Nome sanitizado seguro para inclusao em prompts
    """
    if not name:
        return ""
    return re.sub(r'[^A-Za-z0-9_]', '_', name)[:max_length]
```

Update format_tables() to sanitize table names:
- Line ~187: `lines.append(f"### {sanitize_identifier(table['name'])}")`
- Keep physical_name display as-is (it's informational, not actionable)

Update format_connections() to sanitize connection names:
- Line ~241-242: `name = sanitize_identifier(getattr(conn, 'name', 'Unknown'))`

Update format_global_state() to sanitize variable names:
- Line ~315-316: `f"| \`{sanitize_identifier(var.name)}\` | {wl_type} | ..."`

Update format_initialization_blocks() to sanitize dependency names:
- Line ~378-380: `deps_str = ", ".join(f"\`{sanitize_identifier(d)}\`" for d in deps)`
- Line ~380: Same pattern for truncated deps

Note: Use existing `re` import already available via standard library.
  </action>
  <verify>
Check sanitize_identifier exists and is applied:
```bash
grep -n "def sanitize_identifier" src/wxcode/services/prompt_builder.py
grep -n "sanitize_identifier(" src/wxcode/services/prompt_builder.py | wc -l
```
Expected: function defined, at least 5 usages (4 formatters + definition)
  </verify>
  <done>
sanitize_identifier function added and applied to format_tables, format_connections, format_global_state, and format_initialization_blocks. All user-derived identifiers are now sanitized to [A-Za-z0-9_] before inclusion in CONTEXT.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MCP instructions section to PROMPT_TEMPLATE</name>
  <files>src/wxcode/services/prompt_builder.py</files>
  <action>
Add new static method format_mcp_instructions() to PromptBuilder class:

```python
@staticmethod
def format_mcp_instructions(project_name: str) -> str:
    """
    Gera secao de instrucoes MCP para CONTEXT.md.

    Documenta ferramentas disponiveis do servidor wxcode-kb
    para consultas dinamicas durante geracao de codigo.

    Args:
        project_name: Nome do projeto (sanitizado) para exemplos

    Returns:
        String markdown com instrucoes MCP
    """
    safe_project = sanitize_identifier(project_name)
    return f'''## MCP Server Integration

This project has a wxcode-kb MCP server configured for querying the WinDev knowledge base.

### Configuration (.mcp.json)

```json
{{
  "mcpServers": {{
    "wxcode-kb": {{
      "command": "python",
      "args": ["-m", "wxcode.mcp.server"],
      "env": {{
        "PYTHONPATH": "/path/to/wxcode/src"
      }}
    }}
  }}
}}
```

### Available Tools (Read-Only)

| Tool | Purpose | Key Parameters |
|------|---------|----------------|
| `get_element` | Get element definition with AST | `element_name`, `project_name` |
| `list_elements` | List elements with filters | `project_name`, `source_type`, `layer` |
| `search_code` | Search code patterns (regex) | `pattern`, `project_name` |
| `get_controls` | Get UI control hierarchy | `element_name`, `project_name` |
| `get_procedures` | List element procedures | `element_name`, `include_code` |
| `get_schema` | Get database schema overview | `project_name` |
| `get_table` | Get table column details | `table_name`, `project_name` |
| `get_dependencies` | Get element dependencies | `element_name`, `direction` |
| `get_impact` | Analyze change impact | `element_name`, `depth` |
| `get_conversion_stats` | Get conversion progress | `project_name` |
| `get_conversion_candidates` | Find elements ready to convert | `project_name`, `layer` |

### Usage Examples

```
// Get element source and AST
get_element(element_name="PAGE_Login", project_name="{safe_project}")

// Find elements using a table
search_code(pattern="HReadSeek.*USUARIO", project_name="{safe_project}")

// Get conversion candidates for UI layer
get_conversion_candidates(project_name="{safe_project}", layer="ui")
```

### Write Operations (Advanced)

The `mark_converted` tool can update element status but requires explicit `confirm=True`:

```
// Preview change (no execution)
mark_converted(element_name="PAGE_Login", project_name="{safe_project}")

// Execute change
mark_converted(element_name="PAGE_Login", project_name="{safe_project}", confirm=True)
```

**Important:** Only call write operations when explicitly requested by the user.'''
```

Add `{mcp_instructions}` placeholder to PROMPT_TEMPLATE after `{lifespan_pattern}` and before `## Execution Instructions`:

```markdown
{lifespan_pattern}

{mcp_instructions}

## Execution Instructions
```

Update build_context() method:
1. Add project_name sanitization for MCP examples
2. Add format_mcp_instructions() call in the format() chain

```python
mcp_instructions=cls.format_mcp_instructions(output_project.name),
```

Note: The project_name is already available via output_project.name. No signature change needed.
  </action>
  <verify>
Check MCP section exists in template and method:
```bash
grep -n "mcp_instructions" src/wxcode/services/prompt_builder.py
grep -n "def format_mcp_instructions" src/wxcode/services/prompt_builder.py
grep -n "MCP Server Integration" src/wxcode/services/prompt_builder.py
```
Expected: mcp_instructions in template, format_mcp_instructions method, MCP Server Integration heading
  </verify>
  <done>
MCP Server Integration section added to PROMPT_TEMPLATE with:
- .mcp.json configuration reference
- Read-only tools table (11 main tools)
- Usage examples with sanitized project name
- Write operations section with confirmation requirement
- Explicit warning about user intent for write operations
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify sanitization works:
```bash
python -c "
import sys
sys.path.insert(0, 'src')
from wxcode.services.prompt_builder import sanitize_identifier
# Test normal case
assert sanitize_identifier('PAGE_Login') == 'PAGE_Login'
# Test with special chars
assert sanitize_identifier('TABLE:USUARIO') == 'TABLE_USUARIO'
# Test with injection attempt
assert sanitize_identifier('x\"; DROP TABLE--') == 'x___DROP_TABLE__'
# Test empty
assert sanitize_identifier('') == ''
print('sanitize_identifier: OK')
"
```

2. Verify template compiles:
```bash
python -c "
import sys
sys.path.insert(0, 'src')
from wxcode.services.prompt_builder import PromptBuilder, PROMPT_TEMPLATE
# Check MCP placeholder exists
assert '{mcp_instructions}' in PROMPT_TEMPLATE
# Check format_mcp_instructions exists
assert hasattr(PromptBuilder, 'format_mcp_instructions')
print('PROMPT_TEMPLATE: OK')
"
```

3. Verify end-to-end build_context (optional, requires mock objects):
```bash
python -c "
import sys
sys.path.insert(0, 'src')
from wxcode.services.prompt_builder import PromptBuilder

# Check MCP instructions formatting
mcp = PromptBuilder.format_mcp_instructions('Test_Project')
assert '## MCP Server Integration' in mcp
assert 'get_element' in mcp
assert 'mark_converted' in mcp
assert 'confirm=True' in mcp
print('format_mcp_instructions: OK')
"
```
</verification>

<success_criteria>
1. CONTEXT.md includes `## MCP Server Integration` section with tool table
2. All user-derived identifiers pass through sanitize_identifier() before output
3. .mcp.json configuration example present in CONTEXT.md
4. Write operations documented as "Advanced" with explicit confirmation requirement
5. No new test failures: `pytest tests/` passes
</success_criteria>

<output>
After completion, create `.planning/phases/22-mcp-integration/22-01-SUMMARY.md`
</output>
