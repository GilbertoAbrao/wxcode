# Phase 22: MCP Integration - Research

**Researched:** 2026-01-24
**Domain:** MCP tool documentation in CONTEXT.md with prompt injection prevention
**Confidence:** HIGH

## Summary

This phase adds MCP (Model Context Protocol) tool documentation to the CONTEXT.md file generated by PromptBuilder. The wxcode MCP server already exists and exposes 19 tools for querying project knowledge. The goal is to document these tools in CONTEXT.md so AI assistants can use them effectively during code generation.

The primary security concern is **prompt injection** - where user-derived data (element names, table names, connection names) could contain malicious instructions that manipulate the AI. The solution is to sanitize all user-derived data to the safe character set `[A-Za-z0-9_]` before including it in tool documentation.

**Primary recommendation:** Add a new `## MCP Server Instructions` section to `PROMPT_TEMPLATE`, implement a `sanitize_identifier()` function using the existing pattern from `workspace_manager.py`, and include a `.mcp.json` configuration reference.

## Current State Analysis

### What Already Works (HIGH confidence)

| Component | File | Status |
|-----------|------|--------|
| MCP Server | `mcp/server.py` | Complete - FastMCP with 19 tools |
| MCP Tools | `mcp/tools/*.py` | Complete - elements, controls, procedures, schema, graph, conversion |
| Tool documentation | `docs/mcp-gsd-integration.md` | Complete - detailed tool reference |
| .mcp.json config | `.mcp.json` | Complete - wxcode-kb server configured |
| Identifier sanitization | `workspace_manager.py:88-101` | Complete - `re.sub(r'[^a-z0-9_]', '_', name.lower())[:50]` |

### What's Missing

| Gap | Description |
|-----|-------------|
| MCP section in PROMPT_TEMPLATE | No reference to MCP tools in generated CONTEXT.md |
| Identifier sanitization in PromptBuilder | User data (element names, table names) not sanitized |
| .mcp.json reference | No configuration example for AI assistants |
| Structured data boundaries | No explicit separation of trusted vs untrusted data |

## Architecture Patterns

### Prompt Injection Prevention Strategy

Based on MCP security best practices, the key defenses are:

1. **Input sanitization**: Restrict identifiers to `[A-Za-z0-9_]`
2. **Structured data boundaries**: Use clear separators between system instructions and data
3. **Least privilege**: Document only read-only tools (avoid exposing `mark_converted` unless needed)

### Current PromptBuilder Flow
```
OutputProject API (output_projects.py)
    |
    v
PromptBuilder.write_context_file(output_project, stack, tables, connections, global_state)
    |
    v
CONTEXT.md (tables, connections, global vars, init code)
         ^ NO MCP tools documented
```

### Required Flow
```
OutputProject API (output_projects.py)
    |
    v
PromptBuilder.write_context_file(..., project_name)
    |
    v
CONTEXT.md with:
  - Tables (sanitized names)
  - Connections (sanitized names)
  - Global vars (sanitized names)
  - MCP Server Instructions (NEW)
  - .mcp.json reference (NEW)
```

### Recommended Project Structure Changes

No new files needed. Modifications to existing files:

```
src/wxcode/
└── services/
    └── prompt_builder.py      # Add MCP section + sanitization
```

## Standard Stack

This phase uses only existing project infrastructure:

| Component | Version | Purpose | Already in Project |
|-----------|---------|---------|-------------------|
| Python regex | 3.11+ | Identifier sanitization | Yes |
| FastMCP | latest | MCP server (already running) | Yes |
| Jinja2-style templates | - | PROMPT_TEMPLATE string formatting | Yes |

No new dependencies required.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Identifier sanitization | Custom character filter | `re.sub(r'[^A-Za-z0-9_]', '_', name)` | Proven pattern from workspace_manager.py |
| Tool documentation | Custom tool introspection | Static tool list from mcp-gsd-integration.md | Tool signatures are stable, no need for runtime inspection |
| MCP config generation | Dynamic config builder | Static template with project path placeholder | .mcp.json format is stable |

**Key insight:** The existing sanitization pattern in `workspace_manager.py` (`re.sub(r'[^a-z0-9_]', '_', name.lower())[:50]`) is safe. For identifiers in CONTEXT.md, we should use a similar pattern but preserve case: `re.sub(r'[^A-Za-z0-9_]', '_', name)`.

## Common Pitfalls

### Pitfall 1: Prompt Injection via Identifiers

**What goes wrong:** Malicious element names like `PAGE_Login"; DELETE FROM users; --` could inject SQL-like instructions
**Why it happens:** User-derived data (element names, table names, connection names) included verbatim in CONTEXT.md
**How to avoid:** Sanitize ALL identifiers to `[A-Za-z0-9_]` before including in output
**Warning signs:** Any identifier containing characters outside `[A-Za-z0-9_]`

### Pitfall 2: Tool Poisoning

**What goes wrong:** Including descriptions that instruct the AI to perform unintended actions
**Why it happens:** MCP tools can have malicious descriptions that manipulate AI behavior
**How to avoid:** Use static, vetted tool descriptions - don't include dynamic or user-provided descriptions
**Warning signs:** Tool descriptions containing imperative instructions like "you must", "always", "call X first"

### Pitfall 3: Over-Documenting Write Operations

**What goes wrong:** Exposing `mark_converted` tool prominently leads to unintended state changes
**Why it happens:** AI assistants may call write operations without explicit user intent
**How to avoid:** Document read-only tools prominently; mention write tools as "advanced" with explicit confirmation requirement
**Warning signs:** AI calling `mark_converted` without user request

### Pitfall 4: Missing Structured Boundaries

**What goes wrong:** AI confuses user data with system instructions
**Why it happens:** No clear visual/structural separation between trusted and untrusted content
**How to avoid:** Use markdown headings and fenced code blocks to clearly separate sections
**Warning signs:** User-derived data appearing inline with instructions

### Pitfall 5: Incomplete Character Sanitization

**What goes wrong:** Sanitizer misses edge cases like Unicode characters or null bytes
**Why it happens:** Regex pattern doesn't catch all problematic characters
**How to avoid:** Use allowlist approach `[A-Za-z0-9_]` not denylist
**Warning signs:** Identifiers containing non-ASCII characters passing through

## Code Examples

### Existing Sanitization Pattern (from workspace_manager.py)

```python
# Source: src/wxcode/services/workspace_manager.py lines 87-101
@staticmethod
def _sanitize_name(name: str) -> str:
    """
    Sanitiza nome do projeto para uso no filesystem.

    Converte para lowercase, substitui caracteres inseguros por _,
    e limita a 50 caracteres.
    """
    return re.sub(r'[^a-z0-9_]', '_', name.lower())[:50]
```

### Recommended Pattern: Sanitize Identifier (preserving case)

```python
# Recommended implementation for PromptBuilder
import re

def sanitize_identifier(name: str, max_length: int = 100) -> str:
    """
    Sanitiza identificador para inclusao segura em CONTEXT.md.

    Remove caracteres fora de [A-Za-z0-9_] para prevenir prompt injection.
    Preserva case original (diferente de workspace_manager que usa lowercase).

    Args:
        name: Nome original (elemento, tabela, conexao, variavel)
        max_length: Comprimento maximo (default 100)

    Returns:
        Nome sanitizado seguro para inclusao em prompts
    """
    if not name:
        return ""
    # Allowlist approach - only permit safe characters
    sanitized = re.sub(r'[^A-Za-z0-9_]', '_', name)
    return sanitized[:max_length]
```

### Pattern: MCP Section in PROMPT_TEMPLATE

```markdown
## MCP Server Integration

This project has a wxcode-kb MCP server configured for querying the WinDev knowledge base.

### Configuration (.mcp.json)

```json
{{
  "mcpServers": {{
    "wxcode-kb": {{
      "command": "python",
      "args": ["-m", "wxcode.mcp.server"],
      "env": {{
        "PYTHONPATH": "{project_path}/src"
      }}
    }}
  }}
}}
```

### Available Tools (Read-Only)

| Tool | Purpose | Key Parameters |
|------|---------|----------------|
| `get_element` | Get element definition with AST | `element_name`, `project_name` |
| `list_elements` | List elements with filters | `project_name`, `element_type`, `layer` |
| `search_code` | Search code patterns (regex) | `pattern`, `project_name` |
| `get_controls` | Get UI control hierarchy | `element_name`, `project_name` |
| `get_procedures` | List element procedures | `element_name`, `include_code` |
| `get_schema` | Get database schema overview | `project_name` |
| `get_table` | Get table column details | `table_name`, `project_name` |
| `get_dependencies` | Get element dependencies | `element_name`, `direction` |
| `get_impact` | Analyze change impact | `element_name`, `depth` |
| `get_conversion_stats` | Get conversion progress | `project_name` |
| `get_conversion_candidates` | Find elements ready to convert | `project_name`, `layer` |

### Usage Examples

```
// Get element source and AST
get_element(element_name="{sanitized_element_name}", project_name="{sanitized_project_name}")

// Find elements using a table
search_code(pattern="HReadSeek.*{sanitized_table_name}", project_name="{sanitized_project_name}")
```

### Write Operations (Advanced)

The `mark_converted` tool can update element status but requires explicit `confirm=True`:

```
// Preview change (no execution)
mark_converted(element_name="X", project_name="Y")

// Execute change
mark_converted(element_name="X", project_name="Y", confirm=True)
```

**Important:** Only call write operations when explicitly requested by the user.
```

### Pattern: Apply Sanitization to Existing Formatters

```python
# Extend format_tables to sanitize table names
@staticmethod
def format_tables(tables: list[dict]) -> str:
    """Format tables as markdown with sanitized names."""
    if not tables:
        return "*No tables found for this Configuration.*"

    lines = []
    for table in tables:
        # Sanitize table name for safe inclusion
        safe_name = sanitize_identifier(table['name'])
        lines.append(f"### {safe_name}")
        # ... rest of formatting
    return "\n".join(lines)

# Extend format_connections to sanitize connection names
@staticmethod
def format_connections(connections: list) -> str:
    """Format connections as markdown table with sanitized names."""
    if not connections:
        return "*No external database connections defined.*"

    lines = []
    lines.append("| Connection | Host | Port | Database | Driver |")
    lines.append("|------------|------|------|----------|--------|")

    for conn in connections:
        # Sanitize connection name
        safe_name = sanitize_identifier(getattr(conn, 'name', 'Unknown'))
        host = getattr(conn, 'source', '') or '*local*'
        # ... rest of formatting
        lines.append(f"| {safe_name} | {host} | {port} | {database} | {driver} |")

    return "\n".join(lines)
```

## Security Best Practices (from MCP Specification)

### From Official MCP Security Documentation

**Input Validation (HIGH confidence):**
> "All inputs, from user queries to tool metadata, must be filtered for dangerous patterns, hidden commands, or suspicious payloads before reaching LLM agents."

**Structured Boundaries (HIGH confidence):**
> "Validation systems must implement a layered defense using clear, unambiguous separators (e.g., XML tags or specific JSON fields) to explicitly separate user input, system prompts, and tool-retrieved context."

**Tool Metadata Security (MEDIUM confidence):**
> "Organizations should validate and sanitize all tool metadata and schema fields, and restrict tool execution to controlled, least-privilege environments."

### Key Security Principles Applied

1. **Allowlist sanitization**: Only `[A-Za-z0-9_]` characters permitted
2. **Static tool descriptions**: No dynamic or user-derived tool descriptions
3. **Explicit confirmation**: Write operations require `confirm=True`
4. **Clear sections**: Markdown headings separate system instructions from data
5. **Least privilege**: Read-only tools documented prominently; write tools marked "advanced"

## Implementation Plan

### Task 1: Add sanitize_identifier function

**File:** `src/wxcode/services/prompt_builder.py`

Add at module level:

```python
import re

def sanitize_identifier(name: str, max_length: int = 100) -> str:
    """Sanitiza identificador para inclusao segura em CONTEXT.md."""
    if not name:
        return ""
    return re.sub(r'[^A-Za-z0-9_]', '_', name)[:max_length]
```

### Task 2: Apply sanitization to existing formatters

**File:** `src/wxcode/services/prompt_builder.py`

Update these methods to use `sanitize_identifier()`:
- `format_tables()` - sanitize table names
- `format_connections()` - sanitize connection names
- `format_global_state()` - sanitize variable names
- `format_initialization_blocks()` - sanitize dependency names

### Task 3: Add MCP section to PROMPT_TEMPLATE

**File:** `src/wxcode/services/prompt_builder.py`

1. Add new template variable `{mcp_instructions}` to `PROMPT_TEMPLATE`
2. Add new `format_mcp_instructions()` static method
3. Update `build_context()` to pass project name for sanitized examples

### Task 4: Update build_context signature

**File:** `src/wxcode/services/prompt_builder.py`

Add `project_name: str` parameter to generate sanitized MCP usage examples.

## Success Criteria Verification

| Requirement | How to Verify |
|-------------|---------------|
| MCP-01: MCP tool instructions section | Generated CONTEXT.md contains `## MCP Server Integration` section |
| MCP-02: User data sanitized to [A-Za-z0-9_] | All identifiers pass through `sanitize_identifier()` |
| MCP-03: .mcp.json configuration reference | Generated CONTEXT.md contains JSON code block with .mcp.json example |
| Structured boundaries | Clear markdown heading separation between sections |

## Open Questions

None. The implementation path is clear based on:
1. Existing sanitization pattern in workspace_manager.py
2. Complete MCP tool documentation in mcp-gsd-integration.md
3. Established PROMPT_TEMPLATE structure

## Sources

### Primary (HIGH confidence)
- `src/wxcode/services/prompt_builder.py` - Current PromptBuilder implementation
- `src/wxcode/services/workspace_manager.py` - Existing sanitization pattern (lines 87-101)
- `src/wxcode/mcp/server.py` - MCP server implementation
- `src/wxcode/mcp/tools/__init__.py` - Tool registry
- `docs/mcp-gsd-integration.md` - Complete tool documentation
- `.mcp.json` - Current MCP configuration

### Secondary (MEDIUM confidence)
- [MCP Security Best Practices](https://modelcontextprotocol.io/specification/draft/basic/security_best_practices) - Official specification
- [Simon Willison: MCP Prompt Injection](https://simonwillison.net/2025/Apr/9/mcp-prompt-injection/) - Security analysis
- [Practical DevSecOps: MCP Security](https://www.practical-devsecops.com/mcp-security-vulnerabilities/) - Vulnerability patterns

### Tertiary (LOW confidence)
- Web search results for "MCP prompt injection sanitization 2026"

## Metadata

**Confidence breakdown:**
- Sanitization pattern: HIGH - existing code in workspace_manager.py
- MCP tool list: HIGH - stable, documented in mcp-gsd-integration.md
- Security best practices: MEDIUM - official docs + community sources
- Template integration: HIGH - straightforward extension of existing pattern

**Research date:** 2026-01-24
**Valid until:** 60 days (stable internal API, no external dependencies)
