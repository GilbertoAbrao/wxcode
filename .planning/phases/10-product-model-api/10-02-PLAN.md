---
phase: 10-product-model-api
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/wxcode/api/products.py
  - src/wxcode/main.py
autonomous: true

must_haves:
  truths:
    - "POST /api/products creates product and returns 201"
    - "GET /api/products lists products with optional filters"
    - "GET /api/products/{id} returns single product"
    - "PATCH /api/products/{id} updates product status"
    - "DELETE /api/products/{id} removes product"
    - "Products of type api, mcp, agents are created with status unavailable"
  artifacts:
    - path: "src/wxcode/api/products.py"
      provides: "CRUD API endpoints for products"
      exports: ["router"]
    - path: "src/wxcode/main.py"
      provides: "Router registration"
      contains: "products.router"
  key_links:
    - from: "src/wxcode/api/products.py"
      to: "src/wxcode/models/product.py"
      via: "Product model import"
      pattern: "from wxcode.models.product import Product"
    - from: "src/wxcode/api/products.py"
      to: "src/wxcode/models/project.py"
      via: "Project model for validation"
      pattern: "from wxcode.models.project import Project"
    - from: "src/wxcode/main.py"
      to: "src/wxcode/api/products.py"
      via: "Router import"
      pattern: "from wxcode.api import.*products"
---

<objective>
Create CRUD API endpoints for products and register the router in the FastAPI application.

Purpose: Enable frontend and services to create, read, update, and delete products. Products of unavailable types (api, mcp, agents) are automatically marked with status `unavailable`.

Output: Fully functional `/api/products` endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-product-model-api/10-RESEARCH.md
@.planning/phases/10-product-model-api/10-01-SUMMARY.md

# Reference patterns
@src/wxcode/api/projects.py
@src/wxcode/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create products API router with CRUD endpoints</name>
  <files>src/wxcode/api/products.py</files>
  <action>
Create new file `src/wxcode/api/products.py` following the projects.py pattern:

1. Define constant `AVAILABLE_PRODUCT_TYPES = {ProductType.CONVERSION}` at module level

2. Create Pydantic response/request models:
   - `ProductResponse(BaseModel)`: id, project_id, project_name, product_type, status, workspace_path, session_id, output_directory, created_at, updated_at
   - `ProductListResponse(BaseModel)`: products (list[ProductResponse]), total (int)
   - `CreateProductRequest(BaseModel)`: project_id (str), product_type (ProductType)
   - `UpdateProductRequest(BaseModel)`: status (Optional[ProductStatus]), session_id (Optional[str]), output_directory (Optional[str])

3. Create router = APIRouter()

4. Implement endpoints:

   a. `POST /` (create_product):
      - Validate project_id (convert to PydanticObjectId, return 400 if invalid)
      - Fetch project, return 404 if not found
      - Check project.workspace_path exists, return 400 if None
      - Set initial_status = PENDING if product_type in AVAILABLE_PRODUCT_TYPES else UNAVAILABLE
      - Create Product with project.id (not string), product_type, workspace_path, status
      - Return 201 with ProductResponse

   b. `GET /` (list_products):
      - Accept optional filters: project_id, product_type, status, skip, limit
      - Build query dict from filters
      - For project_id filter, use "project_id.$id" as key (Beanie Link query pattern)
      - Fetch products and total count
      - For each product, fetch project to get project_name (use display_name or name)
      - Return ProductListResponse

   c. `GET /{product_id}` (get_product):
      - Fetch product by ID, return 404 if not found
      - Fetch project for project_name
      - Return ProductResponse

   d. `PATCH /{product_id}` (update_product):
      - Fetch product, return 404 if not found
      - Update fields from request body (only if not None)
      - If status changes to IN_PROGRESS and started_at is None, set started_at
      - If status changes to COMPLETED or FAILED, set completed_at
      - Always update updated_at
      - Save and return ProductResponse

   e. `DELETE /{product_id}` (delete_product):
      - Fetch product, return 404 if not found
      - Delete product
      - Return {"message": "Produto removido com sucesso", "id": product_id}

Use Portuguese docstrings and error messages following codebase convention.
  </action>
  <verify>
python -c "from wxcode.api.products import router; print(f'Routes: {len(router.routes)}')"
  </verify>
  <done>
Products API router exists with 5 endpoints (POST /, GET /, GET /{id}, PATCH /{id}, DELETE /{id}). Unavailable types logic implemented in create endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register products router in main.py</name>
  <files>src/wxcode/main.py</files>
  <action>
Update `src/wxcode/main.py`:

1. Add products to the import statement:
   Change: `from wxcode.api import projects, elements, conversions, websocket, import_wizard, import_wizard_ws, tree`
   To: `from wxcode.api import projects, elements, conversions, websocket, import_wizard, import_wizard_ws, tree, products`

2. Add router registration after existing routers (around line 62):
   `app.include_router(products.router, prefix="/api/products", tags=["Products"])`

Place it logically after conversions router since products are related to conversions.
  </action>
  <verify>
python -c "from wxcode.main import app; routes = [r.path for r in app.routes]; assert '/api/products/' in routes or any('/api/products' in str(r) for r in routes); print('Router registered')"
  </verify>
  <done>
Products router registered in main.py at /api/products with Products tag. Endpoint visible in OpenAPI docs.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify API module loads
cd /Users/gilberto/projetos/wxk/wxcode
python -c "
from wxcode.api.products import router
print(f'Products router has {len(router.routes)} routes')
for route in router.routes:
    if hasattr(route, 'methods'):
        print(f'  {list(route.methods)} {route.path}')
"

# Verify main.py includes the router
python -c "
from wxcode.main import app
products_routes = [r for r in app.routes if hasattr(r, 'path') and 'products' in r.path]
print(f'Found {len(products_routes)} products routes in app')
"

# Optional: Start server and test (if MongoDB available)
# uvicorn wxcode.main:app --port 8001 &
# curl -X GET http://localhost:8001/api/products/
```
</verification>

<success_criteria>
- Products router exists at `src/wxcode/api/products.py`
- Router has 5 endpoints: POST /, GET /, GET /{id}, PATCH /{id}, DELETE /{id}
- Create endpoint sets status=unavailable for api, mcp, agents types
- Create endpoint sets status=pending for conversion type
- Router registered in main.py at /api/products
- All endpoints visible in FastAPI OpenAPI docs (/docs)
</success_criteria>

<output>
After completion, create `.planning/phases/10-product-model-api/10-02-SUMMARY.md`
</output>
