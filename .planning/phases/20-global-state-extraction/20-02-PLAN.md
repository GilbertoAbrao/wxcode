---
phase: 20-global-state-extraction
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/wxcode/services/prompt_builder.py
  - src/wxcode/api/output_projects.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CONTEXT.md includes Global State section with variables table showing name, type, default, scope, mapping"
    - "CONTEXT.md includes Global State Conversion Patterns section with scope-to-pattern documentation"
    - "Sensitive variable names (token, secret, password, key) have default values redacted"
  artifacts:
    - path: "src/wxcode/services/prompt_builder.py"
      provides: "format_global_state(), format_scope_patterns(), extended PROMPT_TEMPLATE"
      min_lines: 350
    - path: "src/wxcode/api/output_projects.py"
      provides: "Global state extraction and passing to PromptBuilder"
  key_links:
    - from: "src/wxcode/api/output_projects.py"
      to: "src/wxcode/services/schema_extractor.py"
      via: "import and call extract_global_state_for_project()"
      pattern: "extract_global_state_for_project"
    - from: "src/wxcode/api/output_projects.py"
      to: "src/wxcode/services/prompt_builder.py"
      via: "pass global_state to write_context_file()"
      pattern: "global_state=global_state"
    - from: "src/wxcode/services/prompt_builder.py"
      to: "PROMPT_TEMPLATE"
      via: "format_global_state and format_scope_patterns in template"
      pattern: "global_state_table|scope_patterns"
---

<objective>
Extend PromptBuilder with global state formatting and wire API to extract and pass global state.

Purpose: Converted starter projects need to understand the global variables used by the original WinDev project, their types, scopes, and recommended Python conversion patterns (env vars, settings, DI).

Output:
- PromptBuilder.format_global_state() formats variables as markdown table with scope annotations
- PromptBuilder.format_scope_patterns() documents conversion patterns for each scope
- PROMPT_TEMPLATE includes Global State and Conversion Patterns sections
- API extracts global state and passes to PromptBuilder for CONTEXT.md generation
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-global-state-extraction/20-RESEARCH.md

# Prior plan summary for context
@.planning/phases/20-global-state-extraction/20-01-SUMMARY.md

# Source files being modified
@src/wxcode/services/prompt_builder.py
@src/wxcode/api/output_projects.py

# Reference for GlobalStateContext structure
@src/wxcode/models/global_state_context.py
@src/wxcode/parser/global_state_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PromptBuilder with global state formatting</name>
  <files>src/wxcode/services/prompt_builder.py</files>
  <action>
  Add global state formatting methods and extend PROMPT_TEMPLATE.

  **Add import** at top of file (after existing imports):
  ```python
  from wxcode.models.global_state_context import GlobalStateContext
  from wxcode.parser.global_state_extractor import Scope
  ```

  **Add helper function** before PromptBuilder class:
  ```python
  def _is_sensitive_name(name: str) -> bool:
      """
      Detecta nomes de variaveis potencialmente sensiveis.

      Args:
          name: Nome da variavel

      Returns:
          True se nome contem padrao sensivel
      """
      sensitive_patterns = ["token", "secret", "password", "key", "pwd", "auth", "credential"]
      name_lower = name.lower()
      return any(p in name_lower for p in sensitive_patterns)


  def _scope_to_mapping(scope: Scope) -> str:
      """
      Mapeia escopo WinDev para padrao Python recomendado.

      Args:
          scope: Escopo da variavel (APP, MODULE, REQUEST)

      Returns:
          String descrevendo padrao Python recomendado
      """
      return {
          Scope.APP: "Environment variable / Settings class",
          Scope.MODULE: "Module singleton / FastAPI Depends()",
          Scope.REQUEST: "Request context / Depends()",
      }.get(scope, "Unknown")
  ```

  **Add format_global_state() static method** after format_env_example():
  ```python
  @staticmethod
  def format_global_state(global_state: GlobalStateContext) -> str:
      """
      Formata variaveis globais como tabela markdown com anotacoes de escopo.

      Variaveis com nomes sensiveis (token, secret, etc.) tem valores
      default redatados para seguranca.

      Args:
          global_state: Contexto com variaveis globais extraidas

      Returns:
          String markdown formatada
      """
      if not global_state or not global_state.variables:
          return "*No global variables defined.*"

      lines = []
      lines.append("| Variable | Type | Default | Scope | Recommended Mapping |")
      lines.append("|----------|------|---------|-------|---------------------|")

      for var in global_state.variables:
          # Redact sensitive-looking defaults
          default = var.default_value or "*none*"
          if _is_sensitive_name(var.name):
              default = "*[REDACTED]*"

          # Recommend mapping based on scope
          mapping = _scope_to_mapping(var.scope)

          # Truncate long type names
          wl_type = var.wlanguage_type
          if len(wl_type) > 30:
              wl_type = wl_type[:27] + "..."

          lines.append(
              f"| `{var.name}` | {wl_type} | {default} | {var.scope.value} | {mapping} |"
          )

      return "\n".join(lines)
  ```

  **Add format_scope_patterns() static method** after format_global_state():
  ```python
  @staticmethod
  def format_scope_patterns() -> str:
      """
      Gera documentacao de padroes de conversao para escopos globais.

      Returns:
          String markdown com padroes de conversao detalhados
      """
      return '''### Scope Conversion Patterns

| Original Scope | Recommended Python Pattern |
|----------------|---------------------------|
| APP (Project Code) | Environment variables via `pydantic.BaseSettings` |
| MODULE (Set of Procedures) | FastAPI dependency injection or module-level singleton |
| REQUEST (Page-level) | Request context via `request.state` or `Depends()` |

### Example Conversions

**Connection globals (`gCnn is Connection`):**
- Use `DATABASE_URL` environment variable
- Configure in `app/core/config.py` as Settings field
- Inject via `Depends(get_db_session)`

**JSON parameter globals (`gjParametros is JSON`):**
- Move to Settings class if static configuration
- Use request context if per-request data

**Session/Auth globals (`gsAccessToken`, `gUsuarioLogado`):**
- Use FastAPI's built-in authentication
- Store in `request.state` after auth middleware'''
  ```

  **Update PROMPT_TEMPLATE** - Add two new sections after `## Environment Variables (.env.example)` and before `## Execution Instructions`:

  Find the line with `{env_example}` in PROMPT_TEMPLATE and after it add:
  ```
  ## Global State ({global_var_count} variables)

  {global_state_table}

  {scope_patterns}
  ```

  **Update build_context() signature and implementation:**
  - Add parameter: `global_state: GlobalStateContext = None`
  - Add to format call:
    - `global_state_table=cls.format_global_state(global_state)`
    - `scope_patterns=cls.format_scope_patterns() if global_state and global_state.variables else ""`
    - `global_var_count=len(global_state.variables) if global_state else 0`

  **Update write_context_file() signature and implementation:**
  - Add parameter: `global_state: GlobalStateContext = None`
  - Pass `global_state=global_state` to `build_context()`

  **IMPORTANT:**
  - Use `_is_sensitive_name()` to redact default values that might contain secrets
  - Truncate long type names (like "array of stRecebiceisSintetico") to keep table readable
  - Only show scope_patterns section if there are actual global variables
  - Import Scope from global_state_extractor (not from global_state_context)
  </action>
  <verify>
  ```bash
  cd /Users/gilberto/projetos/wxk/wxcode
  python -c "from wxcode.services.prompt_builder import PromptBuilder; print(hasattr(PromptBuilder, 'format_global_state'), hasattr(PromptBuilder, 'format_scope_patterns'))"
  python -c "from wxcode.services.prompt_builder import _is_sensitive_name, _scope_to_mapping; print('Helpers OK')"
  grep -q "global_state_table" src/wxcode/services/prompt_builder.py && echo "Template updated"
  grep -q "global_state:" src/wxcode/services/prompt_builder.py && echo "Parameter added"
  ```
  </verify>
  <done>
  - PromptBuilder has format_global_state() static method
  - PromptBuilder has format_scope_patterns() static method
  - Helper functions _is_sensitive_name() and _scope_to_mapping() exist
  - PROMPT_TEMPLATE includes {global_state_table}, {scope_patterns}, {global_var_count} placeholders
  - build_context() and write_context_file() accept global_state parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire API to extract and pass global state</name>
  <files>src/wxcode/api/output_projects.py</files>
  <action>
  Update the API to extract global state and pass to PromptBuilder.

  **Update import** at top of file to include new function:
  ```python
  from wxcode.services.schema_extractor import (
      extract_schema_for_configuration,
      extract_connections_for_project,
      extract_global_state_for_project,
  )
  ```

  **In initialize_output_project() WebSocket handler**, after the connections extraction block (around line 350), add:
  ```python
  # Extrair estado global do projeto
  global_state = await extract_global_state_for_project(output_project.kb_id)

  await websocket.send_json({
      "type": "info",
      "message": f"Estado global extraido: {len(global_state.variables)} variavel(is) encontrada(s)"
  })
  ```

  **Update the PromptBuilder.write_context_file() call** (around line 360) to pass global_state:
  ```python
  context_path = PromptBuilder.write_context_file(
      output_project=output_project,
      stack=stack,
      tables=tables,
      connections=connections,
      global_state=global_state,
      workspace_path=workspace_path,
  )
  ```

  **IMPORTANT:**
  - Call extract_global_state_for_project() AFTER connections extraction
  - Use `len(global_state.variables)` for the count (GlobalStateContext has .variables list)
  - The function is async, so use `await`
  </action>
  <verify>
  ```bash
  cd /Users/gilberto/projetos/wxk/wxcode
  python -c "from wxcode.api.output_projects import router; print('API imports OK')"
  grep -q "extract_global_state_for_project" src/wxcode/api/output_projects.py && echo "Import added"
  grep -q "global_state=global_state" src/wxcode/api/output_projects.py && echo "Passing global_state"
  ```
  </verify>
  <done>
  - API imports extract_global_state_for_project from schema_extractor
  - initialize_output_project() calls extract_global_state_for_project()
  - Global state is passed to PromptBuilder.write_context_file()
  - WebSocket sends info message with global variable count
  </done>
</task>

</tasks>

<verification>
Run full verification after both tasks:

```bash
cd /Users/gilberto/projetos/wxk/wxcode

# 1. Verify all imports work
python -c "
from wxcode.services.prompt_builder import PromptBuilder, _is_sensitive_name, _scope_to_mapping
from wxcode.services.schema_extractor import extract_global_state_for_project
from wxcode.api.output_projects import router
print('All imports OK')
"

# 2. Verify template has new sections
grep -q "Global State" src/wxcode/services/prompt_builder.py && echo "GLOBAL section OK"
grep -q "global_state_table" src/wxcode/services/prompt_builder.py && echo "TABLE placeholder OK"
grep -q "scope_patterns" src/wxcode/services/prompt_builder.py && echo "PATTERNS placeholder OK"

# 3. Verify API wiring
grep -q "global_state=global_state" src/wxcode/api/output_projects.py && echo "API wiring OK"

# 4. Test sensitive name detection
python -c "
from wxcode.services.prompt_builder import _is_sensitive_name
assert _is_sensitive_name('gsAccessToken') == True
assert _is_sensitive_name('gsPassword') == True
assert _is_sensitive_name('gUsuario') == False
assert _is_sensitive_name('gnTimeout') == False
print('Sensitive name detection OK')
"

# 5. Run existing tests (should still pass)
pytest tests/test_prompt_builder.py -v 2>/dev/null || echo "No existing tests for prompt_builder"
```
</verification>

<success_criteria>
All requirements covered:

| Requirement | Verification |
|-------------|--------------|
| GSTATE-04: Global variables table in CONTEXT.md | format_global_state() creates table with name/type/default/scope |
| GSTATE-05: Mapping pattern documented | format_scope_patterns() includes scope-to-pattern table |
| Sensitive data protection | _is_sensitive_name() redacts defaults for token/secret/password/key variables |
</success_criteria>

<output>
After completion, create `.planning/phases/20-global-state-extraction/20-02-SUMMARY.md`
</output>
