---
phase: 12-conversion-product
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/services/conversion_wizard.py
  - src/wxcode/api/products.py
autonomous: true

must_haves:
  truths:
    - "ConversionWizard creates .planning/ in workspace/conversion/ directory"
    - "GSDInvoker runs with cwd=workspace_path/conversion"
    - "Product /resume endpoint exists and updates status"
  artifacts:
    - path: "src/wxcode/services/conversion_wizard.py"
      provides: "Wizard orchestration service"
      exports: ["ConversionWizard"]
    - path: "src/wxcode/api/products.py"
      provides: "Products CRUD + resume endpoint"
      contains: "@router.post(\"/{product_id}/resume\")"
  key_links:
    - from: "conversion_wizard.py"
      to: "workspace_manager.py"
      via: "ensure_product_directory call"
      pattern: "WorkspaceManager\\.ensure_product_directory"
    - from: "conversion_wizard.py"
      to: "gsd_context_collector.py"
      via: "context collection"
      pattern: "GSDContextCollector"
---

<objective>
Create ConversionWizard service and resume endpoint for conversion products.

Purpose: Provides backend infrastructure for element conversion with isolated workspace directories. The wizard creates `.planning/` in the correct location (workspace/conversion/) and the resume endpoint allows continuing paused conversions.

Output: ConversionWizard service class and /products/{id}/resume POST endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-conversion-product/12-RESEARCH.md

# Existing infrastructure
@src/wxcode/services/workspace_manager.py
@src/wxcode/services/gsd_context_collector.py
@src/wxcode/services/gsd_invoker.py
@src/wxcode/api/products.py
@src/wxcode/models/product.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConversionWizard service</name>
  <files>src/wxcode/services/conversion_wizard.py</files>
  <action>
Create `src/wxcode/services/conversion_wizard.py` with:

```python
"""
Conversion Wizard Service - Orchestrates element conversion with checkpoints.

This service:
1. Creates isolated conversion workspace in {workspace_path}/conversion/
2. Sets up .planning/ directory structure for GSD
3. Collects element context via GSDContextCollector
4. Creates CONTEXT.md in the conversion directory
5. Configures GSDInvoker with correct cwd
"""

from datetime import datetime
from pathlib import Path
from typing import Optional

from beanie import PydanticObjectId
from motor.motor_asyncio import AsyncIOMotorClient

from wxcode.models import Element, Project
from wxcode.models.product import Product, ProductStatus
from wxcode.services.gsd_context_collector import GSDContextCollector, GSDContextWriter
from wxcode.services.workspace_manager import WorkspaceManager


class ConversionWizardError(Exception):
    """Erro no wizard de conversao."""
    pass


class ConversionWizard:
    """Orchestrates element conversion via GSD workflow."""

    def __init__(self, product: Product, project: Project):
        """
        Args:
            product: Product instance to convert
            project: Project instance
        """
        self.product = product
        self.project = project
        self.workspace_path = Path(product.workspace_path)

    async def setup_conversion_workspace(
        self,
        element_names: list[str],
        mongo_client: AsyncIOMotorClient,
        neo4j_conn=None,
    ) -> Path:
        """
        Creates conversion workspace with CONTEXT.md for selected elements.

        IMPORTANT: Creates .planning/ in workspace/conversion/, NOT project root.
        This ensures isolation per CONV-02 requirement.

        Args:
            element_names: Elements to convert (uses first for context)
            mongo_client: MongoDB client for context collection
            neo4j_conn: Optional Neo4j connection for dependency analysis

        Returns:
            Path to conversion directory with CONTEXT.md

        Raises:
            ConversionWizardError: If element not found or context collection fails
        """
        # 1. Ensure product directory exists
        conversion_dir = WorkspaceManager.ensure_product_directory(
            self.workspace_path, "conversion"
        )

        # 2. Create .planning structure for GSD (CRITICAL for CONV-02)
        planning_dir = conversion_dir / ".planning"
        planning_dir.mkdir(exist_ok=True)
        (planning_dir / "phases").mkdir(exist_ok=True)

        # 3. Validate element exists
        if not element_names:
            raise ConversionWizardError("Nenhum elemento especificado para conversao")

        element_name = element_names[0]  # GSD handles one at a time

        # 4. Collect context using existing service
        collector = GSDContextCollector(mongo_client, neo4j_conn)
        try:
            context_data = await collector.collect(
                element_name=element_name,
                project_name=self.project.name,
                depth=2,
            )
        except ValueError as e:
            raise ConversionWizardError(f"Elemento nao encontrado: {e}")
        except Exception as e:
            raise ConversionWizardError(f"Erro ao coletar contexto: {e}")

        # 5. Write context files to conversion directory
        writer = GSDContextWriter(conversion_dir)
        files = writer.write_all(context_data, branch_name="main")

        # 6. Update product with output directory
        self.product.output_directory = str(conversion_dir)
        self.product.updated_at = datetime.utcnow()
        await self.product.save()

        return conversion_dir

    @staticmethod
    def get_gsd_invoker(conversion_dir: Path):
        """
        Creates GSDInvoker configured for conversion workspace.

        CRITICAL (CONV-03): cwd is set to conversion_dir so .planning/
        is created there, not in project root.

        Args:
            conversion_dir: Path to workspace/conversion/ directory

        Returns:
            Configured GSDInvoker instance

        Raises:
            ValueError: If CONTEXT.md not found
        """
        from wxcode.services.gsd_invoker import GSDInvoker

        context_md = conversion_dir / "CONTEXT.md"
        if not context_md.exists():
            raise ValueError(f"CONTEXT.md nao encontrado em {conversion_dir}")

        return GSDInvoker(
            context_md_path=context_md,
            working_dir=conversion_dir,  # CRITICAL: GSD runs HERE
        )

    async def validate_elements(
        self,
        element_names: list[str],
    ) -> list[Element]:
        """
        Validates that all specified elements exist in the project.

        Args:
            element_names: List of element source_names to validate

        Returns:
            List of Element objects

        Raises:
            ConversionWizardError: If any element not found
        """
        elements = []
        missing = []

        for name in element_names:
            element = await Element.find_one(
                {
                    "project_id.$id": self.project.id,
                    "source_name": name,
                }
            )
            if element:
                elements.append(element)
            else:
                missing.append(name)

        if missing:
            raise ConversionWizardError(
                f"Elementos nao encontrados: {', '.join(missing)}"
            )

        return elements
```

Key aspects:
- `setup_conversion_workspace` creates `.planning/` in workspace/conversion/
- `get_gsd_invoker` returns invoker with `working_dir=conversion_dir`
- Uses existing GSDContextCollector and GSDContextWriter
- Validates elements before conversion starts
  </action>
  <verify>python -c "from wxcode.services.conversion_wizard import ConversionWizard, ConversionWizardError; print('OK')"</verify>
  <done>ConversionWizard class exists with setup_conversion_workspace and get_gsd_invoker methods</done>
</task>

<task type="auto">
  <name>Task 2: Add resume endpoint to products API</name>
  <files>src/wxcode/api/products.py</files>
  <action>
Add resume endpoint to `src/wxcode/api/products.py` after the delete endpoint:

```python
@router.post("/{product_id}/resume")
async def resume_product(
    product_id: str,
    user_message: Optional[str] = None,
) -> dict:
    """
    Resume a paused conversion product.

    This endpoint:
    1. Validates product exists and is in resumable state
    2. Updates status to IN_PROGRESS
    3. Returns instruction to connect via WebSocket

    The actual resume happens via WebSocket /ws/{conversion_id} with action="resume".

    Args:
        product_id: Product ID to resume
        user_message: Optional message to send when resuming

    Returns:
        Confirmation with next steps
    """
    try:
        product_oid = PydanticObjectId(product_id)
    except Exception:
        raise HTTPException(status_code=400, detail="ID de produto invalido")

    product = await Product.get(product_oid)
    if not product:
        raise HTTPException(status_code=404, detail="Produto nao encontrado")

    # Only PAUSED or IN_PROGRESS products can be resumed
    if product.status not in (ProductStatus.PAUSED, ProductStatus.IN_PROGRESS):
        raise HTTPException(
            status_code=400,
            detail=f"Produto nao pode ser retomado (status: {product.status.value})"
        )

    # Update status to IN_PROGRESS
    product.status = ProductStatus.IN_PROGRESS
    product.updated_at = datetime.utcnow()
    await product.save()

    return {
        "message": "Produto pronto para retomar",
        "product_id": product_id,
        "status": product.status.value,
        "output_directory": product.output_directory,
        "instruction": "Conecte ao WebSocket /api/conversions/ws/{session_id} com action='resume'"
    }
```

Also add PAUSED to the imports and allowed status transitions in the update endpoint.
  </action>
  <verify>curl -X POST http://localhost:8000/api/products/test123/resume 2>/dev/null | grep -q "invalido" && echo "OK (endpoint exists)"</verify>
  <done>POST /products/{id}/resume endpoint exists and validates product state</done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from wxcode.services.conversion_wizard import ConversionWizard"`
2. API check: Start server and verify endpoint exists via OpenAPI docs
3. Code review: Ensure ConversionWizard uses workspace_path/conversion/ for cwd
</verification>

<success_criteria>
- ConversionWizard service exists with setup_conversion_workspace method
- get_gsd_invoker returns invoker with working_dir=conversion_dir
- Products API has /resume endpoint
- All imports resolve correctly
</success_criteria>

<output>
After completion, create `.planning/phases/12-conversion-product/12-01-SUMMARY.md`
</output>
