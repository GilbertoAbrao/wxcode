---
phase: 19-connection-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/services/schema_extractor.py
  - src/wxcode/services/prompt_builder.py
  - src/wxcode/api/output_projects.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CONTEXT.md includes Database Connections section with connection table"
    - "Connection table shows host, port, database, driver (no passwords)"
    - "CONTEXT.md includes .env.example section with environment variable placeholders"
  artifacts:
    - path: "src/wxcode/services/schema_extractor.py"
      provides: "extract_connections_for_project() function"
      exports: ["extract_connections_for_project"]
    - path: "src/wxcode/services/prompt_builder.py"
      provides: "format_connections(), format_env_example(), updated template"
      min_lines: 250
    - path: "src/wxcode/api/output_projects.py"
      provides: "Connection extraction and passing to PromptBuilder"
  key_links:
    - from: "src/wxcode/api/output_projects.py"
      to: "src/wxcode/services/schema_extractor.py"
      via: "import and call extract_connections_for_project()"
      pattern: "extract_connections_for_project"
    - from: "src/wxcode/api/output_projects.py"
      to: "src/wxcode/services/prompt_builder.py"
      via: "pass connections to write_context_file()"
      pattern: "connections=connections"
    - from: "src/wxcode/services/prompt_builder.py"
      to: "PROMPT_TEMPLATE"
      via: "format_connections and format_env_example in template"
      pattern: "database_connections|env_example"
---

<objective>
Add database connection information to CONTEXT.md generated by PromptBuilder.

Purpose: Converted starter projects need database connection context (hosts, ports, drivers) to properly scaffold database configuration files and environment variables.

Output:
- `extract_connections_for_project()` function in schema_extractor.py
- `format_connections()` and `format_env_example()` methods in PromptBuilder
- Extended PROMPT_TEMPLATE with Database Connections and .env.example sections
- Updated API to extract and pass connections to PromptBuilder
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-connection-extraction/19-RESEARCH.md

# Source files being modified
@src/wxcode/services/schema_extractor.py
@src/wxcode/services/prompt_builder.py
@src/wxcode/api/output_projects.py
@src/wxcode/models/schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection extraction and PromptBuilder extensions</name>
  <files>
    src/wxcode/services/schema_extractor.py
    src/wxcode/services/prompt_builder.py
  </files>
  <action>
  **schema_extractor.py** - Add new function at end of file:

  ```python
  async def extract_connections_for_project(
      project_id: PydanticObjectId,
  ) -> list:
      """
      Extrai todas as conexoes do schema do projeto.

      Diferente de tabelas (que podem ser filtradas por Configuration),
      conexoes sao configuracoes de projeto inteiro. Retorna todas as
      conexoes definidas no arquivo .xdd da Analysis.

      Args:
          project_id: ID do Knowledge Base (Project)

      Returns:
          Lista de SchemaConnection objects (pode ser vazia se nao houver schema)
      """
      schema = await DatabaseSchema.find_one(
          DatabaseSchema.project_id == project_id
      )
      if not schema:
          return []
      return schema.connections or []
  ```

  **prompt_builder.py** - Three changes:

  1. Add `format_connections()` static method after `format_tables()`:
  ```python
  @staticmethod
  def format_connections(connections: list) -> str:
      """
      Formata conexoes como tabela markdown.

      Args:
          connections: Lista de SchemaConnection objects

      Returns:
          String markdown formatada
      """
      if not connections:
          return "*No external database connections defined.*"

      lines = []
      lines.append("| Connection | Host | Port | Database | Driver |")
      lines.append("|------------|------|------|----------|--------|")

      for conn in connections:
          host = getattr(conn, 'source', '') or '*local*'
          port = getattr(conn, 'port', '') or '*default*'
          database = getattr(conn, 'database', '') or '*n/a*'
          driver = getattr(conn, 'driver_name', '') or 'Unknown'
          name = getattr(conn, 'name', 'Unknown')

          lines.append(f"| {name} | {host} | {port} | {database} | {driver} |")

      return "\n".join(lines)
  ```

  2. Add `format_env_example()` static method after `format_connections()`:
  ```python
  @staticmethod
  def format_env_example(connections: list, project_name: str) -> str:
      """
      Gera conteudo .env.example para CONTEXT.md.

      Args:
          connections: Lista de SchemaConnection objects
          project_name: Nome do projeto para comentario

      Returns:
          String com bloco de codigo bash formatado
      """
      if not connections:
          return "```bash\n# No database connections - using default settings\nDATABASE_URL=\n```"

      lines = ["```bash", f"# Environment variables for {project_name}", ""]

      for conn in connections:
          conn_name = getattr(conn, 'name', 'CONNECTION')
          conn_var = conn_name.upper()
          driver = getattr(conn, 'driver_name', 'Unknown')
          port = getattr(conn, 'port', '')

          lines.append(f"# {conn_name} ({driver})")
          lines.append(f"{conn_var}_HOST=")
          lines.append(f"{conn_var}_PORT={port}")
          lines.append(f"{conn_var}_DATABASE=")
          lines.append(f"{conn_var}_USER=")
          lines.append(f"{conn_var}_PASSWORD=")
          lines.append("")

      lines.append("```")
      return "\n".join(lines)
  ```

  3. Update `PROMPT_TEMPLATE` - Add two new sections after `## Database Schema` section (before `## Execution Instructions`):

  ```
  ## Database Connections

  {database_connections}

  ## Environment Variables (.env.example)

  {env_example}
  ```

  4. Update `build_context()` signature and implementation:
  - Add parameter: `connections: list = None`
  - Add to format call:
    - `database_connections=cls.format_connections(connections or [])`
    - `env_example=cls.format_env_example(connections or [], output_project.name)`

  5. Update `write_context_file()` signature and implementation:
  - Add parameter: `connections: list = None`
  - Pass `connections=connections` to `build_context()`

  **IMPORTANT:**
  - Never include `extended_info` field (may contain passwords)
  - Use `getattr()` for safety when accessing connection attributes
  - Empty connections list should show informative message, not error
  </action>
  <verify>
  ```bash
  cd /Users/gilberto/projetos/wxk/wxcode
  python -c "from wxcode.services.schema_extractor import extract_connections_for_project; print('Import OK')"
  python -c "from wxcode.services.prompt_builder import PromptBuilder; print(hasattr(PromptBuilder, 'format_connections'), hasattr(PromptBuilder, 'format_env_example'))"
  grep -q "database_connections" src/wxcode/services/prompt_builder.py && echo "Template updated"
  ```
  </verify>
  <done>
  - extract_connections_for_project() function exists and imports successfully
  - PromptBuilder has format_connections() and format_env_example() static methods
  - PROMPT_TEMPLATE includes {database_connections} and {env_example} placeholders
  - build_context() and write_context_file() accept connections parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire API to extract and pass connections</name>
  <files>src/wxcode/api/output_projects.py</files>
  <action>
  Update the API to use the new extraction function:

  1. Update import at top of file:
  ```python
  from wxcode.services.schema_extractor import (
      extract_schema_for_configuration,
      extract_connections_for_project,
  )
  ```

  2. In `initialize_output_project()` WebSocket handler, after table extraction (line ~336), add:
  ```python
  # Extrair conexoes do projeto
  connections = await extract_connections_for_project(output_project.kb_id)

  await websocket.send_json({
      "type": "info",
      "message": f"Conexoes extraidas: {len(connections)} conexao(es) encontrada(s)"
  })
  ```

  3. Update the `PromptBuilder.write_context_file()` call (around line ~344) to pass connections:
  ```python
  context_path = PromptBuilder.write_context_file(
      output_project=output_project,
      stack=stack,
      tables=tables,
      connections=connections,
      workspace_path=workspace_path,
  )
  ```
  </action>
  <verify>
  ```bash
  cd /Users/gilberto/projetos/wxk/wxcode
  python -c "from wxcode.api.output_projects import router; print('API imports OK')"
  grep -q "extract_connections_for_project" src/wxcode/api/output_projects.py && echo "Import added"
  grep -q "connections=connections" src/wxcode/api/output_projects.py && echo "Passing connections"
  ```
  </verify>
  <done>
  - API imports extract_connections_for_project from schema_extractor
  - initialize_output_project() calls extract_connections_for_project()
  - Connections are passed to PromptBuilder.write_context_file()
  - WebSocket sends info message with connection count
  </done>
</task>

</tasks>

<verification>
Run full verification after both tasks:

```bash
cd /Users/gilberto/projetos/wxk/wxcode

# 1. Verify imports work
python -c "
from wxcode.services.schema_extractor import extract_connections_for_project
from wxcode.services.prompt_builder import PromptBuilder
from wxcode.api.output_projects import router
print('All imports OK')
"

# 2. Verify template has new sections
grep -q "Database Connections" src/wxcode/services/prompt_builder.py && echo "CONN section OK"
grep -q "env_example" src/wxcode/services/prompt_builder.py && echo "ENV section OK"

# 3. Verify API wiring
grep -q "connections=connections" src/wxcode/api/output_projects.py && echo "API wiring OK"

# 4. Run existing tests (should still pass)
pytest tests/test_prompt_builder.py -v 2>/dev/null || echo "No existing tests for prompt_builder"
```
</verification>

<success_criteria>
All requirements covered:

| Requirement | Verification |
|-------------|--------------|
| CONN-01: Extract from schemas.connections[] | extract_connections_for_project() queries DatabaseSchema.connections |
| CONN-02: Table with host/port/database/driver | format_connections() creates markdown table with these columns |
| CONN-02: No passwords | Only name, source, port, database, driver_name accessed; extended_info never used |
| CONN-03: .env.example section | format_env_example() generates bash code block with placeholders |
</success_criteria>

<output>
After completion, create `.planning/phases/19-connection-extraction/19-01-SUMMARY.md`
</output>
