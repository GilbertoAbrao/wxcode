# Phase 19: Connection Extraction - Research

**Researched:** 2026-01-24
**Domain:** PromptBuilder CONTEXT.md generation with database connection information
**Confidence:** HIGH

## Summary

This phase adds database connection information to the CONTEXT.md file generated by PromptBuilder. The infrastructure for connection extraction already exists and is fully functional:

1. **XDD Parser** (`xdd_parser.py`) already extracts connections from .xdd files with full metadata: name, host, port, database, user, driver type
2. **DatabaseSchema model** (`models/schema.py`) stores `connections: list[SchemaConnection]` alongside tables
3. **Starter kit generator** (`generator/starter_kit.py`) already uses connections to generate `.env.example` with environment variables

The missing piece is the **PromptBuilder** which currently only includes tables in CONTEXT.md but ignores the connections data that's already available.

**Primary recommendation:** Extend `PromptBuilder.build_context()` to accept connections list and add two new sections to the template: a connection table and an `.env.example` block.

## Current State Analysis

### What Already Works (HIGH confidence)

| Component | File | Status |
|-----------|------|--------|
| Connection parsing from .xdd | `parser/xdd_parser.py` | Complete - extracts SchemaConnection objects |
| Connection storage in MongoDB | `models/schema.py` | Complete - `DatabaseSchema.connections` field |
| Connection type mapping | `xdd_parser.py` lines 44-53 | Complete - SQL Server, MySQL, PostgreSQL, Oracle, HyperFile, ODBC |
| Port extraction | `xdd_parser.py` lines 295-321 | Complete - from INFOS_ETENDUES or defaults |
| Env var generation | `generator/starter_kit.py` lines 1128-1150 | Complete - generates per-connection vars |

### What's Missing

| Gap | Description |
|-----|-------------|
| Connection table in CONTEXT.md | `PromptBuilder.build_context()` ignores connections parameter |
| .env.example section in CONTEXT.md | Template doesn't include environment variable placeholders |
| Connection extraction in API | `extract_schema_for_configuration()` returns only tables, not connections |

## Architecture Patterns

### Current PromptBuilder Flow
```
OutputProject API (output_projects.py)
    |
    v
extract_schema_for_configuration(project_id, config_id)
    |
    v  (returns list[dict] of tables only)
PromptBuilder.write_context_file(output_project, stack, tables, workspace_path)
    |
    v  (CONTEXT.md with tables but NO connections)
```

### Required Flow
```
OutputProject API (output_projects.py)
    |
    v
extract_schema_for_configuration(project_id, config_id)  # Keep as-is
extract_connections_for_project(project_id)              # NEW function
    |
    v  (tables + connections)
PromptBuilder.write_context_file(output_project, stack, tables, connections, workspace_path)
    |
    v  (CONTEXT.md with tables + connections + .env.example)
```

### Recommended Project Structure Changes

No new files needed. Modifications to existing files:

```
src/wxcode/
├── services/
│   ├── schema_extractor.py    # Add extract_connections_for_project()
│   └── prompt_builder.py      # Extend template and build_context()
└── api/
    └── output_projects.py     # Call both extraction functions
```

## Standard Stack

This phase uses only existing project infrastructure:

| Component | Version | Purpose | Already in Project |
|-----------|---------|---------|-------------------|
| Beanie | 1.x | MongoDB ODM for DatabaseSchema queries | Yes |
| Pydantic | 2.x | SchemaConnection model | Yes |
| Python string formatting | 3.11+ | Template generation | Yes |

No new dependencies required.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Connection filtering for passwords | Custom sanitizer | SchemaConnection model fields | Model already separates safe fields (source, port, database, driver_name) from sensitive ones (extended_info may contain passwords) |
| Connection type to driver name | Lookup function | `SchemaConnection.driver_name` | Already populated by xdd_parser |
| Default ports | Port lookup table | `SchemaConnection.port` | Already resolved by xdd_parser with fallback to defaults |

## Common Pitfalls

### Pitfall 1: Including Sensitive Data in CONTEXT.md
**What goes wrong:** Accidentally including passwords or sensitive extended_info in the output
**Why it happens:** SchemaConnection has `extended_info` field that may contain connection strings with passwords
**How to avoid:** Requirements explicitly list safe fields: host, port, database, user, driver. Never include `extended_info` or any password-like field
**Warning signs:** Any field containing "password", "pwd", "secret", or full connection strings

### Pitfall 2: Empty Connection List Handling
**What goes wrong:** Template breaks or shows empty section when no connections defined
**Why it happens:** Some projects may not have connections (HyperFile Classic uses local files)
**How to avoid:** Check `if connections:` before adding section, or show informative message like "No external database connections defined"
**Warning signs:** Empty tables or sections in generated CONTEXT.md

### Pitfall 3: User Field Privacy Concern
**What goes wrong:** Including production usernames in CONTEXT.md
**Why it happens:** Requirement CONN-02 says "host, port, database, user, driver"
**How to avoid:** User is explicitly in requirements, but the .env.example section should use placeholders like `{CONNECTION_NAME}_USER=` with empty value
**Warning signs:** Real usernames appearing in generated environment variable values

### Pitfall 4: HyperFile Connections
**What goes wrong:** HyperFile Classic (type=5) and HyperFile C/S (type=6) have different connection semantics
**Why it happens:** HyperFile Classic has no network host, just file paths
**How to avoid:** Show connection but indicate driver type. For HyperFile Classic, host/port may be empty - this is expected
**Warning signs:** Empty host/port for type=5 (HyperFile Classic) is NOT an error

## Code Examples

### SchemaConnection Model (existing)
```python
# Source: src/wxcode/models/schema.py lines 14-26
class SchemaConnection(BaseModel):
    """Conexao de banco definida na Analysis."""

    name: str = Field(..., description="Nome da conexao (ex: CNX_BASE_HOMOLOG)")
    type_code: int = Field(..., description="Tipo de conexao (1 = SQL Server)")
    database_type: str = Field("", description="Tipo do banco (sqlserver, mysql, postgresql, etc.)")
    driver_name: str = Field("", description="Nome legivel do driver (SQL Server, MySQL, etc.)")
    source: str = Field("", description="Servidor/host da conexao")
    port: str = Field("", description="Porta da conexao (extraida ou padrao)")
    database: str = Field("", description="Nome do banco de dados")
    user: Optional[str] = Field(None, description="Usuario da conexao")
    extended_info: str = Field("", description="Informacoes estendidas (INFOS_ETENDUES)")  # DO NOT expose
```

### Connection Type Mapping (existing)
```python
# Source: src/wxcode/parser/xdd_parser.py lines 44-53
CONNECTION_TYPE_MAP: dict[int, tuple[str, str, str]] = {
    # Type: (database_type, driver_name, default_port)
    1: ("sqlserver", "SQL Server", "1433"),
    2: ("mysql", "MySQL", "3306"),
    3: ("postgresql", "PostgreSQL", "5432"),
    4: ("oracle", "Oracle", "1521"),
    5: ("hyperfile", "HyperFile Classic", ""),
    6: ("hyperfile_cs", "HyperFile C/S", "4900"),
    7: ("odbc", "ODBC", ""),
}
```

### Pattern: Format Connections as Markdown Table
```python
# Recommended implementation pattern
@staticmethod
def format_connections(connections: list) -> str:
    """Format connections as markdown table."""
    if not connections:
        return "*No external database connections defined.*"

    lines = []
    lines.append("| Connection | Host | Port | Database | Driver |")
    lines.append("|------------|------|------|----------|--------|")

    for conn in connections:
        # Use getattr for safety, filter out sensitive fields
        host = getattr(conn, 'source', '') or '*local*'
        port = getattr(conn, 'port', '') or '*default*'
        database = getattr(conn, 'database', '') or '*n/a*'
        driver = getattr(conn, 'driver_name', '') or 'Unknown'

        lines.append(f"| {conn.name} | {host} | {port} | {database} | {driver} |")

    return "\n".join(lines)
```

### Pattern: Generate .env.example Section
```python
# Recommended implementation pattern (adapted from starter_kit.py lines 1128-1142)
@staticmethod
def format_env_example(connections: list, project_name: str) -> str:
    """Generate .env.example content for CONTEXT.md."""
    if not connections:
        return "```bash\n# No database connections - using default settings\nDATABASE_URL=\n```"

    lines = ["```bash", f"# Environment variables for {project_name}", ""]

    for conn in connections:
        conn_var = conn.name.upper()
        lines.append(f"# {conn.name} ({conn.driver_name})")
        lines.append(f"{conn_var}_HOST=")
        lines.append(f"{conn_var}_PORT={conn.port or ''}")
        lines.append(f"{conn_var}_DATABASE=")
        lines.append(f"{conn_var}_USER=")
        lines.append(f"{conn_var}_PASSWORD=")
        lines.append("")

    lines.append("```")
    return "\n".join(lines)
```

## Implementation Plan

### Task 1: Add connection extraction function
**File:** `src/wxcode/services/schema_extractor.py`

Add new function alongside existing `extract_schema_for_configuration()`:

```python
async def extract_connections_for_project(
    project_id: PydanticObjectId,
) -> list[SchemaConnection]:
    """
    Extract all connections from project schema.

    Unlike tables (which can be scoped to Configuration), connections
    are project-wide settings. Returns all connections defined in the
    Analysis (.xdd) file.
    """
    schema = await DatabaseSchema.find_one(
        DatabaseSchema.project_id == project_id
    )
    if not schema:
        return []
    return schema.connections or []
```

### Task 2: Extend PromptBuilder template and methods
**File:** `src/wxcode/services/prompt_builder.py`

1. Add `format_connections()` static method
2. Add `format_env_example()` static method
3. Extend `PROMPT_TEMPLATE` with two new sections after schema tables
4. Update `build_context()` signature to accept `connections: list`
5. Update `write_context_file()` to accept and pass connections

### Task 3: Update API to extract and pass connections
**File:** `src/wxcode/api/output_projects.py`

1. Import new `extract_connections_for_project` function
2. In `initialize_output_project()` WebSocket handler:
   - Call `extract_connections_for_project()` after table extraction
   - Pass connections to `PromptBuilder.write_context_file()`

## Success Criteria Verification

| Requirement | How to Verify |
|-------------|---------------|
| CONN-01: Extract from schemas.connections[] | PromptBuilder receives connections list from schema_extractor |
| CONN-02: Table with host/port/database/user/driver | Generated CONTEXT.md contains markdown table with these columns |
| CONN-02: No passwords | Neither `extended_info` nor any password field appears in output |
| CONN-03: .env.example section | Generated CONTEXT.md contains fenced code block with env vars |

## Open Questions

None. The implementation path is clear and all infrastructure exists.

## Sources

### Primary (HIGH confidence)
- `src/wxcode/models/schema.py` - SchemaConnection model definition
- `src/wxcode/parser/xdd_parser.py` - Connection parsing logic
- `src/wxcode/services/prompt_builder.py` - Current PromptBuilder implementation
- `src/wxcode/services/schema_extractor.py` - Current extraction logic
- `src/wxcode/generator/starter_kit.py` - Reference for .env.example generation
- `tests/test_xdd_parser.py` - Test fixtures showing connection structure

### Secondary (MEDIUM confidence)
- `project-refs/Linkpay_ADM/BD.ana/BD.xdd` - Real-world connection examples (CNX_BASE_HOMOLOG, BdInfiniti)

## Metadata

**Confidence breakdown:**
- Current state analysis: HIGH - direct code inspection
- Implementation plan: HIGH - straightforward extension of existing patterns
- Edge cases: HIGH - covered by existing tests and real data

**Research date:** 2026-01-24
**Valid until:** 60 days (stable internal API, no external dependencies)
