---
phase: 27-testing-and-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/__init__.py
  - tests/integration/test_terminal_websocket.py
autonomous: true

must_haves:
  truths:
    - "WebSocket terminal endpoint accepts connection"
    - "WebSocket returns error for invalid milestone"
    - "WebSocket sends status message on connect"
    - "Concurrent input/output does not deadlock"
    - "Rapid inputs are processed correctly"
    - "Session persists across simulated disconnect"
  artifacts:
    - path: "tests/integration/__init__.py"
      provides: "Package marker for integration tests"
      min_lines: 1
    - path: "tests/integration/test_terminal_websocket.py"
      provides: "Integration tests for terminal WebSocket"
      min_lines: 200
  key_links:
    - from: "tests/integration/test_terminal_websocket.py"
      to: "wxcode.api.milestones"
      via: "FastAPI TestClient"
      pattern: "TestClient|websocket_connect"
---

<objective>
Create integration tests for the terminal WebSocket endpoint and concurrent I/O stress tests.

Purpose: Verify the full WebSocket terminal flow works correctly end-to-end and does not deadlock under load.

Output: Integration test file with endpoint tests and concurrent operation stress tests.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-testing-and-polish/27-RESEARCH.md
@src/wxcode/api/milestones.py
@src/wxcode/services/terminal_handler.py
@src/wxcode/services/pty_session_manager.py
@tests/test_bidirectional_pty.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test infrastructure</name>
  <files>tests/integration/__init__.py</files>
  <action>
Create the integration tests package:

1. Create `tests/integration/__init__.py` with:
```python
"""
Integration tests for wxcode.

These tests verify end-to-end flows across multiple components.
"""
```
  </action>
  <verify>
`ls tests/integration/__init__.py` exists
  </verify>
  <done>
Integration test directory created with __init__.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Create terminal WebSocket integration tests</name>
  <files>tests/integration/test_terminal_websocket.py</files>
  <action>
Create integration tests for the terminal WebSocket endpoint.

**IMPORTANT:** These tests use TestClient from FastAPI which does NOT support async websocket operations in the same way as real connections. Use synchronous WebSocket testing patterns.

Test coverage must include:

1. **Endpoint tests (use mock milestone/session):**
   - Connect to /api/milestones/{id}/terminal returns status message
   - Invalid milestone ID returns error and closes with 4000
   - Non-existent milestone returns error and closes with 4004
   - Already finished milestone returns error and closes with 4004

2. **Message flow tests (mock session exists):**
   - Send input message, verify no error returned
   - Send resize message, verify no error returned
   - Send signal message (SIGINT), verify no error returned
   - Send invalid message, verify error message returned
   - Send oversized input, verify error message returned

3. **Reconnection tests:**
   - Connect, disconnect, reconnect - session found
   - Replay buffer sent on reconnection

4. **Concurrent I/O stress tests (use real BidirectionalPTY with `cat`):**
   - Send 50 rapid inputs, verify no deadlock (10s timeout)
   - Concurrent write during output streaming works

Use these patterns from 27-RESEARCH.md:
- TestClient.websocket_connect() for WebSocket tests
- asyncio.wait_for with timeout for stress tests
- Mock PTYSessionManager for session lookup tests
- reset_session_manager() in teardown to clean state

Fixtures needed:
- mock_milestone: Creates a test milestone in DB
- mock_session: Creates a mock PTY session
- cleanup: Resets session manager after each test

Note: For tests requiring real PTY, use simple commands like `cat` or `echo` not Claude Code.
  </action>
  <verify>
Run: `pytest tests/integration/test_terminal_websocket.py -v`
All tests pass.
  </verify>
  <done>
At least 12 integration tests covering endpoint behavior, message flow, and concurrent operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add concurrent I/O stress test to BidirectionalPTY tests</name>
  <files>tests/test_bidirectional_pty.py</files>
  <action>
Add stress tests to existing test_bidirectional_pty.py to verify concurrent read/write does not deadlock.

Add these test cases to TestBidirectionalPTY class:

1. **test_concurrent_read_write_no_deadlock:**
   - Start PTY with `cat` command
   - Spawn writer task: send 50 messages with 10ms delay
   - Spawn reader task: collect output until writer done
   - Use asyncio.wait_for with 10s timeout
   - Assert no TimeoutError (would indicate deadlock)
   - Assert messages were sent and output received

2. **test_rapid_inputs_processed:**
   - Start PTY with `cat` command
   - Send 100 short messages in rapid succession (no delay)
   - Collect all output
   - Assert all messages echoed back

3. **test_resize_during_output:**
   - Start PTY with command that produces continuous output (e.g., `for i in 1..5; echo line$i; sleep 0.1`)
   - Resize terminal while output streaming
   - Assert resize completes without error
   - Assert output still received after resize

Follow patterns from 27-RESEARCH.md concurrent testing section.
  </action>
  <verify>
Run: `pytest tests/test_bidirectional_pty.py -v -k "concurrent or rapid or resize_during"`
All new tests pass.
  </verify>
  <done>
3 new stress tests added to test_bidirectional_pty.py covering concurrent I/O scenarios.
  </done>
</task>

</tasks>

<verification>
Run all related tests:
```bash
pytest tests/integration/ tests/test_bidirectional_pty.py -v --tb=short
```

All tests pass within reasonable time (no hangs/deadlocks).
</verification>

<success_criteria>
- tests/integration/ directory created
- test_terminal_websocket.py has 12+ integration tests
- test_bidirectional_pty.py has 3 new stress tests
- No tests hang or deadlock (all complete within 30s)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-testing-and-polish/27-02-SUMMARY.md`
</output>
