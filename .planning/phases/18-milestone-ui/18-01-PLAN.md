---
phase: 18-milestone-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/services/milestone_prompt_builder.py
  - src/wxcode/api/milestones.py
  - src/wxcode/api/__init__.py
  - src/wxcode/main.py
autonomous: true

must_haves:
  truths:
    - "API can create milestone for element"
    - "API can list milestones by output project"
    - "WebSocket endpoint streams GSD output"
  artifacts:
    - path: "src/wxcode/services/milestone_prompt_builder.py"
      provides: "MILESTONE-CONTEXT.md generation"
      exports: ["MilestonePromptBuilder"]
    - path: "src/wxcode/api/milestones.py"
      provides: "Milestone CRUD and WebSocket initialization"
      exports: ["router"]
  key_links:
    - from: "src/wxcode/api/milestones.py"
      to: "GSDContextCollector"
      via: "import and instantiation"
      pattern: "GSDContextCollector"
    - from: "src/wxcode/api/milestones.py"
      to: "GSDInvoker"
      via: "import and invoke_with_streaming"
      pattern: "invoke_with_streaming"
---

<objective>
Backend infrastructure for Milestone CRUD and GSD initialization

Purpose: Enable creating milestones from KB elements and triggering element-specific GSD workflows with WebSocket streaming output.

Output:
- MilestonePromptBuilder service for generating element-specific CONTEXT.md
- Milestone REST API (CRUD endpoints)
- WebSocket endpoint for streaming initialization
- Router registration in main.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-milestone-ui/18-RESEARCH.md

# Prior phase patterns
@src/wxcode/api/output_projects.py
@src/wxcode/services/gsd_invoker.py
@src/wxcode/services/gsd_context_collector.py
@src/wxcode/models/milestone.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MilestonePromptBuilder service</name>
  <files>src/wxcode/services/milestone_prompt_builder.py</files>
  <action>
Create a new service that builds MILESTONE-CONTEXT.md for element conversion.

The service should:
1. Accept GSDContextData, Stack, and OutputProject as inputs
2. Build a prompt template that includes:
   - Element metadata (name, type, layer)
   - Stack characteristics (language, framework, file_structure, type_mappings)
   - Element statistics from GSDContextData.stats
   - Reference to JSON files (element.json, controls.json, dependencies.json)
3. Format dict values as YAML-like strings for readability

Follow the MILESTONE_PROMPT_TEMPLATE pattern from 18-RESEARCH.md.

Key method signature:
```python
@classmethod
def build_context(
    cls,
    gsd_data: GSDContextData,
    stack: Stack,
    output_project: OutputProject,
) -> str:
```

Also add a helper `_format_dict(d: dict, indent: int = 0) -> str` for YAML-like formatting.

The prompt should include:
- LANGUAGE directive (pt-BR)
- Element overview section
- Stack characteristics (file_structure, type_mappings, model_template)
- Instructions for conversion approach
- Files reference table

DO NOT duplicate the full GSDContextWriter - just generate the MILESTONE-CONTEXT.md content.
  </action>
  <verify>
python -c "from wxcode.services.milestone_prompt_builder import MilestonePromptBuilder; print('Import OK')"
  </verify>
  <done>MilestonePromptBuilder class exists with build_context method</done>
</task>

<task type="auto">
  <name>Task 2: Create Milestone API with WebSocket</name>
  <files>src/wxcode/api/milestones.py, src/wxcode/api/__init__.py</files>
  <action>
Create the milestones API router following output_projects.py patterns.

Request/Response models:
- CreateMilestoneRequest: output_project_id (str), element_id (str)
- MilestoneResponse: id, output_project_id, element_id, element_name, status, created_at, completed_at
- MilestoneListResponse: milestones (list), total (int)

REST Endpoints:
1. `POST /` - Create milestone
   - Validate OutputProject exists
   - Validate Element exists
   - Check for duplicate (same output_project_id + element_id)
   - Create Milestone with status PENDING
   - Return MilestoneResponse

2. `GET /` - List milestones
   - Filter by output_project_id (required)
   - Optional status filter
   - Support skip/limit pagination

3. `GET /{id}` - Get single milestone

4. `DELETE /{id}` - Delete milestone (only if PENDING)

WebSocket Endpoint:
5. `@router.websocket("/{id}/initialize")` - Initialize milestone

Initialize flow:
1. Accept WebSocket connection
2. Validate milestone exists and status is PENDING
3. Get OutputProject, Stack, Element
4. Update status to IN_PROGRESS
5. Use GSDContextCollector to collect element context
6. Use GSDContextWriter to write JSON files to milestone workspace
7. Use MilestonePromptBuilder to create MILESTONE-CONTEXT.md
8. Invoke GSD using `/gsd:new-project` command with the MILESTONE-CONTEXT.md file
   - The context file already contains element-specific conversion instructions
   - /gsd:new-project is used because it handles the general GSD workflow
   - The MILESTONE-CONTEXT.md content directs Claude to element-level conversion
9. Update status to COMPLETED or FAILED based on exit code
10. Send complete/error message

Milestone workspace: `{output_project.workspace_path}/.milestones/{milestone_id}/`

Update src/wxcode/api/__init__.py to export milestones module.
  </action>
  <verify>
python -c "from wxcode.api.milestones import router; print('Import OK')"
  </verify>
  <done>Milestones API with CRUD and WebSocket initialization endpoint</done>
</task>

<task type="auto">
  <name>Task 3: Register milestones router in main.py</name>
  <files>src/wxcode/main.py</files>
  <action>
Add milestones router to main.py:

1. Add import: `from wxcode.api import milestones` (at end of existing api imports line)

2. Add router registration after output_projects:
```python
app.include_router(milestones.router, prefix="/api/milestones", tags=["Milestones"])
```

Follow the exact pattern used for output_projects.
  </action>
  <verify>
cd /Users/gilberto/projetos/wxk/wxcode && python -c "from wxcode.main import app; routes = [r.path for r in app.routes]; assert '/api/milestones/' in routes or any('/api/milestones' in r for r in routes), f'Missing milestones route. Routes: {routes}'"
  </verify>
  <done>Milestones router registered at /api/milestones</done>
</task>

</tasks>

<verification>
1. Start the API server: `cd /Users/gilberto/projetos/wxk/wxcode && python -m wxcode.main`
2. Check /docs endpoint shows Milestones tag with endpoints
3. Test create milestone via curl:
   ```bash
   curl -X POST http://localhost:8052/api/milestones \
     -H "Content-Type: application/json" \
     -d '{"output_project_id": "...", "element_id": "..."}'
   ```
</verification>

<success_criteria>
- MilestonePromptBuilder builds valid CONTEXT.md content
- POST /api/milestones creates milestone
- GET /api/milestones?output_project_id=X returns milestones
- WebSocket /api/milestones/{id}/initialize exists (full flow tested in later plan)
- All imports resolve without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-milestone-ui/18-01-SUMMARY.md`
</output>
