---
phase: 18-milestone-ui
plan: 04
type: execute
wave: 4
depends_on: ["18-02", "18-03"]
files_modified:
  - frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can see milestones section on output project page"
    - "User can create milestone via modal"
    - "User can initialize milestone and see progress"
    - "Milestone list updates after creation/initialization"
  artifacts:
    - path: "frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx"
      provides: "Output project detail page with milestones"
  key_links:
    - from: "frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx"
      to: "useMilestones hook"
      via: "import and query"
      pattern: "useMilestones"
    - from: "frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx"
      to: "MilestoneList component"
      via: "import and render"
      pattern: "MilestoneList"
    - from: "frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx"
      to: "CreateMilestoneModal component"
      via: "import and render"
      pattern: "CreateMilestoneModal"
    - from: "frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx"
      to: "useInitializeMilestone hook"
      via: "import and call"
      pattern: "useInitializeMilestone"
---

<objective>
Integrate milestone components into output project detail page

Purpose: Enable users to view, create, and initialize milestones directly from the output project detail page.

Output:
- Milestones section added to output project detail page
- Create milestone button and modal
- Initialize functionality with progress display
- Full end-to-end milestone workflow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-milestone-ui/18-RESEARCH.md
@.planning/phases/18-milestone-ui/18-01-SUMMARY.md
@.planning/phases/18-milestone-ui/18-02-SUMMARY.md
@.planning/phases/18-milestone-ui/18-03-SUMMARY.md

# Existing page to modify - READ THIS FIRST to understand current structure
@frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add milestones section to output project page</name>
  <files>frontend/src/app/project/[id]/output-projects/[projectId]/page.tsx</files>
  <action>
**IMPORTANT:** First read the existing page.tsx to understand its current structure, then enhance it with a milestones section.

Add imports at the top (after existing imports):
```typescript
import { useMilestones, useCreateMilestone, useInitializeMilestone } from "@/hooks/useMilestones";
import {
  MilestoneList,
  CreateMilestoneModal,
  MilestoneProgress
} from "@/components/milestone";
import { Plus } from "lucide-react";
```

Add state variables inside the component (after existing state declarations):
```typescript
const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
const [activeMilestoneId, setActiveMilestoneId] = useState<string | null>(null);
```

Add hooks (after existing hooks):
```typescript
const { data: milestonesData } = useMilestones(projectId);
const {
  initialize: initializeMilestone,
  isInitializing,
  messages,
  error: initError,
  isComplete
} = useInitializeMilestone(activeMilestoneId || "");
```

Find the main content section (typically after the header/info section showing project name, stack, status). Add the milestones section BEFORE the closing of the main container div:

```tsx
{/* Milestones Section */}
<div className="mt-8">
  <div className="flex items-center justify-between mb-4">
    <h2 className="text-lg font-semibold">Milestones</h2>
    <Button
      onClick={() => setIsCreateModalOpen(true)}
      variant="outline"
      size="sm"
      className="gap-2"
    >
      <Plus className="w-4 h-4" />
      Add Milestone
    </Button>
  </div>

  {/* Show progress if initializing */}
  {activeMilestoneId && isInitializing && (
    <div className="mb-4">
      <MilestoneProgress
        messages={messages}
        isComplete={isComplete}
        error={initError}
        milestoneName={
          milestonesData?.milestones.find(m => m.id === activeMilestoneId)?.element_name || "Milestone"
        }
      />
    </div>
  )}

  <MilestoneList
    milestones={milestonesData?.milestones || []}
    onInitialize={(id) => {
      setActiveMilestoneId(id);
      initializeMilestone();
    }}
    initializingId={isInitializing ? activeMilestoneId : null}
    emptyMessage="No milestones yet. Add a milestone to start converting elements."
  />
</div>

{/* Create Milestone Modal */}
<CreateMilestoneModal
  outputProjectId={projectId}
  kbId={project?.kb_id || ""}
  existingMilestoneElementIds={milestonesData?.milestones.map(m => m.element_id) || []}
  isOpen={isCreateModalOpen}
  onClose={() => setIsCreateModalOpen(false)}
  onCreated={() => {
    // Modal closes automatically, list refreshes via query invalidation
  }}
/>
```

Handle the initialize flow:
- When user clicks Initialize on a milestone, set activeMilestoneId and call initializeMilestone()
- Show MilestoneProgress panel while initializing
- Clear activeMilestoneId and hide progress when complete

Note: The useInitializeMilestone hook needs to be called with a valid ID. If activeMilestoneId is null, pass empty string but the hook should be disabled in that case.

Add conditional for the progress display: only show when activeMilestoneId is set AND (isInitializing OR has messages).
  </action>
  <verify>
cd /Users/gilberto/projetos/wxk/wxcode/frontend && npx tsc --noEmit src/app/project/[id]/output-projects/[projectId]/page.tsx 2>&1 | head -15 || echo "TypeScript check complete"
  </verify>
  <done>Milestones section integrated into output project page</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete milestone workflow:
1. Backend API for milestone CRUD and WebSocket initialization
2. Frontend hooks for fetching, creating, and initializing milestones
3. UI components: MilestoneCard, MilestoneList, CreateMilestoneModal, MilestoneProgress
4. Integration into output project detail page
  </what-built>
  <how-to-verify>
1. Start backend: `cd /Users/gilberto/projetos/wxk/wxcode && python -m wxcode.main`
2. Start frontend: `cd /Users/gilberto/projetos/wxk/wxcode/frontend && npm run dev`
3. Navigate to an existing output project (or create one)
4. Click "Add Milestone" button
5. Search for an element, select it, click "Create Milestone"
6. Verify milestone appears in list with "pending" status
7. Click "Initialize" on the milestone
8. Verify:
   - Status changes to "in_progress" with spinning indicator
   - Progress panel shows streaming output
   - After completion, status updates to "completed" or "failed"
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Full TypeScript check: `cd frontend && npx tsc --noEmit`
2. ESLint check: `cd frontend && npm run lint`
3. Backend health: `curl http://localhost:8052/health`
4. API docs: http://localhost:8052/docs (should show Milestones endpoints)
5. Frontend runs: http://localhost:3052
</verification>

<success_criteria>
- Output project page shows milestones section
- User can create milestone via modal
- User can initialize milestone and see streaming progress
- Status updates correctly through the workflow
- No TypeScript or ESLint errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-milestone-ui/18-04-SUMMARY.md`
</output>
