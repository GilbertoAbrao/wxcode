---
phase: 18-milestone-ui
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - frontend/src/hooks/useMilestones.ts
  - frontend/src/components/milestone/CreateMilestoneModal.tsx
  - frontend/src/components/milestone/MilestoneProgress.tsx
  - frontend/src/components/milestone/index.ts
autonomous: true

must_haves:
  truths:
    - "User can select element and create milestone"
    - "User can see streaming output during initialization"
    - "Modal filters out elements that already have milestones"
  artifacts:
    - path: "frontend/src/components/milestone/CreateMilestoneModal.tsx"
      provides: "Modal for creating milestone from element"
      exports: ["CreateMilestoneModal"]
    - path: "frontend/src/components/milestone/MilestoneProgress.tsx"
      provides: "Streaming progress display"
      exports: ["MilestoneProgress"]
  key_links:
    - from: "frontend/src/hooks/useMilestones.ts"
      to: "WebSocket /api/milestones/{id}/initialize"
      via: "useInitializeMilestone hook"
      pattern: "WebSocket.*milestones.*initialize"
    - from: "frontend/src/components/milestone/CreateMilestoneModal.tsx"
      to: "useCreateMilestone"
      via: "hook import and mutation call"
      pattern: "useCreateMilestone"

# Phase 18 Scope Note:
# Dependency preview in modal is OUT OF SCOPE for this phase.
# Element selection shows element name, type, and dependency count only.
# Full dependency graph visualization is deferred to a future enhancement.
---

<objective>
Milestone creation modal and streaming progress components

Purpose: Enable users to create milestones by selecting KB elements, and view real-time streaming output during GSD initialization.

Output:
- useInitializeMilestone hook with WebSocket streaming
- CreateMilestoneModal for element selection
- MilestoneProgress for streaming output display
- Updated exports

**Scope note:** Element selection displays basic info (name, type, dependency count). Dependency preview/graph is out of scope for Phase 18.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/18-milestone-ui/18-RESEARCH.md
@.planning/phases/18-milestone-ui/18-01-SUMMARY.md
@.planning/phases/18-milestone-ui/18-02-SUMMARY.md

# Pattern references
@frontend/src/hooks/useOutputProjects.ts
@frontend/src/components/output-project/CreateProjectModal.tsx
@frontend/src/components/output-project/InitializeProgress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add useInitializeMilestone hook</name>
  <files>frontend/src/hooks/useMilestones.ts</files>
  <action>
Add useInitializeMilestone hook to useMilestones.ts following the exact pattern from useInitializeProject in useOutputProjects.ts.

The hook should:
1. Accept milestoneId: string parameter
2. Maintain state: isInitializing, messages, error, isComplete
3. Use useRef for WebSocket connection
4. Implement initialize() callback that:
   - Resets state
   - Builds WebSocket URL: `${wsUrl}/api/milestones/${milestoneId}/initialize`
   - Connects directly to backend (not via Next.js proxy)
   - Handles onmessage, onerror, onclose events
   - On "complete" message: setIsComplete(true), invalidate queries
   - On "error" message: setError(msg.message)
5. Implement cancel() callback to close WebSocket
6. Cleanup on unmount via useEffect

StreamMessage interface (reuse from useOutputProjects or duplicate):
```typescript
interface StreamMessage {
  type: "info" | "log" | "error" | "complete";
  message?: string;
  content?: string;
  level?: string;
  timestamp?: string;
}
```

Return: { initialize, cancel, isInitializing, messages, error, isComplete }

IMPORTANT: WebSocket URL must connect directly to backend using NEXT_PUBLIC_API_URL, replacing http with ws. Next.js API proxy doesn't support WebSocket upgrades.
  </action>
  <verify>
cd /Users/gilberto/projetos/wxk/wxcode/frontend && npx tsc --noEmit src/hooks/useMilestones.ts 2>&1 | head -10 || echo "TypeScript check complete"
  </verify>
  <done>useInitializeMilestone hook with WebSocket streaming support</done>
</task>

<task type="auto">
  <name>Task 2: Create CreateMilestoneModal component</name>
  <files>frontend/src/components/milestone/CreateMilestoneModal.tsx</files>
  <action>
Create CreateMilestoneModal following CreateProjectModal.tsx pattern.

Props interface:
```typescript
interface CreateMilestoneModalProps {
  outputProjectId: string;
  kbId: string;
  existingMilestoneElementIds: string[];  // Element IDs that already have milestones
  isOpen: boolean;
  onClose: () => void;
  onCreated?: (milestone: Milestone) => void;
}
```

Component should:
1. Use Radix Dialog for modal
2. Show search input with Search icon from lucide-react
3. Fetch elements using existing useElementsRaw hook (from @/hooks/useElements)
   - Pass kbId and { limit: 500 }
4. Filter out elements that are in existingMilestoneElementIds
5. Further filter by search query (match source_name or source_type)
6. Show scrollable list (max-h-96) of selectable elements
7. Each element shown as button with:
   - source_name as title
   - source_type and dependencies count as subtitle (basic info only, no dependency preview)
   - Selected state with blue border
8. Create milestone on submit using useCreateMilestone
9. Reset state on open (use key-based remounting pattern)

Element selection UI:
- Background: bg-zinc-800 border-zinc-700
- Selected: bg-blue-500/10 border-blue-500
- Hover: hover:border-zinc-600

Header: "Create Milestone" with Milestone icon from lucide-react
Footer: Cancel and "Create Milestone" buttons

Use the same modal styling pattern as CreateProjectModal (zinc-900, border-zinc-800, etc.)

**Initialization flow:** After milestone is created via useCreateMilestone, the milestone appears in MilestoneList (from 18-02) with "pending" status. The MilestoneList provides an "Initialize" button on each pending milestone card. Clicking that button triggers the useInitializeMilestone hook from the parent page component. This separation ensures clear component responsibilities: modal creates, list displays and triggers initialization.
  </action>
  <verify>
cd /Users/gilberto/projetos/wxk/wxcode/frontend && npx tsc --noEmit src/components/milestone/CreateMilestoneModal.tsx 2>&1 | head -10 || echo "TypeScript check complete"
  </verify>
  <done>CreateMilestoneModal with element search and selection</done>
</task>

<task type="auto">
  <name>Task 3: Create MilestoneProgress and update exports</name>
  <files>frontend/src/components/milestone/MilestoneProgress.tsx, frontend/src/components/milestone/index.ts</files>
  <action>
Create MilestoneProgress component following InitializeProgress.tsx pattern.

Props:
```typescript
interface MilestoneProgressProps {
  messages: StreamMessage[];
  isComplete: boolean;
  error: string | null;
  milestoneName: string;  // For display in header
}
```

Component should:
1. Show header with milestone name and status indicator
2. Display scrollable message list (max-h-96 overflow-y-auto)
3. Each message styled based on type:
   - info/log: text-zinc-300
   - error: text-red-400
   - complete: text-green-400
4. Auto-scroll to bottom when new messages arrive (useEffect with scrollIntoView)
5. Show completion or error banner at bottom

Message rendering:
- Use content || message field
- Show timestamp if available
- Monospace font for log output (font-mono text-sm)

Panel styling: bg-zinc-900 border border-zinc-800 rounded-lg

Update index.ts to export all components:
```typescript
export { MilestoneCard } from "./MilestoneCard";
export { MilestoneList } from "./MilestoneList";
export { CreateMilestoneModal } from "./CreateMilestoneModal";
export { MilestoneProgress } from "./MilestoneProgress";
```
  </action>
  <verify>
cd /Users/gilberto/projetos/wxk/wxcode/frontend && npx tsc --noEmit src/components/milestone/index.ts 2>&1 | head -10 || echo "TypeScript check complete"
  </verify>
  <done>MilestoneProgress component and complete exports</done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `cd frontend && npx tsc --noEmit`
2. Run ESLint: `cd frontend && npm run lint`
3. Verify all imports work from index:
   ```typescript
   import {
     MilestoneCard,
     MilestoneList,
     CreateMilestoneModal,
     MilestoneProgress
   } from "@/components/milestone";
   ```
4. Verify hook exports:
   ```typescript
   import {
     useMilestones,
     useCreateMilestone,
     useInitializeMilestone
   } from "@/hooks/useMilestones";
   ```
</verification>

<success_criteria>
- TypeScript compiles without errors
- CreateMilestoneModal shows element list with search
- CreateMilestoneModal filters out existing milestone elements
- useInitializeMilestone connects via WebSocket and streams messages
- MilestoneProgress displays streaming output with auto-scroll
- All components exportable from index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/18-milestone-ui/18-03-SUMMARY.md`
</output>
