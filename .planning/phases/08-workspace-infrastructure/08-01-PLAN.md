---
phase: 08-workspace-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wxcode/models/workspace.py
  - src/wxcode/services/workspace_manager.py
  - src/wxcode/services/__init__.py
  - tests/test_workspace_manager.py
autonomous: true

must_haves:
  truths:
    - "WorkspaceManager.ensure_base_directory() creates ~/.wxcode/workspaces/"
    - "WorkspaceManager.create_workspace() creates {project_name}_{8char_id}/ directory"
    - "Created workspace contains .workspace.json with valid metadata"
    - "WorkspaceManager.ensure_product_directory() creates product subdirectories"
    - "All operations are cross-platform (Windows, macOS, Linux)"
  artifacts:
    - path: "src/wxcode/models/workspace.py"
      provides: "WorkspaceMetadata Pydantic model"
      exports: ["WorkspaceMetadata", "PRODUCT_TYPES"]
    - path: "src/wxcode/services/workspace_manager.py"
      provides: "Workspace directory operations"
      exports: ["WorkspaceManager"]
    - path: "tests/test_workspace_manager.py"
      provides: "Unit tests for workspace operations"
      min_lines: 60
  key_links:
    - from: "src/wxcode/services/workspace_manager.py"
      to: "src/wxcode/models/workspace.py"
      via: "import WorkspaceMetadata"
      pattern: "from wxcode\\.models\\.workspace import"
    - from: "src/wxcode/services/workspace_manager.py"
      to: "~/.wxcode/workspaces/"
      via: "Path.home() / '.wxcode' / 'workspaces'"
      pattern: "Path\\.home\\(\\)"
    - from: "src/wxcode/services/__init__.py"
      to: "src/wxcode/services/workspace_manager.py"
      via: "export WorkspaceManager"
      pattern: "from wxcode\\.services\\.workspace_manager import"
---

<objective>
Create workspace infrastructure for isolated project workspaces.

Purpose: Enable each imported project to have its own isolated workspace at `~/.wxcode/workspaces/{project_name}_{id}/` with metadata and product subdirectories. This is the foundation for Phase 9's import flow integration.

Output: WorkspaceManager service, WorkspaceMetadata model, and tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workspace-infrastructure/08-RESEARCH.md
@src/wxcode/services/project_service.py
@src/wxcode/services/__init__.py
@src/wxcode/models/__init__.py
@src/wxcode/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkspaceMetadata model</name>
  <files>src/wxcode/models/workspace.py</files>
  <action>
Create Pydantic model for workspace metadata stored in `.workspace.json`.

Follow existing model patterns from `src/wxcode/models/`:
- Use `pydantic.BaseModel` (not Beanie Document - this is filesystem, not MongoDB)
- Include docstrings in Portuguese (project convention)

Model fields:
- `workspace_id: str` - 8 hex characters from secrets.token_hex(4)
- `project_name: str` - Original project name (unsanitized)
- `created_at: datetime` - UTC timestamp
- `imported_from: str` - Original source path

Also define constant:
- `PRODUCT_TYPES: list[str] = ["conversion", "api", "mcp", "agents"]`

Add method:
- `model_dump_json(indent=2)` is inherited, no custom needed
  </action>
  <verify>
```bash
python -c "from wxcode.models.workspace import WorkspaceMetadata, PRODUCT_TYPES; print(PRODUCT_TYPES)"
```
Should output: `['conversion', 'api', 'mcp', 'agents']`
  </verify>
  <done>
- WorkspaceMetadata model exists with 4 required fields
- PRODUCT_TYPES constant exported
- Import works from wxcode.models.workspace
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkspaceManager service</name>
  <files>src/wxcode/services/workspace_manager.py</files>
  <action>
Create service class for workspace directory operations.

Follow patterns from research (08-RESEARCH.md) and existing `project_service.py`:
- Use `pathlib.Path` for all paths (never string concatenation)
- Use `secrets.token_hex(4)` for 8-char hex IDs
- Use `Path.home()` for cross-platform home directory
- Docstrings in Portuguese

Class methods (all @classmethod or @staticmethod):

1. `WORKSPACES_BASE: Path` - Class attribute = `Path.home() / ".wxcode" / "workspaces"`

2. `ensure_base_directory() -> Path`:
   - Creates `~/.wxcode/workspaces/` if not exists
   - Uses `mkdir(parents=True, exist_ok=True)`
   - Returns the path

3. `create_workspace(project_name: str, imported_from: str) -> tuple[Path, WorkspaceMetadata]`:
   - Calls `ensure_base_directory()`
   - Generates workspace_id via `secrets.token_hex(4)`
   - Sanitizes project_name: lowercase, replace unsafe chars with `_`, limit to 50 chars
   - Creates directory `{sanitized_name}_{workspace_id}`
   - Creates WorkspaceMetadata and writes to `.workspace.json`
   - Returns tuple of (workspace_path, metadata)

4. `_sanitize_name(name: str) -> str` (private):
   - `re.sub(r'[^a-z0-9_]', '_', name.lower())[:50]`

5. `read_workspace_metadata(workspace_path: Path) -> WorkspaceMetadata | None`:
   - Reads `.workspace.json` if exists
   - Returns None if file not found
   - Uses `WorkspaceMetadata.model_validate_json()`

6. `list_workspaces() -> list[tuple[Path, WorkspaceMetadata]]`:
   - Lists all valid workspaces in WORKSPACES_BASE
   - Skips directories without `.workspace.json`
   - Returns list of (path, metadata) tuples

7. `ensure_product_directory(workspace_path: Path, product_type: str) -> Path`:
   - Validates product_type is in PRODUCT_TYPES
   - Creates subdirectory if not exists
   - Returns the product directory path
   - Raises ValueError for invalid product_type

Error handling:
- Wrap directory creation in try/except
- Log warnings for permission errors
- Use `logging.getLogger(__name__)`
  </action>
  <verify>
```bash
python -c "
from wxcode.services.workspace_manager import WorkspaceManager
from pathlib import Path
# Just verify import and class attribute
print(WorkspaceManager.WORKSPACES_BASE)
print('ensure_base_directory' in dir(WorkspaceManager))
print('create_workspace' in dir(WorkspaceManager))
"
```
Should show path to `~/.wxcode/workspaces` and `True` twice.
  </verify>
  <done>
- WorkspaceManager class exists with 6 public methods
- WORKSPACES_BASE points to ~/.wxcode/workspaces
- All methods are static/classmethod (no instance state)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests and export WorkspaceManager</name>
  <files>
tests/test_workspace_manager.py
src/wxcode/services/__init__.py
  </files>
  <action>
**Part A: Create tests/test_workspace_manager.py**

Use pytest with tmp_path fixture for isolation. Test:

1. `test_ensure_base_directory_creates_path(tmp_path, monkeypatch)`:
   - Monkeypatch `WorkspaceManager.WORKSPACES_BASE` to `tmp_path / "workspaces"`
   - Call `ensure_base_directory()`
   - Assert directory exists

2. `test_create_workspace_creates_directory(tmp_path, monkeypatch)`:
   - Monkeypatch WORKSPACES_BASE
   - Call `create_workspace("Test Project", "/path/to/source.wwp")`
   - Assert workspace directory exists
   - Assert `.workspace.json` exists inside

3. `test_create_workspace_sanitizes_name(tmp_path, monkeypatch)`:
   - Test with "My Project/Test" -> sanitized to "my_project_test"
   - Directory name should be `my_project_test_{8chars}`

4. `test_workspace_metadata_content(tmp_path, monkeypatch)`:
   - Create workspace, read `.workspace.json`
   - Validate all fields present (workspace_id, project_name, created_at, imported_from)
   - workspace_id should be 8 hex chars

5. `test_read_workspace_metadata_returns_none_for_missing`:
   - Call with non-existent path
   - Should return None, not raise

6. `test_list_workspaces_finds_valid(tmp_path, monkeypatch)`:
   - Create 2 workspaces
   - list_workspaces() returns both

7. `test_list_workspaces_skips_invalid(tmp_path, monkeypatch)`:
   - Create 1 workspace + 1 bare directory (no .workspace.json)
   - list_workspaces() returns only valid one

8. `test_ensure_product_directory_creates(tmp_path, monkeypatch)`:
   - Create workspace
   - ensure_product_directory(ws_path, "conversion")
   - Assert `conversion/` exists

9. `test_ensure_product_directory_rejects_invalid`:
   - ensure_product_directory(ws_path, "invalid_type")
   - Should raise ValueError

**Part B: Update src/wxcode/services/__init__.py**

Add import and export for WorkspaceManager:
```python
from wxcode.services.workspace_manager import WorkspaceManager
```
Add "WorkspaceManager" to `__all__` list.
  </action>
  <verify>
```bash
cd /Users/gilberto/projetos/wxk/wxcode && python -m pytest tests/test_workspace_manager.py -v
```
All 9 tests should pass.
  </verify>
  <done>
- 9 tests pass covering all WorkspaceManager methods
- WorkspaceManager exported from wxcode.services
- `from wxcode.services import WorkspaceManager` works
  </done>
</task>

</tasks>

<verification>
1. Import verification:
```bash
python -c "from wxcode.services import WorkspaceManager; print('OK')"
python -c "from wxcode.models.workspace import WorkspaceMetadata, PRODUCT_TYPES; print('OK')"
```

2. Run tests:
```bash
cd /Users/gilberto/projetos/wxk/wxcode && python -m pytest tests/test_workspace_manager.py -v
```

3. Integration smoke test (creates real directory):
```bash
python -c "
from wxcode.services.workspace_manager import WorkspaceManager
from pathlib import Path

# Test real base directory creation
base = WorkspaceManager.ensure_base_directory()
print(f'Base exists: {base.exists()}')
print(f'Base path: {base}')

# Verify it's in user home
assert str(base).startswith(str(Path.home()))
print('Cross-platform path: OK')
"
```
</verification>

<success_criteria>
- [ ] WorkspaceMetadata model created with 4 fields
- [ ] WorkspaceManager service created with 6 methods
- [ ] PRODUCT_TYPES constant defined as ['conversion', 'api', 'mcp', 'agents']
- [ ] All 9 unit tests pass
- [ ] WorkspaceManager exported from wxcode.services
- [ ] ~/.wxcode/workspaces/ created successfully on smoke test
- [ ] Cross-platform paths via Path.home() (no hardcoded paths)
</success_criteria>

<output>
After completion, create `.planning/phases/08-workspace-infrastructure/08-01-SUMMARY.md`
</output>
